
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

    <!-- Font Awesome 7 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Flaticon UIcons：动态图标需要 RR + SR 两套 -->
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css"
    />
    <!-- rr -->
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css"
    />
    <!-- sr（底栏“动态”用） -->
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-thin-rounded/css/uicons-thin-rounded.css"
    />
    <!-- tr -->
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-thin-chubby/css/uicons-thin-chubby.css" />
    <!-- tc -->
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-chubby/css/uicons-regular-chubby.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css"
    />
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-straight/css/uicons-regular-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-straight/css/uicons-solid-straight.css'>

    <link id="rmphone-font-link" rel="stylesheet" href="https://fontsapi.zeoseven.com/69/main/result.css">
<style id="rmphone-font-override">:root{ --rmphone-font-family: "Noto Sans CJK"; --rmphone-font-feature: "hwid"; }</style>

    <style>
      /* ===================== 基础变量 ===================== */
      :root {
        --size: 1vh;
        --width: 50vw;
        --aspect-ratio: 37/76;
        --pad: 1.25em;
        --border-radius: 6.666em;
        --gutter: calc(var(--pad) * 2);
        --button-width: 0.333em;
        --notch-height: 3.33em;
        --notch-width: 33.3%;
        --notch-radius: calc(var(--border-radius) - calc(var(--pad) * 2));
        --notch-duration: 0.333s;
        --ease: cubic-bezier(0.666, 0, 0.4, 1);
        --ease-spring: cubic-bezier(0.666, 0, 0.4, 1.2);
        --ease-out: cubic-bezier(0.15, 0, 0.333, 1);
        --border-width: 0.4em;
        --bksx: 284;
        --c-h: var(--bksx);
        --icon-cols: 4;
        --icon-gap: calc(var(--pad) * 0.9);
      }
      @keyframes appear {
        to {
          transform: scale3d(1, 1, 1);
          opacity: 1;
        }
      }
      body {
        background: black;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: var(--rmphone-font-family, "Noto Sans CJK"), system-ui, -apple-system, "Segoe UI", Arial;
        font-size: var(--size);
        box-sizing: border-box;
      }

      /* ===================== 机身外壳 ===================== */
      .RMPhone {
        margin: 1em;
        position: relative;
        z-index: 1;
        aspect-ratio: var(--aspect-ratio);
        background: black;
        width: var(--width);
        border-radius: var(--border-radius);
        box-shadow: 0 0 0.1em 0.25em hsl(var(--c-h), 20%, 25%), 0 0 0 var(--border-width) hsl(var(--c-h), 30%, 85%);
        box-sizing: border-box;
        opacity: 0;
        transform: scale3d(1.1, 1.1, 1);
        animation: appear 1s var(--ease-out) forwards;
        -webkit-backface-visibility: hidden;
      }
      .RMPhone:before {
        content: '';
        position: absolute;
        top: var(--border-radius);
        right: calc(var(--border-width) * -1);
        bottom: var(--border-radius);
        left: calc(var(--border-width) * -1);
        border: 0.5em solid hsl(var(--c-h), 20%, 30%);
        border-left-width: 0;
        border-right-width: 0;
      }
      .RMPhone-side-buttons {
        position: absolute;
        inset: calc(var(--border-width) * -1);
        pointer-events: none;
      }
      .RMPhone-side-buttons .left,
      .RMPhone-side-buttons .right {
        position: absolute;
        width: var(--button-width);
        display: flex;
        flex-direction: column;
        gap: 1.5em;
      }
      .RMPhone-side-buttons .left {
        right: 100%;
        top: calc(var(--border-radius) * 2);
      }
      .RMPhone-side-buttons .left .button:nth-child(1) {
        height: 3em;
        margin-bottom: 0.5em;
      }
      .RMPhone-side-buttons .right {
        left: 100%;
        transform: scale3d(-1, 1, 1);
        top: calc(var(--border-radius) * 3);
      }
      .RMPhone-side-buttons .right .button {
        height: 9.5em;
      }
      .RMPhone-side-buttons .button {
        background: hsl(var(--c-h), 20%, 95%);
        height: 6em;
        box-shadow: inset -0.15em 0 0.1em black, inset 0 0 0.1em hsl(var(--c-h), 30%, 90%),
          inset 0 0.2em 0.1em hsl(var(--c-h), 30%, 90%), inset 0 -0.2em 0.1em hsl(var(--c-h), 30%, 90%),
          inset -0.1em 0.333em 0.1em rgba(0, 0, 0, 0.5), inset -0.1em -0.333em 0.1em rgba(0, 0, 0, 0.5);
        border-top-left-radius: 0.2em;
        border-bottom-left-radius: 0.2em;
      }

      /* ===================== 屏幕容器与壁纸 ===================== */
      .RMPhone-screen-container {
        position: absolute;
        inset: 0;
        border-radius: var(--border-radius);
        border: var(--pad) solid black;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: calc(var(--pad) * 2);
        overflow: hidden;
      }
      .RMPhone-screen-container:before {
        display: none;
      } /* 用真实home条替代伪元素 */
      .RMPhone-bg {
        position: absolute;
        inset: 0;
        background: url('https://i.postimg.cc/05nwGQKJ/dusk-dark-wallpaper.jpg') center/cover no-repeat;
        border-radius: calc(var(--border-radius) - var(--pad));
        overflow: hidden;
        transform: translateZ(0);
      }

      /* ===================== 灵动岛（保留） ===================== */
      .RMPhone .notch-container {
        position: absolute;
        z-index: 11;
        top: var(--pad);
        right: var(--pad);
        left: var(--pad);
        display: flex;
        justify-content: center;
        height: 100%;
        max-height: calc(var(--notch-radius) * 2);
        pointer-events: none;
        outline: none;
        transition: var(--notch-duration) var(--ease);
        transition-property: max-height, max-width, filter, transform;
        will-change: max-width, max-height, filter;
      }
      .RMPhone .is-resizing .notch-container,
      .RMPhone .is-resizing .notch-container * {
        transition: none;
      }
      .RMPhone .notch-container:hover,
      .RMPhone .notch-container:focus-within {
        --shadow-opacity: 0.5;
        transition-timing-function: var(--ease-spring);
      }
      .RMPhone .notch-container:hover .notch-content,
      .RMPhone .notch-container:focus-within .notch-content {
        --content-padding: 2em;
      }
      .RMPhone .notch-container:hover .notch-content .song-info,
      .RMPhone .notch-container:focus-within .notch-content .song-info {
        opacity: 1;
      }
      .RMPhone .notch-container:hover .notch,
      .RMPhone .notch-container:focus-within .notch {
        max-width: 100%;
        max-height: 100%;
        pointer-events: all;
        transform: scale3d(1, 1, 1);
      }
      .RMPhone .notch-container:hover ~ .notch-blur,
      .RMPhone .notch-container:focus-within ~ .notch-blur {
        opacity: 1;
        max-height: calc(var(--notch-radius) * 3.333 + var(--pad));
      }
      .RMPhone .notch-container:focus-within {
        max-height: calc(var(--notch-radius) * 3);
        --bar-height: 1em;
        --bar-opacity: 1;
      }
      .RMPhone .notch-container:focus-within .notch-media,
      .RMPhone .notch-container:focus-within .notch-controls {
        max-height: calc(100% - var(--bar-height, 0%) - var(--content-gap));
      }
      .RMPhone .notch-container:focus-within ~ .notch-blur {
        max-height: calc(var(--notch-radius) * 5);
        opacity: 1;
      }
      .RMPhone .notch-blur {
        position: absolute;
        z-index: 2;
        top: calc(var(--pad) - 3px);
        right: calc(var(--pad) - 3px);
        left: calc(var(--pad) - 3px);
        height: 100%;
        max-height: calc(var(--notch-radius) * 1.5);
        backdrop-filter: blur(0.2em);
        mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 60%, rgba(0, 0, 0, 0) 100%);
        opacity: 0;
        border-radius: calc(var(--border-radius) - var(--pad));
        transition: var(--notch-duration) var(--ease);
        transition-property: max-height, max-width, opacity, transform;
        will-change: max-width, max-height;
        pointer-events: none;
      }
      .RMPhone .notch {
        position: relative;
        border-radius: var(--notch-radius);
        pointer-events: all;
        overflow: hidden;
        color: #fff;
        display: flex;
        cursor: pointer;
        width: 100%;
        transition: inherit;
        filter: drop-shadow(0 1em 2em hsla(0 0% 0% / var(--shadow-opacity, 0)));
        transform: scale3d(0.375, 0.4, 1);
        transform-origin: top;
      }
      .RMPhone .notch:before {
        content: '';
        position: absolute;
        inset: 0;
        background: black;
        filter: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1'><defs><filter id='round'><feGaussianBlur in='SourceGraphic' stdDeviation='5' result='blur' /><feColorMatrix in='blur' mode='matrix' values='1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 19 -9' result='goo'/><feComposite in='SourceGraphic' in2='goo' operator='atop'/></filter></defs></svg>#round");
        border-radius: inherit;
      }
      .RMPhone .notch-content {
        --content-padding: 1.75em;
        --duration-height: 0.5em;
        --content-gap: 1em;
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        align-items: stretch;
        justify-content: stretch;
        padding: var(--content-padding);
        gap: var(--content-gap);
        font-size: 125%;
        transition-property: padding;
        position: relative;
      }
      .RMPhone .notch-content,
      .RMPhone .notch-content .notch-media,
      .RMPhone .notch-content .notch-controls,
      .RMPhone .notch-content .notch-playback-bar,
      .RMPhone .notch-content .song-info {
        transition: var(--notch-duration) var(--ease-out);
      }
      .RMPhone .notch-content .notch-media,
      .RMPhone .notch-content .notch-controls {
        height: 100%;
        max-height: calc(100% - var(--bar-height, 0%));
        display: flex;
        align-items: center;
        gap: 1em;
      }
      .RMPhone .notch-content .notch-media {
        flex-grow: 2;
      }
      .RMPhone .notch-content .song-info {
        display: flex;
        flex-direction: column;
        gap: 0.333em;
        transition-property: opacity;
        opacity: var(--bar-opacity, 0);
      }
      .RMPhone .notch-content .song-info:before {
        content: "Is It Over Now? (Taylor's Version)";
        order: 1;
        text-transform: uppercase;
      }
      .RMPhone .notch-content .song-info:after {
        content: 'Taylor Swift';
        order: 2;
        opacity: 0.5;
      }
      .RMPhone .notch-content .notch-controls {
        flex-grow: 1;
      }
      .RMPhone .notch-content .album-artwork {
        background: url('https://i.postimg.cc/43tkgCJX/image.jpg') center/cover no-repeat;
        height: 100%;
        aspect-ratio: 1;
        border-radius: 20%;
        position: relative;
      }
      .RMPhone .notch-content .notch-playback-bar {
        display: flex;
        align-items: center;
        gap: 1em;
        flex-basis: 100%;
        height: 100%;
        max-height: var(--bar-height, 0%);
        color: rgba(255, 255, 255, 0.5);
        opacity: var(--bar-opacity, 0);
      }
      .RMPhone .notch-content .notch-playback-progress {
        position: relative;
        height: var(--duration-height);
        background: rgba(255, 255, 255, 0.25);
        border-radius: calc(var(--duration-height) * 0.5);
        overflow: hidden;
        flex-grow: 1;
      }
      .RMPhone .notch-content .notch-playback-progress:before {
        content: '';
        height: 100%;
        background: #fff;
        width: 25%;
        position: absolute;
      }
      .RMPhone .notch-content .notch-playback-bar:before {
        content: '0:56';
      }
      .RMPhone .notch-content .notch-playback-bar:after {
        content: '-2:53';
      }

      .RMPhone .camera {
        display: flex;
        justify-content: center;
        align-items: center;
        height: var(--notch-height);
        aspect-ratio: 1/1;
        border-radius: 50%;
        pointer-events: none;
        position: absolute;
        z-index: 12;
        top: calc(var(--pad) * 2);
        right: calc(50% - calc(var(--notch-width) * 0.5));
        margin-right: calc(var(--pad) * 0.333);
      }
      .RMPhone .camera:before {
        content: '';
        height: 33.3%;
        aspect-ratio: 1;
        border-radius: inherit;
        box-shadow: inset 0 0 0.25em #4c4da3;
        background: radial-gradient(#6667ac, transparent 50%) no-repeat 33.3% 10% / 75% 50%,
          radial-gradient(#3c3d8a, transparent 50%) no-repeat 60% 85% / 50% 50%;
        background-color: #080928;
      }

      /* ===================== 桌面分页 ===================== */
      .RMPhone-screen {
        display: flex;
        flex-grow: 1;
        box-sizing: border-box;
        width: 100%;
        position: relative;
        overflow: hidden;
        z-index: 1;
        padding: 0;
        border-radius: calc(var(--border-radius) - var(--pad));
      }
      .RMPhone-pages {
        display: flex;
        width: 100%;
        height: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }
      .RMPhone-page {
        flex: 0 0 100%;
        width: 100%;
        height: 100%;
        scroll-snap-align: start;
        box-sizing: border-box;
        padding: calc(var(--gutter) * 3) var(--gutter) var(--gutter);
        border-radius: calc(var(--border-radius) - var(--pad));
        display: grid;
        grid-template-columns: repeat(var(--icon-cols), minmax(0, 1fr));
        gap: var(--icon-gap);
        align-content: start;
        justify-items: stretch;
      }
      .RMPhone-page-dots {
        position: absolute;
        left: 50%;
        bottom: calc(var(--pad) * 1.2 + 1em);
        transform: translateX(-50%);
        display: flex;
        gap: 1em;
        z-index: 20;
      }
      .RMPhone-page-dots .dot {
        width: 0.5em;
        height: 0.5em;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
        transition: transform 0.2s var(--ease), background-color 0.2s var(--ease);
      }
      .RMPhone-page-dots .dot.active {
        background: #fff;
        transform: scale(1.2);
      }
      .RMPhone-pages::-webkit-scrollbar {
        display: none;
      }

      /* ===================== 图标：按钮版 ===================== */
      button.RMPhone-app {
        border: 0;
        background: transparent;
        padding: 0;
        appearance: none;
        -webkit-appearance: none;
        aspect-ratio: 1;
        border-radius: 30%;
        position: relative;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin: 0;
        box-sizing: border-box;
        user-select: none;
        touch-action: pan-x;
      }
      button.RMPhone-app:active {
        transform: scale(0.96);
      }
      button.RMPhone-app:focus-visible {
        outline: 2px solid rgba(255, 255, 255, 0.7);
        outline-offset: 2px;
      }
      button.RMPhone-app::before {
        content: '';
        background: linear-gradient(190deg, var(--app-bg-s1, #fff), var(--app-bg-s2, var(--app-bg-s1, #fff))) top/100%
          125%;
        border-radius: inherit;
        position: absolute;
        inset: 0;
      }
      .RMPhone-app--grey::before {
        --app-bg-s1: #cecdd5;
        --app-bg-s2: #89888d;
      }
      .RMPhone-app--white::before {
        --app-bg-s1: #f0f0f0;
        --app-bg-s2: #ffffff;
      }
      .RMPhone-app img {
        position: relative;
        z-index: 1;
        width: 80%;
        height: 80%;
        object-fit: contain;
        pointer-events: none;
        user-select: none;
        -webkit-user-drag: none;
      }

      /* ===================== 视口 / 后台 / home条 ===================== */
      .RMPhone-viewport {
        position: absolute;
        inset: 0;
        z-index: 30;
        display: none;
        overflow: hidden;
        border-radius: calc(var(--border-radius) - var(--pad));
      }
      .RMPhone.is-app-open .RMPhone-viewport {
        display: block;
      }

      .RMPhone-switcher {
        position: absolute;
        inset: 0;
        z-index: 35;
        display: none;
        border-radius: calc(var(--border-radius) - var(--pad));
        background: transparent;
        padding: 0;
      }
      .RMPhone-switcher.is-open {
        display: flex;
      }
      .RMPhone-switcher-track {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        overscroll-behavior-x: contain;
        touch-action: pan-x;
      }
      .RMPhone-switcher-track::-webkit-scrollbar {
        width: 0;
        height: 0;
        display: none;
      }

      .RMPhone-switcher-card {
        flex: 0 0 74%;
        height: 74%;
        margin: auto;
        border-radius: 1.4rem;
        background: #fff;
        color: #000;
        box-shadow: 0 0.6rem 1.2rem rgba(0, 0, 0, 0.25);
        scroll-snap-align: center;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translateY(var(--ty, 0)) scale(var(--sc, 0.9));
        transition: transform 0.2s var(--ease), opacity 0.2s var(--ease);
        touch-action: pan-x;
      }
      .RMPhone-switcher-card .title {
        opacity: 0.8;
      }

      .RMPhone-switcher-card .thumb{
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  border-radius: inherit;
  filter: none;
  touch-action: pan-x;
  pointer-events: none;
}
.RMPhone-switcher-card .title{
  position: relative;           /* 让标题在缩略图之上 */
  z-index: 1;
  padding:0 .4rem .4rem;
  border-radius: .6rem;
  font-size: 2em;
  background: rgba(0,0,0,.35);  /* 让文字更清楚，可按需删掉 */
  color: #fff;
  touch-action: pan-x;
  pointer-events: none;
}

      /* 虚化后台：只做一层模糊 */
      .RMPhone.is-switcher-open .RMPhone-screen {
        filter: blur(10px) brightness(0.9);
        transform: scale(0.985);
        transition: filter 0.2s var(--ease), transform 0.2s var(--ease);
        pointer-events: none;
      }

      .RMPhone.is-switcher-open .RMPhone-bg {
        filter: blur(4px) brightness(0.9);
      }
      .RMPhone.is-switcher-open .notch-blur {
        display: none !important;
      }
      .RMPhone.is-switcher-open #page-dots,
      .RMPhone.is-switcher-open .RMPhone-homebar {
        opacity: 0.35;
      }
      .RMPhone.is-switcher-open .RMPhone-viewport {
        display: none !important;
      }

      /* 后台管理器里的一切都不可被选中、图片不可被拖拽 */
      .RMPhone-switcher,
      .RMPhone-switcher * {
        user-select: none;
        -webkit-user-select: none;
      }
      .RMPhone-switcher img {
        -webkit-user-drag: none;
        pointer-events: none; /* 不影响点卡片，点在卡片容器上 */
      }

      .RMPhone-homebar {
        position: absolute;
        z-index: 40;
        left: 50%;
        bottom: calc(var(--pad) * 0.8);
        transform: translateX(-50%);
        width: 36.6%;
        height: calc(var(--pad) * 0.5);
        border-radius: calc(var(--pad) * 0.25);
        background: rgba(255, 255, 255, 0.85);
        touch-action: none;
        will-change: transform;
        transition: transform 0.2s var(--ease);
        user-select: none;
      }
      /* 打开 App 时，保留 home 条手势 */
      .RMPhone.is-app-open .RMPhone-homebar {
        opacity: 0.85;
        pointer-events: auto;
        background: rgba(0, 0, 0, 0.85);
      }

      .RMPhone-switcher-empty {
        margin: auto;
        color: #fff;
        opacity: 0.8;
        font-size: 2.2em;
        user-select: none;
      }

      .RMPhone-screen {
        z-index: 10;
      }
      .RMPhone-viewport {
        z-index: 40;
      }
      .RMPhone-switcher {
        z-index: 60;
      }
      .RMPhone .notch-container {
        z-index: 90;
      }
      .RMPhone .camera {
        z-index: 95;
      }
      .RMPhone-homebar {
        z-index: 100;
      }

      /* 小屏适配 */
      @media (max-width: 480px) {
        .RMPhone {
          width: 95vw;
          height: auto;
        }
      }
    </style>
    <div class="RMPhone" data-initial-index="1">
      <div class="RMPhone-side-buttons">
        <div class="left">
          <div class="button"></div>
          <div class="button"></div>
          <div class="button"></div>
        </div>
        <div class="right"><div class="button"></div></div>
      </div>

      <div class="camera"></div>

      <div class="RMPhone-screen-container">
        <div class="RMPhone-bg"></div>

        <div class="notch-container" tabindex="0">
          <div class="notch">
            <div class="notch-content">
              <div class="notch-media">
                <div class="album-artwork"></div>
                <div class="song-info"></div>
              </div>
              <div class="notch-controls"></div>
              <div class="notch-playback-bar"><div class="notch-playback-progress"></div></div>
            </div>
          </div>
        </div>
        <div class="notch-blur"></div>

        <!-- 桌面分页 -->
        <div class="RMPhone-screen" id="app-container">
          <div class="RMPhone-pages" id="pages">
            <section class="RMPhone-page"></section>

            <section class="RMPhone-page">
              <button class="RMPhone-app RMPhone-app--grey" data-app="settings" aria-label="设置">
                <img src="https://i.postimg.cc/05fCzPV9/R.png" alt="" />
              </button>
              <button class="RMPhone-app RMPhone-app--white" data-app="qq" aria-label="QQ">
                <img
                  src="https://img.icons8.com/external-tal-revivo-color-tal-revivo/96/external-tencent-qq-an-instant-messaging-software-service-and-web-portal-developed-logo-color-tal-revivo.png"
                  alt=""
                />
              </button>
            </section>

            <section class="RMPhone-page">
              <button class="RMPhone-app RMPhone-app--grey" data-app="youtube" aria-label="YouTube">
                <img src="https://img.icons8.com/color/96/youtube-play.png" alt="" />
              </button>
              <button class="RMPhone-app RMPhone-app--white" data-app="discord" aria-label="Discord">
                <img src="https://img.icons8.com/color/96/discord-logo.png" alt="" />
              </button>
            </section>
          </div>
          <div class="RMPhone-page-dots" id="page-dots"></div>
        </div>

        <!-- 视口 / 后台 / home条 -->
        <div class="RMPhone-viewport" id="viewport"></div>
        <div class="RMPhone-switcher" id="switcher"></div>
        <div class="RMPhone-homebar" id="homebar" role="button" aria-label="Home"></div>
      </div>
    </div>
    <!-- ===================== JS：RMPhone 命名空间 ===================== -->
    <script>
      /* 全局命名空间 */
      window.RMPhone = window.RMPhone || { Apps: {} };

/**
 * 模块：RMPhoneToWorldBook
 * 作用：把“世界书（Worldbook）”当成 RMPhone 的“系统设置中心”
 *      - 统一存/取：壁纸、机身比例、边框色（bksx），以及各 App 的自定义配置
 *      - 可选：初始化 QQ 表情仓库、格式说明等辅助条目
 *
 * 公开 API（常用）：
 *   - load(): Promise<{data:{global, apps}}>     读取/合并默认值，返回规范数据
 *   - apply({global}): void                      把 global 应用到页面（CSS 变量/壁纸等）
 *   - getAll(): Promise<{global, apps}>          读全部（只读）
 *   - getApp(appName): Promise<Object>           读某个 App 的配置（只读）
 *   - saveGlobal(patch): Promise<void>           只改 global（自动建条目）
 *   - saveApp(name, patch): Promise<void>        只改某个 App 的配置
 *
 * 公开 API（辅助/管理）：
 *   - ensurePrimary(): Promise<string>           确保主世界书存在并返回名字
 *   - scan(name): Promise<{exists, entries[]}>   扫描某条目是否存在
 *   - writeAll({global, apps}): Promise<void>    一次性写入完整配置（少用）
 *   - ensureQQEmojiStore(opts?): Promise<{created,name}>
 *   - addEmojiToStore(text): Promise<void>       向表情仓库追加一段文本
 *   - ensureFormatSpecEntry(): Promise<void>     建立“格式说明”条目
 *
 * 数据与副作用：
 *   - 读/写世界书条目：主键 'RMPhone手机设置'（根键 'RMPhoneSettingsData'）
 *   - 改动 DOM：更新 :root 的 CSS 变量、.RMPhone-bg 的壁纸样式
 *
 * 与谁联动：
 *   - Settings App：用 saveGlobal/saveApp 实时改外观 & 配置
 *   - QQ 模块：可通过世界书托管表情仓库；与 UI 解耦
 *
 * 典型时序：
 *   waitAPI() → ensurePrimary()/scan() → load() 拿数据 → apply({global}) 生效到页面
 *
 * 注意点：
 *   - 外链壁纸跨域 OK，但截图（html2canvas）可能受 CORS 影响
 *   - 世界书 API 未就绪时会抛错；上层应友好提示
 */
      const RMPhoneToWorldBook = (() => {
  const ENTRY = 'RMPhone手机设置';
  const ORDER = 1213;
  const ROOT_KEY = 'RMPhoneSettingsData';

  // ===== 统一的常量/小工具（用来去重） =====
  const SELECTIVE_EMPTY = {
    type: 'selective',
    keys: [],
    keys_secondary: { logic: 'and_any', keys: [] },
    scan_depth: 1,
  };
  const PROTECT_META = { enabled: false, strategy: SELECTIVE_EMPTY };
  const atDepthPos = (role = 'system', depth = 4, order = ORDER) => ({
    type: 'at_depth',
    role,
    depth,
    order,
  });
  const J = o => JSON.stringify(o, null, 2);
  const P = t => {
    try {
      return JSON.parse(String(t || '').trim());
    } catch {
      return {};
    }
  };

  // 全局三项默认值
  const DEFAULT_GLOBAL = {
    wallpaper: 'https://i.postimg.cc/05nwGQKJ/dusk-dark-wallpaper.jpg',
    aspectRatio: '37/76',
    bksx: 284,
  };

  const needFns = [
    'getCharWorldbookNames',
    'rebindCharWorldbooks',
    'createWorldbook',
    'getWorldbook',
    'createWorldbookEntries',
    'updateWorldbookWith',
  ];

  const waitAPI = async (t = 15000) => {
    const ok = () => needFns.every(k => typeof window[k] === 'function');
    if (ok()) return;
    const s = Date.now();
    while (Date.now() - s < t) {
      await new Promise(r => setTimeout(r, 50));
      if (ok()) return;
    }
    throw new Error('Worldbook API 未就绪');
  };

  // 规范化成 { global:{...}, apps:{...} }
  const normalizeData = raw => {
    const root = (raw && typeof raw === 'object' && (raw[ROOT_KEY] || raw)) || {};
    const global = {
      ...DEFAULT_GLOBAL,
      ...(root.global || (root.wallpaper || root.aspectRatio || root.bksx ? root : {})),
    };
    const apps = root.apps && typeof root.apps === 'object' ? root.apps : {};
    return { global, apps };
  };

  async function ensurePrimary() {
    const bind = getCharWorldbookNames('current');
    if (bind?.primary) return bind.primary;
    const name = `RMPhone@${Date.now()}`;
    await createWorldbook(name, []);
    await rebindCharWorldbooks('current', { primary: name, additional: bind?.additional || [] });
    return name;
  }

  /* ========== 基础：加载（不存在则创建带 ROOT_KEY 的初始结构） ========== */
  async function load() {
    await waitAPI();
    const wb = await ensurePrimary();
    const list = await getWorldbook(wb);
    let entry = list.find(e => e.name === ENTRY);
    if (!entry) {
      const initial = { [ROOT_KEY]: { global: { ...DEFAULT_GLOBAL }, apps: {} } };
      const res = await createWorldbookEntries(
        wb,
        [
          {
            name: ENTRY,
            ...PROTECT_META,
            position: { order: ORDER },
            strategy: SELECTIVE_EMPTY,
            content: J(initial),
          },
        ],
        { render: 'debounced' },
      );
      entry = res.new_entries[0];
    }
    const raw = P(entry.content);
    const data = normalizeData(raw);
    return { wb, data };
  }

  /* ========== 内部：整包写回（覆盖 content） ========== */
  async function writeAll(wb, nextData) {
    const payload = { [ROOT_KEY]: nextData };
    let out = null;
    await updateWorldbookWith(wb, worldbook =>
      worldbook.map(e => {
        if (e.name !== ENTRY) return e;
        out = nextData;
        return {
          ...e,
          ...PROTECT_META,
          position: { ...(e.position || {}), order: ORDER },
          content: J(payload),
        };
      }),
    );
    return out;
  }

  /* ========== 应用到页面：只认 { global } ========== */
  function apply(s) {
    const global = { ...DEFAULT_GLOBAL, ...(s.global || {}) };
    const css = document.documentElement.style;
    css.setProperty('--aspect-ratio', global.aspectRatio);
    css.setProperty('--bksx', String(global.bksx));
    const bg = document.querySelector('.RMPhone-bg');
    if (bg) bg.style.backgroundImage = `url('${global.wallpaper}')`;
    /* 在这里插入 ↓↓↓ */
    if (global.font && (global.font.cssURL || global.font.family)) {
      let link = document.head.querySelector('#rmphone-font-link');
      if (!link) {
        link = document.createElement('link');
        link.id = 'rmphone-font-link';
        link.rel = 'stylesheet';
        document.head.appendChild(link);
      }
      if (global.font.cssURL) link.href = global.font.cssURL;
      document.documentElement.style.setProperty('--rmphone-font-family', global.font.family || 'Noto Sans CJK');
      document.documentElement.style.setProperty('--rmphone-font-feature', global.font.feature || '"hwid"');
    }
  }

  /* ========== 新：扫描 / 只创建 / 读 JSON（适合“只需创建一次，不再修改”的条目） ========== */
  // 仅扫描是否存在该 name 的条目（不创建不修改）
  async function scan(entryName = ENTRY) {
    await waitAPI();
    const wb = await ensurePrimary();
    const list = await getWorldbook(wb);
    const entry = list.find(e => e.name === entryName);
    return { wb, exists: !!entry, entry };
  }

  // 确保存在该条目：不存在则用 initialContent 创建；存在则原样返回（不修改）
  async function ensure(entryName, initialContent = '', { order = ORDER, protect = true } = {}) {
    const { wb, exists, entry } = await scan(entryName);
    if (exists) return { wb, entry };
    const payload = {
      name: entryName,
      position: { order },
      content: typeof initialContent === 'string' ? initialContent : J(initialContent),
      ...(protect ? PROTECT_META : {}),
    };
    const res = await createWorldbookEntries(wb, [payload], { render: 'debounced' });
    return { wb, entry: res.new_entries[0] };
  }

  // 读取某个条目的 content 并尝试解析为 JSON（不存在或解析失败返回 null）
  async function readEntryJSON(entryName) {
    const { entry } = await scan(entryName);
    if (!entry) return null;
    const v = P(entry.content);
    return v && Object.keys(v).length ? v : null;
  }

  /* ========== 分区读写：整包 / 单 App / 只改 global ========== */
  async function getAll() {
    const { data } = await load();
    return data; // { global, apps }
  }

  async function getApp(appName) {
    const { data } = await load();
    return (data.apps && data.apps[appName]) || {};
  }

  async function saveGlobal(patch) {
    const { wb, data } = await load();
    const next = { ...data, global: { ...data.global, ...(patch || {}) } };
    return await writeAll(wb, next);
  }

  async function saveApp(appName, patch) {
    const { wb, data } = await load();
    const nextApps = {
      ...(data.apps || {}),
      [appName]: { ...(data.apps?.[appName] || {}), ...(patch || {}) },
    };
    const next = { ...data, apps: nextApps };
    const saved = await writeAll(wb, next);
    return saved.apps?.[appName] || {};
  }

  // 新增：创建 QQ 群聊条目（RMPhoneQQ群聊.<群名>）
  async function createQQGroupEntry(groupName, contentText) {
    await waitAPI();
    const primary = await ensurePrimary();
    const entry = {
      name: `RMPhoneQQ群聊.${groupName}`,
      enabled: true,
      position: atDepthPos('system', 4, ORDER),
      recursion: { prevent_incoming: true, prevent_outgoing: true },
      strategy: { ...SELECTIVE_EMPTY, keys: ['群聊', String(groupName)] },
      content: String(contentText || ''),
    };
    // 追加条目（不覆盖已有）
    await createWorldbookEntries(primary, [entry], { replace: false });
    return entry.name;
  }

  /* ==== 新增：QQ 表情库（RMPhoneQQ表情存放） ===================================== */
  const EMOJI_ENTRY = 'RMPhoneQQ表情存放';
  const EMOJI_DEFAULT = `这里是聊天可用表情包：
<bqb>
[打坐|https://files.catbox.moe/qzr8yo.jpg]
[楚楚可怜|ls7328.jpg]
</bqb>`;

  async function ensureQQEmojiStore({ content = EMOJI_DEFAULT } = {}) {
    const { exists } = await scan(EMOJI_ENTRY);
    if (exists) return { created: false, name: EMOJI_ENTRY };

    const wb = await ensurePrimary();
    const entry = {
      name: EMOJI_ENTRY,
      enabled: true,
      position: atDepthPos('system', 4, ORDER),
      recursion: { prevent_incoming: false, prevent_outgoing: true },
      strategy: { ...SELECTIVE_EMPTY, keys: ['bqb', '表情包'] },
      content: String(content || ''),
    };
    await createWorldbookEntries(wb, [entry], { replace: false });
    return { created: true, name: EMOJI_ENTRY };
  }

  async function readQQEmojiStore() {
    const { entry } = await scan(EMOJI_ENTRY);
    return entry ? String(entry.content || '') : null;
  }

  async function writeQQEmojiStore(nextText) {
    const { wb } = await scan(EMOJI_ENTRY);
    let ok = false;
    await updateWorldbookWith(wb, worldbook =>
      worldbook.map(e => {
        if (e.name !== EMOJI_ENTRY) return e;
        ok = true;
        return { ...e, content: String(nextText ?? '') };
      }),
    );
    return ok;
  }

  // 小工具：往 <bqb>...</bqb> 里追加一行 [名字|URL]
  function _appendBqbLine(src, label, url) {
    const line = `[${label}|${url}]`;
    const start = src.indexOf('<bqb>');
    const end = src.indexOf('</bqb>');
    if (start >= 0 && end > start) {
      const head = src.slice(0, start + 5);
      const body = src.slice(start + 5, end).trimEnd();
      const tail = src.slice(end);
      return `${head}\n${body}\n${line}\n${tail}`;
    }
    // 没有 <bqb> 块就新建
    return `${src}\n<bqb>\n${line}\n</bqb>`;
  }

  async function addEmojiToStore(label, url) {
    const cur = (await readQQEmojiStore()) ?? EMOJI_DEFAULT;
    const next = _appendBqbLine(cur, label, url);
    await writeQQEmojiStore(next);
    return next;
  }

  // === 新增：RMPhone格式规范（只创建，不改动） ===
  async function ensureFormatSpecEntry() {
    const name = 'RMPhone格式规范';
    const { exists } = await scan(name);
    if (exists) return { created: false, name };

    const wb = await ensurePrimary();
    const entry = {
      name,
      enabled: true,
      position: atDepthPos('system', 0, ORDER),
      recursion: { prevent_incoming: true, prevent_outgoing: false },
      strategy: {
        type: 'selective',
        keys: ['<RMPhone>', 'QQ', 'qq', 'DM', 'GROUP'],
      },
      content: `当<inputs>标签中含"[{{消息格式}}|{{消息发出对象}}|{{消息内容等}}]"或"查看xxx发来的消息"等线上聊天格式时，AI必须强制使用该格式进行回复。严格禁止与其他回复格式同时使用：

<RMPhone>
[QQ|{{登录用户}}]
[DM|{{私聊对象}}]
<!-- 此处放置私聊内角色的消息 -->
[/DM|{{私聊对象}}]
[GROUP|{{群聊名}}]
<!-- 此处放置群聊内角色的消息 -->
[/GROUP|{{群聊名}}]
[/QQ|{{登录用户}}]
</RMPhone>

格式介绍：
- [QQ|{{登录用户}}]表示当前手机QQ登录的用户。
- [DM|{{私聊对象}}]表示私聊聊天块，{{私聊对象}}是{{登录用户}}的单人聊天对象。
- [GROUP|{{群聊名}}]表示群聊聊天块，{{群聊名}}即{{登录用户}}所在的群聊名。
消息格式介绍：
- 每一条角色消息都为[{{消息格式}}|{{消息发出方}}|{{消息内容等}}]
- 以下为具体的可发送消息类型：
  - 文字：[txt|{{发出方}}|{{文字消息内容}}]
  - 表情包：[bqb|{{发出方}}|{{表情包描述}}|{{表情包url}}]（表情包仅可使用<bqb>中已有内容）
  - 语音：[voice|{{发出方}}|{{语音时长}}|{{语音内容}}]
  - 多媒体：[dmt|{{发出方}}|{{多媒体（图片、视频等）的文字描述}}]
  - 文件：[file|{{发出方}}|{{文件名}}|{{文件大小}}]
  - 接收文件：[file.rcv|{{发出方}}|{{文件名}}]（此消息仅收到文件时使用）
  - 时间戳：[time|时间|{{当前时间（HH:MM）}}]（时间戳不需要规定发送方）
  - 定位：[loc|{{发出方}}|{{位置信息}}]
  - 转账：[xfr|{{发出方}}|{{接收方}}|{{转账金额}}]
  - 接受转账：[xfr.rcv|{{发出方}}|{{转账方}}|{{转账金额}}]
  - 拒收转账：[xfr.rfd|{{发出方}}|{{转账方}}|{{转账金额}}]
  - 拍一拍：[nudge|{{发出方}}|{{拍一拍对象}}]
  - 个性签名：[sig|{{发出方}}|{{个性签名内容，不超过20字}}]
  - 邀请进群：[invite|{{发出方}}|{{被邀请人}}]（仅在群聊使用）
  - 拉黑：[block|{{发出方}}|{{被拉黑对象}}]（仅在私聊使用）
  - 取消拉黑：[unblock|{{发出方}}|{{被取消拉黑对象}}]（仅在私聊使用）
  - 分享动态：[mmtshare|{{发出方}}|{{动态编号，为当前账号的ZONE中moment后的唯一标识符}}]
格式规范：
- **绝对禁止遗漏任何闭合标签**。
- 每次更新回复时，都必须在每个消息块加入一个时间戳。
- 每条消息格式都由一个[{{消息格式}}|{{消息发出对象}}|{{消息内容等}}]发送。
- 严禁扮演{{user}}: 绝对禁止生成任何发送方为{{user}}的消息。
- **回复<inputs>中每一个消息块的内容,当<inputs>中的聊天块为空、或以非{{user}}消息结尾，也需要在此聊天块创建新消息。**（允许回复多个聊天块）。
- 消息数量: 根据对话情景，每个聊天块回复3到7条消息。避免每次都只回一条或固定数量，要模拟真实聊天的打字和发送习惯。
- 内容多样性: 不要总是以固定的方式（如表情、语气词）开头。让对话内容自然、生动，既要符合网络聊天习惯，又要符合角色性格。
- 请维持聊天数据的统一，在user发送的聊天块中发展后续对话，而不是以其他角色视角开启新账号。
- 可以同时在多个窗口中回复消息。如果当前场景暗示了可能有多个对话正在进行，你的<RMPhone>标签内就应该包含多个对应的聊天块。极少数情况下，甚至可以通过创建一个新的[QQ|{{login用户}}]/[DM]/[GROUP]来主动开启一个新聊天块。
- 聊天块之间的对话是互相不可见的，注意线上私聊群聊的私密性。
- 请维持聊天数据的统一，在user发送的聊天块中发展后续对话，而不是以其他角色视角开启新账号。`,
    };
    await createWorldbookEntries(wb, [entry], { replace: false });
    return { created: true, name };
  }

// == 动态收藏 / 动态规范：名称常量 ==
const DYN_FAVS_ENTRY = 'RMPhone动态收藏';
const DYN_SPEC_ENTRY = 'RMPhone动态规范';

// 只创建一次：RMPhone动态收藏（参数对齐“RMPhone手机设置”：同 order、保护策略、content 为空）
async function ensureDynamicFavsEntry() {
  const { wb, exists } = await scan(DYN_FAVS_ENTRY);
  if (exists) return { created: false, name: DYN_FAVS_ENTRY };
  const entry = {
    name: DYN_FAVS_ENTRY,
    position: { order: ORDER },
    ...PROTECT_META,                  // 与“手机设置”一致：受保护 + selective.empty
    strategy: SELECTIVE_EMPTY,
    content: '',
  };
  await createWorldbookEntries(wb, [entry], { replace: false });
  return { created: true, name: DYN_FAVS_ENTRY };
}

// 只创建一次：RMPhone动态规范（参数对齐“RMPhone格式规范”：同 atDepthPos/recursion/strategy）
async function ensureDynamicSpecEntry() {
  const { wb, exists } = await scan(DYN_SPEC_ENTRY);
  if (exists) return { created: false, name: DYN_SPEC_ENTRY };
  const entry = {
    name: DYN_SPEC_ENTRY,
    enabled: true,
    position: atDepthPos('system', 2, ORDER),
    recursion: { prevent_incoming: true, prevent_outgoing: false },
    strategy: { type: 'selective', keys: ['ZONE', 'zone', '动态', '空间'] },
    content: `当<inputs>标签中含动态相关的聊天格式时，AI必须强制使用该格式进行回复。严格禁止与其他回复格式同时使用（可与聊天格式共同使用，但只允许一个<RMPhone>标签）：

<RMPhone>
[QQ|{{登录用户}}]
[ZONE]
[moment|{{moment唯一序号，不可与已有moment重复}}]
<!-- 此处放置每条动态的具体内容 -->
[/moment|{{moment唯一序号}}]
[/ZONE]
[/QQ|{{登录用户}}]
</RMPhone>

格式介绍：
- [ZONE]表示当前手机QQ登录的用户的QQ空间块。
- [moment|{{moment唯一序号，不可与已有moment重复}}]表示每条动态的内容块，第二字段为此动态唯一标识符。
消息格式介绍：
- 每一条动态内消息都为[{{消息格式}}|{{消息发出方}}|{{消息内容等}}]
  - 文字：[txt|{{发出方}}|{{文字消息内容}}]
  - 表情包：[bqb|{{发出方}}|{{表情包描述}}|{{表情包url}}]（表情包仅可使用<bqb>中已有内容）
  - 多媒体：[dmt|{{发出方}}|{{多媒体（图片、视频等）的文字描述}}]
  - 时间戳：[time|时间|{{当前时间（HH:MM）}}]（时间戳不需要规定发送方，且为发送动态必加项）
  - 定位：[loc|{{发出方}}|{{位置信息}}]
  - 点赞：[like|{{点赞人，多人用顿号隔开}}]
  - 评论：[comment|{{发出方}}|{{评论内容}}]
  - 回复评论：[reply|{{发出方（当前登录用户）}}|{{回复对象}}|{{回复内容}}]
格式规范：
- **绝对禁止遗漏任何闭合标签**。
- 每次更新动态内容时，都必须在每个动态块加入一个时间戳。
- 每条动态内消息都由一个[{{消息格式}}|{{消息发出对象}}|{{消息内容等}}]发送。
- 严禁扮演{{user}}: 绝对禁止生成任何发送方为{{user}}的消息。
- **回复[moment]中每一个{{user}}的消息内容**。
- 回复已有moment内容时，请将此moment的所有内容重新发送一遍。
`,
  };
  await createWorldbookEntries(wb, [entry], { replace: false });
  return { created: true, name: DYN_SPEC_ENTRY };
}

// —— 动态收藏：读/写（JSON 数组） ——
async function readDynamicFavs() {
try {
const name = await ensurePrimary();
const wb = await window.getWorldbook?.(name).catch(() => null);
const ent = (wb?.entries || []).find(e => String(e?.name) === DYN_FAVS_ENTRY);
const raw = String(ent?.content ?? '').trim();
if (!raw) return [];
return JSON.parse(raw);
} catch { return []; }
}


async function writeDynamicFavs(list) {
  try {
    const wb = await ensurePrimary();
    await updateWorldbookWith(wb, worldbook =>
      worldbook.map(e => {
        if (String(e?.name) !== DYN_FAVS_ENTRY) return e;
        return {
          ...e,
          content: JSON.stringify(Array.isArray(list) ? list : [])
        };
      })
    );
  } catch {}
}

  return {
    ROOT_KEY,
    DEFAULT_GLOBAL,
    // 主设定（带 ROOT_KEY）
    load,
    apply,
    getAll,
    getApp,
    saveGlobal,
    saveApp,
    // 通用“扫描/只创建/读 JSON”
    scan,
    ensure,
    readEntryJSON,
    createQQGroupEntry,

    ensureQQEmojiStore,
    readQQEmojiStore,
    writeQQEmojiStore,
    addEmojiToStore,
    ensureFormatSpecEntry,
    ensureDynamicFavsEntry,
    ensureDynamicSpecEntry,
    readDynamicFavs,
    writeDynamicFavs,
  };
})();

      /* ===== 启动一次：读 → 应用（只有首次缺条目才会新建一次） ===== */
      (async () => {
        if (window.__RMPhoneWBLoaded__) return;
        window.__RMPhoneWBLoaded__ = true;
        try {
          const { data } = await RMPhoneToWorldBook.load();
          RMPhoneToWorldBook.apply(data); // 应用 global（壁纸 / 比例 / bksx）
          await RMPhoneToWorldBook.ensureQQEmojiStore?.();
          await RMPhoneToWorldBook.ensureFormatSpecEntry?.();
          await RMPhoneToWorldBook.ensureDynamicFavsEntry?.();
          await RMPhoneToWorldBook.ensureDynamicSpecEntry?.();
        } catch (e) {
          console.warn('RMPhoneToWorldBook:', e);
        }
      })();

/**
 * 模块：RMPhoneToChatMessage
 * 作用：把聊天里的 <RMPhone>…</RMPhone> 文本块，解析成可操作的 _data，
 *      并提供安全的序列化/回写（更新“最新一楼消息”里的 RMPhone 块）
 *
 * 公开 API：
 *   - getData(): {_data}                          取完整数据（引用）
 *   - setData(obj): void                          覆盖完整数据（谨慎）
 *   - getApp(name): Object                        取某个 App 的数据引用（常用）
 *   - setApp(name, obj): void                     设置某 App 数据
 *   - toRaw(): string                             把 _data 转回 <RMPhone> 文本（调试）
 *   - buildRaw(data): string                      同上，对传入对象进行序列化
 *   - safeParse(raw): {ok,data|error}             安全解析原始文本
 *   - RMPhoneCommit(): Promise<void>              把当前 _data 写回聊天（覆盖最近一段 RMPhone）
 *
 * 便捷方法（QQ 数据相关的小工具）：
 *   - ensureAccount(qq, login)
 *   - ensureSession(acc, kind, peer)
 *   - pushItem(sess, item, login)                 自动填充方向等字段
 *
 * 数据与副作用：
 *   - 内部维护 _raw 与 _data（开局从 `$1` 宏获取原始文本）
 *   - Commit 会修改“最新一楼消息”的 RMPhone 块内容（其余消息不动）
 *
 * 与谁联动：
 *   - RMQQ.Data：作为持久化后端（Data 改内存 → 需要时通过本模块 commit 到聊天）
 *   - QQ 视图（Tabs/Chat）：只读/订阅 Data，不直接操作本模块
 *
 * 典型时序：
 *   init → safeParse(_raw) → getApp('qq') 就地修改 → RMPhoneCommit()
 *
 * 注意点：
 *   - 文本协议有转义/嵌套规则，建议优先“就地修改对象 + commit”
 *   - 不要在 innerHTML 里直接拼用户文本，避免注入（先写静态骨架，再用 textContent/属性赋值）
 */
      const RMPhoneToChatMessage = (() => {
  /* 依赖检测：等插件把 getChatMessages / setChatMessages 挂到 window */
  const needFns = ['getChatMessages', 'setChatMessages'];
  const waitAPI = async (t = 15000) => {
    const ok = () => needFns.every(k => typeof window[k] === 'function');
    if (ok()) return;
    const s = Date.now();
    while (Date.now() - s < t) {
      await new Promise(r => setTimeout(r, 50));
      if (ok()) return;
    }
    throw new Error('ChatMessage API 未就绪');
  };

  /* ---- 小工具：统一转义/还原 ---- */
  const ESC = {
    unescape(s = '') {
      return s
        .replace(/\\\\/g, '\u0000')   // 暂存反斜杠
        .replace(/\\"/g, '"')         // 还原转义引号
        .replace(/\\\|/g, '|')        // 还原管道
        .replace(/\\\]/g, ']')        // 还原右括
        .replace(/\u0000/g, '\\');    // 还原反斜杠
    },
    escape(s = '') {
      return String(s)
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\|/g, '\\|')
        .replace(/\]/g, '\\]');
    },
  };

  // 统一的“字段编码器”：含特殊字符则整段加引号，并对 `\` 与 `"` 做转义；
  // 否则走轻量 ESC.escape（兼容你原来的输出格式）
  const NEED_QUOTE = /[|\]"]/;
  function encodeField(v) {
    const sv = String(v ?? '');
    if (NEED_QUOTE.test(sv)) {
      return `"${sv.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"`;
    }
    return ESC.escape(sv);
  }

  function cleanseContent(s) {
    if (s == null) return '';
    const t = String(s).trim();
    if (t.startsWith('"') && t.endsWith('"')) return ESC.unescape(t.slice(1, -1));
    return ESC.unescape(t);
  }

  function splitFields(raw) {
    const out = [];
    let cur = '', i = 0, q = null;
    while (i < raw.length) {
      const ch = raw[i], prev = raw[i - 1];
      if (q) {
        if (ch === q && prev !== '\\') {
          q = null;
          cur += ch;
          i++;
          continue;
        }
        cur += ch;
        i++;
        continue;
      }
      if (ch === '"' && prev !== '\\') {
        q = '"';
        cur += ch;
        i++;
        continue;
      }
      if (ch === '|' && prev !== '\\') {
        out.push(cur);
        cur = '';
        i++;
        continue;
      }
      cur += ch;
      i++;
    }
    out.push(cur);
    return out.map(s => s.trim());
  }

  function tokenize(inner) {
    const PH = '\u0001';
    const safe = String(inner || '').replace(/\\\]/g, PH);
    const re = /\[([^\[\]]+)]/g;
    const toks = [];
    let m;
    while ((m = re.exec(safe))) toks.push(m[1].replaceAll(PH, ']'));
    return toks;
  }

  const RX_BLOCK = /<RMPhone>([\s\S]*?)<\/RMPhone>/i;
  function extractBlock(full) {
    const m = String(full || '').match(RX_BLOCK);
    if (!m) return null;
    const start = m.index, end = start + m[0].length;
    return { inner: m[1], before: full.slice(0, start), after: full.slice(end) };
  }

  // 解析一个时间文本为时间戳（失败返回 0）
  function parseTs(s) {
    if (!s) return 0;
    // 兼容 "2025-09-01 10:21:00 +0800" / "2025/09/01 10:21:00"
    const t = String(s).replace(/\./g, ' ').replace(/-/g, '/');
    const ms = Date.parse(t);
    return Number.isFinite(ms) ? ms : 0;
  }

  /* ---- 解析：raw -> data（支持 QQ / DM / GROUP / ZONE + MOMENT） ---- */
  function parseRaw(raw) {
    const data = { qq: { accounts: [] } };
    const toks = tokenize(raw);
    const stack = [];
    let acc = null, sess = null, curMoment = null;

    const push = (scope, name) => stack.push({ scope, name });
    const pop = (scope, expectName) => {
      for (let i = stack.length - 1; i >= 0; i--) {
        if (stack[i].scope === scope) {
          const it = stack.splice(i)[0];
          if (expectName && it.name && expectName.trim() !== it.name.trim()) {
            console.warn(`闭合名不匹配: [/${scope}|${expectName}] vs [${it.scope}|${it.name}]`);
          }
          if (scope === 'qq') {
            acc = null;
            sess = null;
            curMoment = null;
          }
          if (scope === 'dm' || scope === 'group' || scope === 'zone') {
            sess = null;
            curMoment = null;
          }
          if (scope === 'moment') {
            curMoment = null;
          }
          return;
        }
      }
      console.warn('未找到要闭合的作用域：', scope, expectName);
    };

    for (const t of toks) {
      const parts = splitFields(t);
      if (!parts.length) continue;
      const head = (parts[0] || '').trim().toUpperCase();

      // [QQ|login]
      if (head === 'QQ') {
        const login = (parts[1] || '').trim();
        acc = { login, sessions: [] };
        data.qq.accounts.push(acc);
        push('qq', login);
        continue;
      }
      if (head === '/QQ') {
        pop('qq', (parts[1] || '').trim());
        continue;
      }

      // [DM|peer] / [/DM|peer]
      if (head === 'DM') {
        if (!acc) { console.warn('DM 前未进入 QQ'); continue; }
        const peer = (parts[1] || '').trim();
        sess = { kind: 'dm', peer, items: [] };
        acc.sessions.push(sess);
        push('dm', peer);
        continue;
      }
      if (head === '/DM') {
        pop('dm', (parts[1] || '').trim());
        continue;
      }

      // [GROUP|peer] / [/GROUP|peer]
      if (head === 'GROUP') {
        if (!acc) { console.warn('GROUP 前未进入 QQ'); continue; }
        const peer = (parts[1] || '').trim();
        sess = { kind: 'group', peer, items: [] };
        acc.sessions.push(sess);
        push('group', peer);
        continue;
      }
      if (head === '/GROUP') {
        pop('group', (parts[1] || '').trim());
        continue;
      }

      // [ZONE] [/ZONE]
      if (head === 'ZONE') {
        if (!acc) { console.warn('ZONE 前未进入 QQ'); continue; }
        if (!acc.zone) acc.zone = { kind: 'zone', moments: [] };
        sess = acc.zone;
        curMoment = null;
        push('zone', 'ZONE');
        continue;
      }
      if (head === '/ZONE') {
        pop('zone');
        curMoment = null;
        continue;
      }

      // [MOMENT|lane] [/MOMENT|lane]
      if (head === 'MOMENT') {
        if (!sess || sess.kind !== 'zone') { console.warn('MOMENT 只能出现在 ZONE 内'); continue; }
        const lane = cleanseContent(parts[1] || '0');
        curMoment = { lane, id: null, ts: 0, meta: {}, items: [] };
        sess.moments = Array.isArray(sess.moments) ? sess.moments : [];
        sess.moments.push(curMoment);
        push('moment', lane);
        continue;
      }
      if (head === '/MOMENT') {
        pop('moment', (parts[1] || '').trim());
        curMoment = null;
        continue;
      }

      // 消息行：新协议 [type|speaker|...args]
      if (!acc || !sess) {
        console.warn('忽略消息：不在 QQ/DM/GROUP/ZONE 作用域', t);
        continue;
      }

      const type = (parts[0] || '').trim().toLowerCase();
      const speaker = cleanseContent(parts[1] || '');
      const args = parts.slice(2).map(cleanseContent);
      const content = args[0] || '';

      const item = { type, speaker, args, content, out: speaker === acc.login };

      if (sess.kind === 'zone') {
        if (!curMoment) {
          // 自动开一个 lane=0 的 moment，保证鲁棒性
          curMoment = { lane: '0', id: null, ts: 0, meta: {}, items: [] };
          sess.moments = Array.isArray(sess.moments) ? sess.moments : [];
          sess.moments.push(curMoment);
        }
        // 记录时间：遇到第一条 time 即设为 moment.ts
        if (type === 'time' && !curMoment.ts) {
          const ms = parseTs(content);
          curMoment.ts = ms || 0;
        }
        // 支持 meta 扩展键值对（如 privacy=...）
        if (type === 'meta') {
          curMoment.meta = curMoment.meta || {};
          for (const kv of args) {
            const [k, v] = String(kv).split('=');
            if (k) curMoment.meta[k] = v ?? true;
          }
        } else {
          curMoment.items.push(item);
        }
      } else {
        sess.items.push(item);
      }
    }

    if (stack.length) console.warn('有未闭合的作用域：', stack);
    return data;
  }

  /* ---- 序列化：data -> raw（含 ZONE/MOMENT） ---- */
  function stringify(data) {
    const lines = [];

    const emitSession = (s) => {
      const open  = s.kind === 'dm' ? `[DM|${s.peer}]` : `[GROUP|${s.peer}]`;
      const close = s.kind === 'dm' ? `[/DM|${s.peer}]` : `[/GROUP|${s.peer}]`;

      const emitBlank = s._blank === true; // 兼容：支持“强制输出空框”
      if ((!Array.isArray(s.items) || s.items.length === 0) && !emitBlank) return;

      lines.push(open);

      if (!emitBlank) {
        for (const it of s.items || []) {
          const head = `[${it.type}|${it.speaker}`;
          const hasArgs = Array.isArray(it.args) && it.args.length > 0;

          // 优先用 args；若空，再回退到 content
          let tail = ']';
          if (hasArgs) {
            tail = '|' + it.args.map(encodeField).join('|') + ']';
          } else if (it.content) {
            tail = '|' + encodeField(it.content) + ']';
          }

          lines.push(head + tail);
        }
      }

      lines.push(close);
    };

    for (const acc of data?.qq?.accounts || []) {
      lines.push(`[QQ|${acc.login}]`);

      // DM/GROUP
      for (const s of acc.sessions || []) emitSession(s);

      // ZONE with MOMENTs
      if (acc.zone && Array.isArray(acc.zone.moments) && acc.zone.moments.length > 0) {
        lines.push(`[ZONE]`);
        for (const m of acc.zone.moments) {
          const lane = m?.lane ?? '0';
          lines.push(`[MOMENT|${lane}]`);
          for (const it of m.items || []) {
            const head = `[${it.type}|${it.speaker}`;
            const hasArgs = Array.isArray(it.args) && it.args.length > 0;
            let tail = ']';
            if (hasArgs) {
              tail = '|' + it.args.map(encodeField).join('|') + ']';
            } else if (it.content) {
              tail = '|' + encodeField(it.content) + ']';
            }
            lines.push(head + tail);
          }
          lines.push(`[/MOMENT|${lane}]`);
        }
        lines.push(`[/ZONE]`);
      }

      lines.push(`[/QQ|${acc.login}]`);
    }

    return lines.join('\n');
  }

  /* ---- 外部 API ---- */
  function getData() { return _data; }
  function setData(data) {
    _data = data || { qq: { accounts: [] } };
    return _data;
  }
  function getApp(appName) { return _data[appName]; }
  function setApp(appName, appData) {
    _data[appName] = appData || { accounts: [] };
    return _data[appName];
  }
  function toRaw() {
    _raw = stringify(_data);
    return _raw;
  }

  // 从“片段数据”生成 raw 文本（不包 <RMPhone> 外壳）
  function buildRaw(fragment) {
    try {
      const data =
        fragment && fragment.qq && Array.isArray(fragment.qq.accounts) ? fragment : { qq: { accounts: [] } };
      return stringify(data);
    } catch (e) {
      console.warn('buildRaw 失败：', e);
      return '';
    }
  }

  // 安全解析 raw -> data（失败返回 null，不抛）
  function safeParse(raw) {
    try {
      return parseRaw(String(raw || ''));
    } catch (e) {
      console.warn('safeParse 失败：', e);
      return null;
    }
  }

  // 把 toRaw() 的内容写回最新一楼的 <RMPhone>…</RMPhone> 中间
  async function RMPhoneCommit() {
    try { await waitAPI(); } catch (_) {} // 等不到也不阻塞，保持兼容
    const inner = toRaw();
    const last = (window.getChatMessages?.(-1) || [])[0];
    if (!last) return false;
    const full = String(last.message || '');
    const blk = extractBlock(full);
    const nextFull = blk
      ? `${blk.before}<RMPhone>\n${inner}\n</RMPhone>${blk.after}`
      : `${full}\n\n<RMPhone>\n${inner}\n</RMPhone>`;
    if (nextFull === full) return false;
    await window.setChatMessages?.([{ message_id: last.message_id, message: nextFull }], { refresh: 'none' });
    return true;
  }

/* ---- 初始化：从最新楼层读取 <RMPhone> 内容 ---- */
let _raw = '';
let _data = { qq: { accounts: [] } };
let _initPromise = null;

// 异步初始化函数
const initFromLatestMessage = async () => {
  try {
    await waitAPI();
    const messages = window.getChatMessages?.(-1) || [];
    const last = messages[0];
    if (last) {
      const full = String(last.message || '');
      const blk = extractBlock(full);
      if (blk && blk.inner) {
        _raw = blk.inner;
        _data = safeParse(_raw) || { qq: { accounts: [] } };
      }
    }
  } catch (e) {
    console.warn('RMPhoneToChatMessage 初始化失败：', e);
  }
};

// 创建初始化 Promise
_initPromise = initFromLatestMessage();

// 添加一个等待初始化的方法
const ensureInitialized = () => _initPromise;

  return { getData, setData, getApp, setApp, toRaw, RMPhoneCommit, buildRaw, safeParse, ensureInitialized};
})();


      /* ===== App 管理器 ===== */
      class AppManager {
        constructor(root) {
          this.root = root;
          this.viewport = root.querySelector('#viewport');
          this.stack = []; // [{ name, inst }]
          this.top = null;
        }
        open(name, sourceEl) {
          const factory = RMPhone.Apps.registry?.[name];
          if (!factory) {
            console.warn('未注册的 app:', name);
            return;
          }
          let item = this.stack.find(i => i.name === name);
          if (!item) {
            const inst = factory(sourceEl);
            inst.__name = name;
            item = { name, inst };
            this.stack.push(item);
          }
          this.top = item;
          this._mountTop();
        }
        _mountTop() {
          this.root.classList.add('is-app-open');
          this.viewport.style.display = 'block';
          this.viewport.innerHTML = '';
          this.top?.inst?.mount?.(this.viewport);
        }
        async toDesktop() {
  // ← 新增：截图保存缩略图
  if (this.top && window.html2canvas) {
    try {
      const canvas = await html2canvas(this.viewport, {
        backgroundColor: null,
        useCORS: true,
        scale: 1         // 缩放减小体积，可改 1 得更清晰
      });
      this.top.previewDataURL = canvas.toDataURL('image/png');
    } catch (e) {
      console.warn('preview failed:', e);
    }
  }

  // 回桌面，不杀进程
  this.viewport.innerHTML = '';
  this.root.classList.remove('is-app-open');
  this.viewport.style.display = '';
}
        closeByName(name) {
          const idx = this.stack.findIndex(i => i.name === name);
          if (idx < 0) return;
          const item = this.stack[idx];
          item.inst?.unmount?.();
          this.stack.splice(idx, 1);
          if (this.top && this.top.name === name) {
            this.top = null;
            this.toDesktop();
          }
        }
        list() {
          return this.stack.map(i => i.name);
        }
        getPreview(name) {
          return this.stack.find(i => i.name === name)?.previewDataURL || null;
        }
      }

      /* ===== 桌面模块 ===== */
      (function (NS) {
        class Desktop {
          constructor(root) {
            this.root = root;
            this.pages = root.querySelector('.RMPhone-pages');
            this.pageEls = Array.from(root.querySelectorAll('.RMPhone-page'));
            this.dotsWrap = root.querySelector('.RMPhone-page-dots');
            this.homebar = root.querySelector('#homebar');
            this.switcher = root.querySelector('#switcher');
            this.manager = new AppManager(root);
            const idxAttr = parseInt(root.getAttribute('data-initial-index'), 10);
            this.INITIAL_INDEX = Number.isFinite(idxAttr) ? Math.max(0, Math.min(idxAttr, this.pageEls.length - 1)) : 0;
            this.isDragging = false;
            this.startX = 0;
            this.startLeft = 0;
            this.snapTimer = null;
          }

          mount() {
            this.buildDots();

// 记录默认页，给后面 resize 用
this._currentIndex = this.INITIAL_INDEX;

// 等一帧，让宽度先定下来，再跳
requestAnimationFrame(() => this.jumpTo(this.INITIAL_INDEX, false));
// 兜底：等资源都加载完再稳一次
window.addEventListener('load', () => this.jumpTo(this.INITIAL_INDEX, false));
            this.bindScrollSnap();
            this.bindDragScroll();
            this.disableImageDrag();
            this.bindAppLaunch();
            this.bindHomebar();
            window.addEventListener('resize', () => {
  this.jumpTo(this._currentIndex ?? this.INITIAL_INDEX, false);
});
          }

          buildDots() {
            this.dotsWrap.innerHTML = '';
            this.pageEls.forEach((_, i) => {
              const d = document.createElement('div');
              d.className = 'dot' + (i === this.INITIAL_INDEX ? ' active' : '');
              d.dataset.index = i;
              d.addEventListener('click', () => this.jumpTo(i, true));
              this.dotsWrap.appendChild(d);
            });
            this.dots = Array.from(this.dotsWrap.children);
          }

          updateDots() {
            const idx = Math.round(this.pages.scrollLeft / this.pages.clientWidth);
            this._currentIndex = idx; // ← 新增：记住当前页
            this.dots.forEach((d, i) => d.classList.toggle('active', i === idx));
          }

          jumpTo(index, animate) {
            const left = index * this.pages.clientWidth;
            if (animate) this.pages.scrollTo({ left, behavior: 'smooth' });
            else this.pages.scrollLeft = left;
            this.updateDots();
          }

          bindScrollSnap() {
            this.pages.addEventListener('scroll', () => {
              this.updateDots();
              clearTimeout(this.snapTimer);
              this.snapTimer = setTimeout(() => this.snapToNearest(), 120);
            });
          }

          snapToNearest() {
            const target = Math.round(this.pages.scrollLeft / this.pages.clientWidth) * this.pages.clientWidth;
            this.pages.scrollTo({ left: target, behavior: 'smooth' });
          }

          bindDragScroll() {
            const PULL_THRESHOLD = 5;
            let startX = 0,
              startLeft = 0;
            let dragging = false,
              mayDrag = false,
              pid = null;

            this.pages.addEventListener('pointerdown', e => {
              if (e.target.closest('button.RMPhone-app')) {
                dragging = false;
                mayDrag = false;
                pid = null;
                return;
              }
              pid = e.pointerId;
              mayDrag = true;
              startX = e.clientX;
              startLeft = this.pages.scrollLeft;
            });

            this.pages.addEventListener('pointermove', e => {
              if (!mayDrag) return;
              const dx = e.clientX - startX;
              if (!dragging && Math.abs(dx) > PULL_THRESHOLD) {
                dragging = true;
                this.pages.setPointerCapture(pid);
              }
              if (dragging) this.pages.scrollLeft = startLeft - dx;
            });

            const end = () => {
              if (dragging) this.snapToNearest();
              dragging = false;
              mayDrag = false;
              pid = null;
            };
            this.pages.addEventListener('pointerup', end);
            this.pages.addEventListener('pointercancel', end);
            this.pages.addEventListener('lostpointercapture', end);
          }

          disableImageDrag() {
            this.root.querySelectorAll('.RMPhone-app img').forEach(img => {
              img.setAttribute('draggable', 'false');
              img.addEventListener('dragstart', e => e.preventDefault());
            });
          }

          bindAppLaunch() {
            this.pages.addEventListener('click', e => {
              const btn = e.target.closest('button.RMPhone-app');
              if (!btn) return;
              const name = btn.getAttribute('data-app');
              this.manager.open(name, btn);
            });
          }

          /* Home 条手势 */
          bindHomebar() {
            const hb = this.homebar;
            const OPEN_ZONE = 24;
            const MAX_DRAG = 32;
            const HOLD_MS = 350;
            const SWIPE_DY = 14;
            const SWIPE_DT = 350;

            let startY = 0,
              dragging = false,
              held = false,
              inZone = false,
              t0 = 0,
              holdTimer = null,
              lastY = 0;

            const setY = y => {
              hb.style.transform = `translateX(-50%) translateY(${-y}px)`;
            };
            const clearHold = () => {
              clearTimeout(holdTimer);
              holdTimer = null;
            };

            hb.addEventListener('pointerdown', e => {
              dragging = true;
              held = false;
              inZone = false;
              startY = e.clientY;
              t0 = performance.now();
              hb.setPointerCapture(e.pointerId);
              hb.style.transition = 'none';
            });

            hb.addEventListener('pointermove', e => {
              if (!dragging) return;
              const dy = Math.max(0, Math.min(MAX_DRAG, startY - e.clientY)); // 上拖为正
              lastY = dy;
              setY(dy);

              if (dy >= OPEN_ZONE && !inZone) {
                inZone = true;
                clearHold();
                holdTimer = setTimeout(() => {
                  held = true;
                  this.showSwitcher();
                  reset();
                }, HOLD_MS);
              } else if (dy < OPEN_ZONE && inZone) {
                inZone = false;
                clearHold();
              }
            });

            const reset = () => {
              dragging = false;
              clearHold();
              inZone = false;
              hb.style.transition = 'transform .25s var(--ease)';
              setY(0);
            };

            hb.addEventListener('pointerup', () => {
              if (held) {
                reset();
                return;
              }
              const dt = performance.now() - t0;
              if (lastY > SWIPE_DY && dt < SWIPE_DT) {
                this.manager.toDesktop();
              }
              reset();
            });

            hb.addEventListener('pointercancel', reset);
            hb.addEventListener('lostpointercapture', reset);
          }

          /* 后台：渲染、点击空白关闭；卡片可上滑关闭 */
          async showSwitcher() {
            // 先回到桌面，保留进程但把视图收起来
            await this.manager.toDesktop();   // ← 加了 await
            this.manager.toDesktop();

            const names = this.manager.list().slice().reverse();
            this.root.classList.add('is-switcher-open');

            if (!names.length) {
              this.switcher.innerHTML = '<div class="RMPhone-switcher-empty">无后台应用</div>';
              this.switcher.classList.add('is-open');
              this.switcher.onclick = () => this.hideSwitcher();
              return;
            }

            this.switcher.innerHTML = '<div class="RMPhone-switcher-track" id="switcher-track"></div>';
            const track = this.switcher.querySelector('#switcher-track');

            names.forEach(name => {
              const card = document.createElement('div');
              card.className = 'RMPhone-switcher-card';
              card.dataset.name = name;
              card.innerHTML = `<div class="thumb"></div><div class="title">${name}</div>`;
              const prev = this.manager.getPreview?.(name);
              if (prev) card.querySelector('.thumb').style.backgroundImage = `url('${prev}')`;
              this.attachCardSwipeToClose(card, name);
              // names.forEach(...) 里：创建 card 后
              let moved = false,
                sx = 0,
                sy = 0;
              card.addEventListener('pointerdown', e => {
                moved = false;
                sx = e.clientX;
                sy = e.clientY;
              });
              card.addEventListener(
                'pointermove',
                e => {
                  if (Math.abs(e.clientX - sx) > 6 || Math.abs(e.clientY - sy) > 6) moved = true;
                },
                { passive: true },
              );
              card.addEventListener('click', e => {
                if (moved) return; // 真的是“拖动”就不触发打开
                this.manager.open(name);
                this.hideSwitcher();
              });
              track.appendChild(card);
            });

            this.switcher.onclick = e => {
              if (!e.target.closest('.RMPhone-switcher-card')) this.hideSwitcher();
            };

            const update = () => {
              const rect = track.getBoundingClientRect(),
                cx = rect.left + rect.width / 2;
              track.querySelectorAll('.RMPhone-switcher-card').forEach(card => {
                const r = card.getBoundingClientRect(),
                  cc = r.left + r.width / 2;
                const t = Math.max(0, 1 - Math.abs(cc - cx) / (rect.width * 0.6));
                const s = 0.9 + 0.06 * t; // 0.90 ~ 0.96
                card.style.setProperty('--sc', s);
              });
            };
            track.addEventListener('scroll', () => requestAnimationFrame(update));
            this.switcher.classList.add('is-open');
            update();
          }

          hideSwitcher() {
            this.switcher.classList.remove('is-open');
            this.root.classList.remove('is-switcher-open');
            this.switcher.innerHTML = '';
            this.switcher.onclick = null;
          }

          attachCardSwipeToClose(card, name) {
            const LOCK_DIST = 10; // 判定方向阈值
            let pid = null,
              startX = 0,
              startY = 0,
              lock = null; // null | 'x' | 'y'
            let dragging = false,
              didClose = false;

            const reset = () => {
              if (pid !== null) {
                try {
                  card.releasePointerCapture(pid);
                } catch (_) {}
              }
              pid = null;
              lock = null;
              dragging = false;
              card.style.transition = 'transform .2s var(--ease), opacity .2s var(--ease)';
              card.style.setProperty('--ty', '0px');
              card.style.opacity = '1';
              card.style.touchAction = 'pan-x';
            };

            card.style.touchAction = 'pan-x';

            card.addEventListener('pointerdown', e => {
              pid = e.pointerId;
              startX = e.clientX;
              startY = e.clientY;
              lock = null;
              dragging = false;
              didClose = false;
              card.style.transition = 'none';
            });

            card.addEventListener('pointermove', e => {
              if (pid === null) return;
              const dx = e.clientX - startX,
                dy = e.clientY - startY;

              if (lock === null && (Math.abs(dx) > LOCK_DIST || Math.abs(dy) > LOCK_DIST)) {
                if (Math.abs(dy) > Math.abs(dx) && dy < 0) {
                  lock = 'y';
                  dragging = true;
                  card.setPointerCapture(pid);
                  card.style.touchAction = 'none';
                } else {
                  lock = 'x';
                  dragging = false;
                  return;
                }
              }

              if (lock === 'y' && dragging) {
                const y = Math.min(0, dy); // 上滑为负
                card.style.setProperty('--ty', `${y}px`);
                card.style.opacity = Math.max(0.35, 1 + y / 220);
              }
            });

            const end = e => {
              if (pid === null) return;

              if (lock === 'y') {
                const dy = e.clientY - startY,
                  H = card.getBoundingClientRect().height;

                if (dy <= -H * 0.5) {
                  didClose = true;
                  card.style.transition = 'transform .18s var(--ease), opacity .18s var(--ease)';
                  card.style.setProperty('--ty', `${-H}px`);
                  card.style.opacity = '0';

                  // 动画结束后再真正关闭 & 重建列表
                  setTimeout(() => {
                    this.manager.closeByName(name);
                    this.showSwitcher();
                  }, 200);

                  // 重要：这里直接 return，不要 reset()，避免“回落再飞走”
                  pid = null;
                  return;
                }
              }

              // 没触发关闭就复位
              reset();
            };

            card.addEventListener('pointerup', end);
            card.addEventListener('pointercancel', end);
            card.addEventListener('lostpointercapture', end);

            // 刚关闭时防止误点
            card.addEventListener('click', e => {
              if (didClose) {
                e.stopPropagation();
                e.preventDefault();
              }
            });
          }
        }

        NS.Desktop = Desktop;

        function init() {
          const root = document.querySelector('.RMPhone');
          if (root) {
            const inst = new Desktop(root);
            inst.mount();
            NS._instance = inst;
            NS.toDesktop = () => inst.manager.toDesktop();
            NS.showSwitcher = () => inst.showSwitcher();
          }
        }
        if (document.readyState !== 'loading') init();
        else document.addEventListener('DOMContentLoaded', init);
        })(window.RMPhone);

      /* ===== App 基类（Shadow DOM 版）与示例 Apps ===== */
      RMPhone.Apps.Base = class {
        constructor(el) {
          this.el = el;
          this.view = null;
          this.host = null;
          this.shadow = null;
        }
        mount(viewport) {
          this.view = viewport;
          this.host = document.createElement('div');
          this.host.className = 'RMPhone-app-host';
          this.host.style.cssText = 'position:absolute; inset:0; border-radius:inherit; overflow:hidden;';
          viewport.appendChild(this.host);
          this.shadow = this.host.attachShadow({ mode: 'open' });
        }
        unmount() {
          try {
            if (this.shadow) this.shadow.innerHTML = '';
          } catch (e) {}
          this.host?.remove();
          this.shadow = null;
          this.host = null;
          this.view = null;
        }
      };

      // ---- Shadow DOM 模板：每个 App 自含样式，不污染外层 ----
RMPhone.Apps.Settings = class extends RMPhone.Apps.Base { 
  constructor(el) {
    super(el);
    this.state = {
      ratio: '37/76',
      bksx: 284,
      wallpaper: '',
      font: {
        cssURL: 'https://fontsapi.zeoseven.com/69/main/result.css',
        family: 'Noto Sans CJK', // 思源黑体
        feature: '"hwid"',
      },
    };
    this._handlers = {};
    this._currentView = 'main';
  }

  /* ================= 应用到外层页面（即时生效） ================= */
  _applyAspect(ratio) {
    if (!ratio) return;
    document.documentElement.style.setProperty('--aspect-ratio', String(ratio));
  }
  _applyHue(h) {
    const hue = Math.max(0, Math.min(360, Number(h || 0)));
    document.documentElement.style.setProperty('--bksx', String(hue));
  }
  _applyWallpaper(url) {
    const bg = document.querySelector('.RMPhone-bg');
    if (bg && url) bg.style.backgroundImage = `url('${url}')`;
  }

  async _ensureFontInfra() {
    const head = document.head || document.getElementsByTagName('head')[0];
    let link = head.querySelector('#rmphone-font-link');
    if (!link) {
      link = document.createElement('link');
      link.id = 'rmphone-font-link';
      link.rel = 'stylesheet';
      head.appendChild(link);
    }
    let style = head.querySelector('#rmphone-font-override');
    if (!style) {
      style = document.createElement('style');
      style.id = 'rmphone-font-override';
      style.textContent = `
        :root{ --rmphone-font-family: Inter; --rmphone-font-feature: "hwid"; }
      `;
      head.appendChild(style);
    }
    return { link, style };
  }
  async _applyFont(fontCfg = {}) {
    const { cssURL, family, feature } = fontCfg || {};
    const { link } = await this._ensureFontInfra();
    if (cssURL) link.href = cssURL;
    const fam = family || 'Noto Sans CJK';
    const feat = feature || '"hwid"';
    document.documentElement.style.setProperty('--rmphone-font-family', fam);
    document.documentElement.style.setProperty('--rmphone-font-feature', feat);
  }

  async _saveGlobal(patch) {
    try { await RMPhoneToWorldBook.saveGlobal?.(patch); } catch(e) { console.warn('saveGlobal failed:', e); }
  }

  /* ============== 视图切换（设置 / 关于手机） ============== */
  _switchView(to) {
    const $ = s => this.shadow.querySelector(s);
    const main = $('#mainView');
    const about = $('#aboutView');
    const title = this.shadow.querySelector('.chat-name');
    if (to === 'about') {
      if (main) main.style.display = 'none';
      if (about) about.style.display = '';
      if (title) title.textContent = '关于手机';
      this._currentView = 'about';
    } else {
      if (about) about.style.display = 'none';
      if (main) main.style.display = '';
      if (title) title.textContent = '设置';
      this._currentView = 'main';
    }
  }

  /* ================== 生命周期：mount / unmount ================== */
  async mount(viewport) {
    super.mount(viewport);

    // 模板：顶部栏沿用 ChatView 风格；设置项上下排版
    this.shadow.innerHTML = `
<link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
<style>
  :host{ display:block; height:100%; }
  .set-wrap{
    --accent:#0099ff; --bg:#f2f4f7; --line:#e8ecf2; --topbot-alpha:.82; --island-clearance:10%;
    position:absolute; inset:0; display:flex; flex-direction:column; background:var(--bg); color:#111;
    font: 13px/1.35 var(--rmphone-font-family, Inter), system-ui, -apple-system, "Segoe UI", Arial;
    font-feature-settings: var(--rmphone-font-feature, "hwid");
  }
  .set-wrap *{ -webkit-tap-highlight-color: transparent; }

  /* 顶部栏（沿用 ChatView 方案） */
  .chat-topbar{ position:sticky; top:0; z-index:5; background:rgba(242,244,247,var(--topbot-alpha)); backdrop-filter:saturate(160%) blur(10px); border-bottom:1px solid var(--line); padding: calc(env(safe-area-inset-top, 0px) + var(--island-clearance)) 8px 6px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .chat-left{ display:flex; align-items:center; min-width:0; }
  .chat-back{ width:28px; height:28px; border:0; background:transparent; border-radius:8px; display:grid; place-items:center; flex:0 0 auto; cursor:pointer; }
  .chat-back i{ font-size:16px; transform:translateX(-0.2em); }
  .chat-center{ display:flex; flex-direction:column; min-width:0; }
  .chat-name{ font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .chat-status{ font-size:10.5px; color:#6b7280; }
  .chat-right{ display:flex; align-items:center; }

  /* 内容区 */
  .main{ flex:1; overflow:auto; padding:10px 10px 14px; -ms-overflow-style: none; scrollbar-width: none; }
  .main::-webkit-scrollbar{ display: none; }
  .card{ background:#fff; border:1px solid #eef1f5; border-radius:14px; padding:10px 10px; margin:0 0 12px; box-shadow:0 1px 0 rgba(17,24,39,0.02); }
  .row{ display:flex; flex-direction:column; gap:10px; padding:8px 6px; }
  .label{ font-size:12px; color:#6b7280; }
  .field{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .ipt{ flex:1; min-width:0; height:34px; border:1px solid #e5e7eb; border-radius:10px; padding:0 10px; background:#fff; color:#111; outline:none; }
  .btn{ height:30px; padding:0 10px; border:0; border-radius:8px; background:#2b84ff; color:#fff; cursor:pointer; }
  .btn.mini{ height:28px; }
  .hint{ font-size:12px; color:#888; }
  .swatch{ width:18px; height:18px; border-radius:4px; border:1px solid #e5e7eb; }
  input[type="range"]{ flex:1; }

  .radios{ display:flex; gap:10px; flex-wrap:wrap; }
  .radio{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; cursor:pointer; }
  .radio input{ accent-color:#2b84ff; }

  /* 关于视图里的“说明书”样式 */
  .manual{ white-space:pre-wrap; word-break:break-word; font-size:13px; line-height:1.6; }

  @media (max-width:420px){ .row{ padding:10px 8px; } }
</style>

<div class="set-wrap" role="application" aria-label="设置">
  <!-- 顶部栏（ChatView样式） -->
  <header class="chat-topbar">
    <div class="chat-left">
      <button class="chat-back" id="btnBack" aria-label="返回"><i class="fa-solid fa-angle-left"></i></button>
      <div class="chat-center">
        <div class="chat-name">设置</div>
        <div class="chat-status">暂用</div>
      </div>
    </div>
    <div class="chat-right"></div>
  </header>

  <!-- 视图：设置主页 -->
  <main class="main" id="mainView">
    <!-- 关于（新增入口，位于手机比例之上） -->
    <section class="card">
      <div class="row">
        <div class="label">关于</div>
        <div class="field">
          <button id="aboutBtn" class="btn mini" aria-label="打开关于手机">打开</button>
          <div class="hint">查看使用说明等信息</div>
        </div>
      </div>
    </section>

    <!-- 手机比例 -->
    <section class="card">
      <div class="row">
        <div class="label">手机比例</div>
        <div class="field">
          <input id="ratioIpt" class="ipt" type="text" inputmode="text" placeholder="例如 37/76 或 9/19" />
          <button id="ratioApply" class="btn mini">应用</button>
          <div class="hint">格式：宽/高，例如 37/76</div>
        </div>
      </div>
    </section>

    <!-- 边框色相 -->
    <section class="card">
      <div class="row">
        <div class="label">边框色相</div>
        <div class="field">
          <input id="hueRange" type="range" min="0" max="360" step="1" aria-label="边框色相" />
          <div id="hueSwatch" class="swatch" aria-hidden="true"></div>
          <div id="hueVal" class="hint"></div>
        </div>
      </div>
    </section>

    <!-- 壁纸 -->
    <section class="card">
      <div class="row">
        <div class="label">手机壁纸</div>
        <div class="field">
          <input id="wpIpt" class="ipt" type="url" placeholder="输入图片 URL" />
          <button id="wpApply" class="btn mini">应用</button>
        </div>
      </div>
    </section>

    <!-- 字体（默认思源；并持久化） -->
    <section class="card" role="group" aria-label="手机字体">
      <div class="row">
        <div class="label">手机字体</div>
        <div class="field radios">
          <label class="radio"><input type="radio" name="font" value="noto">思源黑体</label>
          <label class="radio"><input type="radio" name="font" value="chill">寒蝉圆黑体</label>
        </div>
      </div>
      <div class="row">
        <div class="label">自定义</div>
        <div class="field">
          <input id="fontUrl" class="ipt" type="url" placeholder="字体 CSS 的 URL（@import 所指向）" />
          <input id="fontFamily" class="ipt" type="text" placeholder="font-family 名称" />
          <button id="fontApply" class="btn mini">应用字体</button>
        </div>
      </div>
      <div class="row">
        <div class="label"></div>
        <div class="field"><div class="hint">默认：思源黑体（Noto Sans CJK）。切换后会保存到世界书“RMPhone手机设置”。</div></div>
      </div>
    </section>
  </main>

  <!-- 视图：关于手机（说明书） -->
  <main class="main" id="aboutView" style="display:none;">
    <section class="card">
      <div class="row">
        <div class="label">说明书</div>
        <div class="field" style="flex-direction:column; align-items:stretch;">
          <pre class="manual"># 设置
## 使用说明
## 调整比例
## 边框颜色
## 手机壁纸
## 手机字体
# QQ
## 登陆界面
- 输入用户名登录
## 主界面
- 左滑唤出抽屈：
  - 点击卡片头像设置账号头像
  - 点击切换账号切换登陆账号
  - 点击左下角设置注销当前账号
- 可切换消息、联系人、动态三视图
- 点击右上角可新建联系人、群聊
- 消息条目左滑“置顶”“标为未读”“删除（并不会删除聊天记录）”
- 点击具体条目进入聊天界面
- 点击联系人界面也可进入聊天界面
- 点击空间动态进入动态界面
## 聊天界面
- 右上角进入聊天设置
  - 额外查看此会话（约等于“查看xxx发来的消息，效力未知”）
  - 换联系人头像/群聊头像
  - 拉黑/取消拉黑
  - 设置聊天背景
  - 设置缩放
  - 清空聊天记录（不可逆）
  - 删除好友
  - 邀请好友（群聊的聊天设置，暂时有bug）
- 单击发送发送消息，双击发送触发回复
- 底部栏相机不可点，红包不可点
- 底部栏emoji可新建emoji，支持猫箱省略前缀的写法
- 底部栏加号位置，文件，转账可点
- 长按发送键选择回复范围
## 动态界面
- 点击背景可换图
- 右上角刷新可刷新动态内容（刷新时会清空未持久化动态）
- 右上角可发表动态内容
- 动态内容右上角三个点可选择收藏（有bug待修），存入楼层（持久保存），删除
- 动态内容可点赞，评论，分析，动态底下的评论可回复
## 暂时不支持撤回消息，删除消息，请点开楼层进行编辑</pre>
        </div>
      </div>
    </section>
  </main>
</div>`;

    /* ====== 初始化：读 worldbook 全局并应用 / 回填 ====== */
    try {
      const all = await RMPhoneToWorldBook.getAll?.();
      const g = (all && all.global) || {};
      if (g.aspectRatio) this.state.ratio = String(g.aspectRatio);
      if (g.bksx != null) this.state.bksx = Number(g.bksx);
      if (g.wallpaper) this.state.wallpaper = String(g.wallpaper);
      if (g.font && (g.font.cssURL || g.font.family)) this.state.font = { feature: '"hwid"', ...g.font };
    } catch (e) {
      console.warn('getAll failed, use defaults', e);
    }

    // 应用到页面
    this._applyAspect(this.state.ratio);
    this._applyHue(this.state.bksx);
    if (this.state.wallpaper) this._applyWallpaper(this.state.wallpaper);
    await this._applyFont(this.state.font);

    // 回填输入框
    const $ = s => this.shadow.querySelector(s);
    $('#ratioIpt').value = this.state.ratio || '';
    $('#hueRange').value = String(this.state.bksx);
    $('#hueSwatch').style.background = `hsl(${this.state.bksx}, 80%, 50%)`;
    $('#hueVal').textContent = String(this.state.bksx);
    $('#wpIpt').value = this.state.wallpaper || '';

    // 字体单选回填
    const chosen = (this.state.font.family || '').toLowerCase();
    const radioVal = chosen.includes('chill') ? 'chill' : (chosen.includes('noto') ? 'noto' : '');
    if (radioVal) this.shadow.querySelector(`input[name="font"][value="${radioVal}"]`)?.setAttribute('checked','checked');

    /* ================= 事件绑定 ================= */
    this._handlers.onBack = () => {
      if (this._currentView === 'about') {
        this._switchView('main');
      } else {
        RMPhone.toDesktop?.();
      }
    };

    this._handlers.onEnterAbout = () => this._switchView('about');

    this._handlers.onApplyRatio = async () => {
      const v = ($('#ratioIpt').value || '').trim();
      if (!v) return;
      this.state.ratio = v;
      this._applyAspect(v);
      await this._saveGlobal({ aspectRatio: v });
    };

    this._handlers.onHueInput = e => {
      const v = Number(e.target.value || 0);
      this.state.bksx = v;
      this._applyHue(v);
      $('#hueSwatch').style.background = `hsl(${v}, 80%, 50%)`;
      $('#hueVal').textContent = String(v);
    };
    this._handlers.onHueChange = async () => {
      await this._saveGlobal({ bksx: this.state.bksx });
    };

    this._handlers.onApplyWp = async () => {
      const url = ($('#wpIpt').value || '').trim();
      if (!url) return;
      this.state.wallpaper = url;
      this._applyWallpaper(url);
      await this._saveGlobal({ wallpaper: url });
    };

    this._handlers.onFontRadio = async e => {
      const v = e.target.value;
      let next = null;
      if (v === 'noto') {
        next = { cssURL: 'https://fontsapi.zeoseven.com/69/main/result.css', family: 'Noto Sans CJK', feature: '"hwid"' };
      } else if (v === 'chill') {
        next = { cssURL: 'https://fontsapi.zeoseven.com/83/main/result.css', family: 'Chill Round Gothic', feature: 'normal' };
      }
      if (next) {
        this.state.font = next;
        await this._applyFont(next);
        await this._saveGlobal({ font: next });
      }
    };

    this._handlers.onApplyFont = async () => {
      const cssURL = ($('#fontUrl').value || '').trim();
      const family = ($('#fontFamily').value || '').trim();
      if (!cssURL || !family) return;
      const next = { cssURL, family, feature: '"hwid"' };
      this.state.font = next;
      await this._applyFont(next);
      await this._saveGlobal({ font: next });
    };

    // 监听
    this.shadow.getElementById('btnBack')?.addEventListener('click', this._handlers.onBack);
    this.shadow.getElementById('aboutBtn')?.addEventListener('click', this._handlers.onEnterAbout);
    this.shadow.getElementById('ratioApply')?.addEventListener('click', this._handlers.onApplyRatio);
    this.shadow.getElementById('hueRange')?.addEventListener('input', this._handlers.onHueInput);
    this.shadow.getElementById('hueRange')?.addEventListener('change', this._handlers.onHueChange);
    this.shadow.getElementById('wpApply')?.addEventListener('click', this._handlers.onApplyWp);
    this.shadow.querySelectorAll('input[name="font"]').forEach(r => r.addEventListener('change', this._handlers.onFontRadio));
    this.shadow.getElementById('fontApply')?.addEventListener('click', this._handlers.onApplyFont);
  }

  unmount() {
    try {
      const root = this.shadow?.root || this.shadow;
      if (root) {
        root.getElementById?.('btnBack')?.removeEventListener('click', this._handlers.onBack);
        root.getElementById?.('aboutBtn')?.removeEventListener('click', this._handlers.onEnterAbout);
        root.getElementById?.('ratioApply')?.removeEventListener('click', this._handlers.onApplyRatio);
        root.getElementById?.('hueRange')?.removeEventListener('input', this._handlers.onHueInput);
        root.getElementById?.('hueRange')?.removeEventListener('change', this._handlers.onHueChange);
        root.getElementById?.('wpApply')?.removeEventListener('click', this._handlers.onApplyWp);
        root.querySelectorAll?.('input[name="font"]').forEach(r => r.removeEventListener('change', this._handlers.onFontRadio));
        root.getElementById?.('fontApply')?.removeEventListener('click', this._handlers.onApplyFont);
      }
    } catch {}
    this._handlers = {};
    super.unmount();
  }
};

      // ===== QQ App（重构版：迷你路由 + 屏幕协议 + 保留原样式/交互） =====
/**
 * 模块：RMQQ（QQ 子系统命名空间）
 * 作用：把 QQ 的“数据层（Data）+ 视图层（TabsView/ChatView/SpaceView/LoginView）+ 导航（ScreenManager）”
 *      打包在一起，提供清晰的对外接口
 *
 * 导出成员：
 *   - ScreenManager：轻量页面栈（入栈/出栈/过渡动画/保活）
 *   - TabsView     ：根页（三页横滑：聊天/联系人/动态；含搜索、长按、多选等）
 *   - ChatView     ：聊天页（消息渲染、发送、未读联动、回到底部等）
 *   - SpaceView    ：空间页（演示/占位）
 *   - LoginView    ：登录页（创建账号名）
 *   - Data         ：数据中心（事件总线、未读统计、订阅、持久化）
 *   - Extra        ：跨页选择集（多选/批量操作的共享状态）
 *
 * 内部协作（简版）：
 *   - 视图（Tabs/Chat/...）只订阅 Data 的事件来更新 DOM，不直接操作持久化
 *   - Data 负责组织内存数据 & 发布事件；需要持久化时调用 RMPhoneToChatMessage.commit()
 *   - ScreenManager 负责路由/动画；视图实现 {key, keepAlive, mount, unmount, onShow?, onHide?}
 */

      // ====================== QQ 封包（便于折叠） ======================
      const RMQQ = (() => {
/**
 * 类：ScreenManager（页面栈）
 * 作用：管理“屏幕级”视图的入栈/出栈与过渡动画；支持下层静默保活
 *
 * 公开方法：
 *   - constructor(root, classes?): 实例化；root 是容器元素
 *     classes：{ screen, hidden, anim, enterFrom, enterTo, leaveFrom, leaveTo }
 *   - push(screen): Promise<void>
 *       screen 需实现：{ key, keepAlive, mount(el), unmount(), onShow?, onHide? }
 *       首屏/根页（key==='tabs'）不右进；其余从右侧进入
 *   - pop(): Promise<boolean>     返回上一层（首屏不弹空）
 *   - top(): {screen, wrap}|null  当前栈顶项
 *   - topIndex(): number          栈顶索引（空为 -1）
 *   - destroy(): void             逆序卸载并清空栈
 *
 * 数据与副作用：
 *   - 新建包裹元素 wrap（.qq-screen）并挂到 root；切换时改类名触发 CSS 过渡
 *   - keepAlive=true 的页面在后台仅隐藏，不卸载（onHide/onShow 会被回调）
 *   - 为可访问性：隐藏页会加 aria-hidden
 *
 * 联动：
 *   - 被 RMPhone.Apps.QQ 调用，用来在 Tabs/Chat/Login 等视图间切换
 *
 * 注意点：
 *   - 动画通过 transitionend 结束；请确保 CSS 过渡类完整
 *   - pop 时会卸载被弹出的页面，释放事件监听
 */

        class ScreenManager {
          /**
           * @param {HTMLElement} root 包裹所有屏幕的容器（例如 <div id="router">）
           * @param {Object} [classes] 可选：自定义类名
           */
          constructor(root, classes) {
            this.root = root;
            this.stack = [];
            this.classes = Object.assign(
              {
                screen: 'qq-screen',
                hidden: 'hidden',
                anim: 'qq-anim',
                enterFrom: 'qq-enter-from',
                enterTo: 'qq-enter-to',
                leaveFrom: 'qq-leave-from',
                leaveTo: 'qq-leave-to',
              },
              classes || {},
            );
          }

          /** 栈顶项 */
          top() {
            return this.stack[this.stack.length - 1] || null;
          }

          /** 栈顶索引（空栈时为 -1） */
          topIndex() {
            return this.stack.length - 1;
          }

          /**
           * 从后往前找符合条件的屏幕，返回索引；找不到返回 -1
           * @param {(item:{screen:any,wrap:HTMLElement}, index:number)=>boolean} predicate
           */
          findIndexReverse(predicate) {
            for (let i = this.stack.length - 1; i >= 0; i--) {
              if (predicate(this.stack[i], i)) return i;
            }
            return -1;
          }

          /**
           * 入栈：首屏（或 key==='tabs'）不右进，其余页面右进
           * @param {Object} screen 需实现 { key, keepAlive, mount(el), unmount(), onShow?, onHide? }
           */
          push(screen) {
            const cls = this.classes;
            const wrap = document.createElement('div');
            wrap.className = cls.screen;
            wrap.setAttribute('data-key', screen.key || 'screen');

            const prev = this.top();
            if (prev?.wrap) {
              // 让下层完全静默
              prev.wrap.classList.add(cls.hidden);
              prev.wrap.setAttribute('aria-hidden', 'true');
              try {
                prev.screen.onHide?.();
              } catch {}
            }

            // 挂载
            this.root.appendChild(wrap);
            screen.mount(wrap);

            // 首屏或 tabs 不走“右进”
            const isFirst = this.stack.length === 0 || screen.key === 'tabs';
            if (!isFirst) {
              wrap.classList.add(cls.anim, cls.enterFrom);
              requestAnimationFrame(() => {
                // 触发过渡
                wrap.classList.add(cls.enterTo);
                const onDone = () => {
                  wrap.removeEventListener('transitionend', onDone);
                  wrap.classList.remove(cls.enterFrom, cls.enterTo);
                };
                wrap.addEventListener('transitionend', onDone);
              });
            }

            this.stack.push({ screen, wrap });
          }

          /**
           * 出栈：返回上一层；首屏不弹空
           * @returns {Promise<boolean>}
           */
          pop() {
            const cls = this.classes;
            if (this.stack.length <= 1) return Promise.resolve(false);

            const top = this.stack.pop();
            const below = this.top();
            const { wrap, screen } = top;

            return new Promise(resolve => {
              wrap.classList.add(cls.anim, cls.leaveFrom);
              requestAnimationFrame(() => {
                wrap.classList.add(cls.leaveTo);
                const done = () => {
                  wrap.removeEventListener('transitionend', done);
                  // 卸载并移除
                  try {
                    screen?.unmount?.();
                  } catch {}
                  wrap.remove();
                  // 下层恢复
                  if (below?.wrap) {
                    below.wrap.classList.remove(cls.hidden);
                    below.wrap.removeAttribute('aria-hidden');
                  }
                  try {
                    below?.screen?.onShow?.();
                  } catch {}
                  resolve(true);
                };
                wrap.addEventListener('transitionend', done);
              });
            });
          }

          /**
           * 连续弹出到栈中某一索引（包含目标保留）
           * @param {number} index
           */
          async popTo(index) {
            const target = Math.max(0, Math.min(index, this.topIndex()));
            while (this.topIndex() > target) {
              await this.pop();
            }
          }

          /** 销毁：逆序卸载所有屏幕并清空栈 */
          destroy() {
            for (let i = this.stack.length - 1; i >= 0; i--) {
              const it = this.stack[i];
              try {
                it.screen?.unmount?.();
              } catch {}
              try {
                it.wrap?.remove?.();
              } catch {}
            }
            this.stack = [];
          }
        }

/**
 * 类：TabsView（根页）
 * 作用：显示“聊天列表/联系人/动态”三页，承接顶部搜索、右上角菜单、未读角标、长按多选等
 *
 * 公开特性：
 *   - key = 'tabs'，keepAlive = true
 *   - 构造参数：{ login, onOpenChat, onOpenSpace, onLoginChanged }
 *     · login：当前账号，用于订阅数据
 *     · onOpenChat(info)：打开聊天页（由外壳导航）
 *     · onOpenSpace()：打开空间页
 *     · onLoginChanged(newLogin)：切换/删除账号后的回调
 *
 * 内部做的事（核心点）：
 *   - 渲染三页骨架（只用 innerHTML 放静态结构），数据部分用 DOM API 填充
 *   - 通过 Data.subscribeTabsSummaries({login}, cb) 渲染会话摘要并实时更新
 *   - 处理搜索/右上角菜单/长按多选（Extra 记录选择集）
 *   - 点击会话 → 调用 onOpenChat({ login, kind, peer, title, avatars })
 *
 * 联动：
 *   - 只读 Data，依赖其事件推送；不直接写入持久化
 *   - 与 Extra 共用“已选项”，支持批量操作
 *
 * 注意点：
 *   - 所有来自用户/数据的文本一律用 textContent/属性赋值（不要拼 innerHTML）
 *   - 大列表应尽量复用节点、避免频繁重排
 */

        class TabsView {
  constructor({ login, onOpenChat, onOpenSpace, onLoginChanged } = {}) {
    this.key = 'tabs';
    this.keepAlive = true;
    this.login = login; // 当前账号，用于数据订阅
    this.onOpenChat = onOpenChat; // 外壳回调：打开聊天
    this.onOpenSpace = onOpenSpace; // 外壳回调：打开空间
    this.onLoginChanged = onLoginChanged;
    this.root = null; // mount 后赋值
    this._onResize = null;
    this._qa = null; // 右上角 + 菜单引用
    this._unsubTabs = null; // 数据订阅取消函数
    this._offOtherUnread = null; // 其他账号未读订阅取消
    this._edgeReflow = null;
    this._onPeerAvatarUpdated = null;
    this._onChatDeleted = null;
    this._wbQQ = null;
    this._avatarMap = new Map();
  }

  mount(container) {
    this.root = container;
    this.root.innerHTML = `
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-thin-rounded/css/uicons-thin-rounded.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-thin-chubby/css/uicons-thin-chubby.css">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-chubby/css/uicons-regular-chubby.css">
  <style>
    :host{display:block;height:100%} *{box-sizing:border-box;}

    .qq-wrap{
      --accent:#2b84ff;
      --tabbar-h: 7%;
      --island-clearance: 10%;
      --bg-white:#fff;
      --bg-tint:#f2f4f7;
      --line:#e8ecf2;
      --text:#111;
      position:absolute; inset:0;
      font:12px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      user-select:none; -webkit-user-select:none;
      -webkit-touch-callout:none; touch-action: pan-y;
      color:var(--text);
    }

    .pages{ position:absolute; inset:0; overflow:hidden; }
    .track{ height:100%; width:300%; display:flex; transform:translate3d(0,0,0); transition:transform .28s cubic-bezier(.4,0,.2,1); }
    .page{ flex:0 0 33.3333%; overflow:auto; background:var(--bg-white); }
    .page::-webkit-scrollbar{ width:0; height:0; }

    .topbar{
      position:sticky; top:0; z-index:5;
      background:rgba(242,244,247,.96);
      backdrop-filter:saturate(160%) blur(10px);
      border-bottom:1px solid var(--line);
      padding: calc(env(safe-area-inset-top, 0px) + var(--island-clearance)) 12px 4px;
    }
    .topline{ display:flex; align-items:center; justify-content:space-between; }
    .top-left{ display:flex; align-items:center; gap:8px; min-width:0; }
    .avatar{ width:24px; height:24px; border-radius:50%; background:#dfe3ea; flex:0 0 auto; }
    .topbar .avatar{ position:relative; }
    .uinfo{ display:flex; flex-direction:column; min-width:0; }
    .name{ font-weight:600; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .online{ display:flex; align-items:center; gap:6px; font-size:10px; color:#6b7280; }
    .dot{ width:6px; height:6px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 2px var(--bg-tint) inset; }
    .top-btn{
      border:0; background:transparent; width:28px; height:28px; border-radius:8px;
      display:grid; place-items:center; font-size:16px; color:#000; -webkit-tap-highlight-color:transparent;
    }
    .top-btn:active{ background:rgba(0,0,0,.06); }
    .top-right{ display:flex; align-items:center; }
    #drawer .account .avatar{ width:44px; height:44px; }

    .searchbar{
      position:relative;
      margin:6px auto 6px; width:92%;
      height:28px; border-radius:10px;
      background:#f7f8fb; border:1px solid #eef1f5;
      display:flex; align-items:center; justify-content:center;
    }
    .searchbar input{ flex:1; width:100%; height:100%; border:none; outline:none; background:transparent; font-size:12.5px; color:#111; padding:0 10px; }
    .searchbar .hint{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; gap:6px; color:#9aa3ad; font-size:12.5px; pointer-events:none; transition:opacity .15s ease; }
    .searchbar .hint i{ font-size:13px; }
    .searchbar.focused .hint, .searchbar.not-empty .hint{ opacity:0; }

    .list{ flex:1; overflow:auto; }
    .list::-webkit-scrollbar{ width:0; height:0; }
    .list::after{ content:""; display:block; height: calc(var(--tabbar-h) + 10px); }

    .items{ list-style:none; margin:0; padding:0; }

    .item{ position:relative; overflow:hidden; background:#fff; }
    .item + .item{ border-top:1px solid #f0f2f5; }
    .row{ position:relative; overflow:hidden; width:100%; }
    .cell{
      width:100%;
      display:flex; gap:8px; align-items:flex-start;
      padding:7px 12px; background:#fff;
      position:relative; z-index:1;
      transform: translateX(0);
      transition: transform .2s cubic-bezier(.4,0,.2,1);
      will-change: transform;
    }
    .item.pinned .cell{ background:#f2f4f7; }
    .ava{ width:34px; height:34px; border-radius:999px; background:#eef2f7; flex:0 0 auto; position:relative; overflow:visible; }
    .meta{ flex:1; min-width:0; }
    .row1{ display:flex; align-items:baseline; justify-content:space-between; gap:6px; }
    .title{ font-weight:600; font-size:13px; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .time{ font-size:10px; color:#9aa3ad; white-space:nowrap; }
    .row2{ margin-top:1px; font-size:11.5px; color:#6b7280; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .actions{
      position:absolute; top:0; left:100%; height:100%;
      width: calc(100% * var(--action-frac, .56));
      display:flex; z-index:0;
      transform: translateX(calc(-1 * var(--reveal, 0px)));
      transition: transform .2s cubic-bezier(.4,0,.2,1);
    }
    .action{ border:0; outline:0; margin:0; display:flex; align-items:center; justify-content:center; color:#fff; font-size:12px; font-weight:700; }
    .action:nth-child(1){ flex: var(--w1, .333) 0 0; }
    .action:nth-child(2){ flex: var(--w2, .333) 0 0; }
    .action:nth-child(3){ flex: var(--w3, .333) 0 0; }

    .action.pin{    background:#2b84ff; }
    .action.unread{ background:#ffb11a; }
    .action.del{    background:#ff4d4f; }

    .row .cell{ touch-action: pan-y; }

    #spaceEntryBadge {
      position: static;
      margin-left: 6px;
      transform: translateY(-1px);
    }

    .ct-tabs{ display:flex; gap:8px; padding:8px 12px 6px; border-top:8px solid #f6f7fa; border-bottom:6px solid #f6f7fa; overflow-x:auto; }
    .ct-tabs::-webkit-scrollbar{ height:0; }
    .ct-tab{ padding:6px 10px; border-radius:999px; background:#f7f8fb; border:1px solid #eef1f5; color:#4b5563; font-size:12px; white-space:nowrap; }
    .ct-tab:active{ transform:scale(.98); }
    .ct-tab.active{ background:#e8f1ff; border-color:#cfe3ff; color:#2b84ff; font-weight:600; }

    .tabbar{
      position:absolute; left:0; right:0; bottom:0; height:var(--tabbar-h);
      background:rgba(242,244,247,.78); min-height:50px;
      backdrop-filter:saturate(160%) blur(10px);
      border-top:1px solid var(--line);
      display:flex; align-items:stretch;
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
    }
    .tab{ position:relative; flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#4b5563; border:0; background:transparent; }
    .tab:active{ transform:scale(.98); }
    .icon-wrap{ position:relative; height:18px; display:flex; align-items:flex-end; justify-content:center; }
    .tab i{ font-size:15px; line-height:1; }
    .tab .label{ font-size:10px; }
    .tab .icon-on{ display:none; }
    .tab.active .icon-on{ display:inline-block; }
    .tab.active .icon-off{ display:none; }
    .tab.active{ color:var(--accent); font-weight:600; }
    .tab--feed .icon-wrap {transform: translateY(2px);}
    .badge{ position:absolute; right:-2px; top:-2px; width:10px; height:10px; border-radius:999px; background:#ff3b30; color:#fff; font-size:9px; line-height:10px; display:none; align-items:center; justify-content:center; pointer-events:none;}
    .badge.show{ display:flex; }
    .ava > .badge{ width:10px; height:10px; top:-4px; right:-4px; line-height:10px; font-size:8px; }
    .tab .badge{ right:-2px; top:-2px; }
    .tab .icon-wrap > .badge{ right:-2px; top:-2px; }

    .mask{ position:absolute; inset:0; background:rgba(0,0,0,.5); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:55; }
    .drawer{ position:absolute; left:0; top:0; bottom:0; width:88%; max-width:320px; background:#fff;
      box-shadow: 2px 0 16px rgba(0,0,0,.2); transform:translateX(-100%); will-change:transform; z-index:60; touch-action: pan-y;
      display:flex; flex-direction:column; color:#000;
    }
    .drawer-scroll{ flex:1; overflow:auto; padding-top:12px; }
    .drawer-scroll::-webkit-scrollbar{ width:0; height:0; }

    .account{ margin:20% 12px 12px; padding:12px; border:1px solid var(--line); border-radius:14px; background:#fff; }
    .account-top{ display:flex; gap:10px; align-items:center; }
    .acc-right{ flex:1; min-width:0; }
    .acc-headline{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .acc-name{ font-weight:700; font-size:14px; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .switch-btn{ display:inline-flex; align-items:center; gap:4px; padding:4px 8px; font-size:12px; border-radius:999px; border:1px solid var(--line); background:#fff; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .switch-btn i{ font-size:14px; transform: translateY(2px); }
    .acc-sign{ margin-top:2px; font-size:12px; color:#6b7280; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .acc-tags{ margin-top:8px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; font-size:11px; }
    .tag{ padding:2px 6px; border-radius:999px; background:#f7f8fb; border:1px solid #eef1f5; color:#6b7280; }
    .tag.vip{ background:#fff7dc; border-color:#ffe8a6; color:#a87300; }
    .tag.crown{ background:#fff3d6; border-color:#ffd889; color:#b67b00; }
    .tag.star{ background:#f7fbff; border-color:#d8e9ff; color:#2b84ff; }

    .func{ margin:0 8px 8px; background:#fff; border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .func-item{ display:flex; align-items:center; gap:10px; padding:9px 12px; }
    .func-item + .func-item{ border-top:1px solid #f0f2f5; }
    .func-item i{ font-size:17px; transform: translateY(1.5px);} 
    .func-item .label{ font-size:13px; flex:1; }

    .drawer-bottom{ position:relative; padding:5px 12px 14px; border-top:1px solid var(--line);
      display:flex; gap:22px; align-items:flex-end; color:#4b5563;}
    .mini{ display:flex; flex-direction:column; align-items:center; gap:4px; font-size:11px; }
    .mini i{ font-size:18px; color:#374151; transform: translateY(5px);} 

    .edge{ position:absolute; left:0; top:0; bottom: var(--tabbar-h); width:44px; z-index:90; touch-action: none; -webkit-tap-highlight-color: transparent; }

    /* ============ 右上角“+”弹出小组件 ============ */
    .qa-menu{
      position:absolute;
      right:8px;
      top: calc(100% + 6px);
      width:45%;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.14);
      padding:6px 0;
      z-index:9;
      transform-origin: top right;
      transform: translateY(-8px) scale(.98);
      opacity:0; visibility:hidden;
      transition: transform .18s cubic-bezier(.4,0,.2,1), opacity .18s cubic-bezier(.4,0,.2,1), visibility .18s steps(1,end);
    }
    .qa-menu.show{ transform: translateY(0) scale(1); opacity:1; visibility:visible; }
    .qa-item{
      width:100%; border:0; background:transparent; text-align:left;
      display:flex; align-items:center; gap:12px; padding:10px 12px; font-size:13px; color:#111;
    }
    .qa-item i{ font-size:18px; width:20px; text-align:center; transform: translateY(3px); }
    .qa-item:active{ background:#f6f7fa; }

    /* ============ 抽屉里的“切换账号”弹窗 ============ */
    .acc-headline{ position:relative; } 

    .acc-switch{
      position:absolute;
      right:0;
      top: calc(100% + 6px);
      width:50%;
      min-width:140px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.14);
      padding:6px 0;
      z-index:9;
      transform-origin: top right;
      transform: translateY(-8px) scale(.98);
      opacity:0; visibility:hidden;
      transition: transform .18s cubic-bezier(.4,0,.2,1), opacity .18s cubic-bezier(.4,0,.2,1), visibility .18s steps(1,end);
      overflow:hidden;
    }
    .acc-switch.show{ transform: translateY(0) scale(1); opacity:1; visibility:visible; }
    .acc-switch-scroll{ max-height:50vh; overflow:auto; -webkit-overflow-scrolling: touch; }
    .acc-item{
      width:100%;
      border:0; background:transparent;
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; text-align:left;
      font-size:13px; color:#111;
    }
    .acc-item:active{ background:#f6f7fa; }
    .acc-item .head{
      width:28px; height:28px; border-radius:999px; position: relative;
      background:#e9eef6 center/cover no-repeat;
      flex:0 0 auto;
    }
    .acc-item .name{ flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .acc-item .check{ font-size:16px; color:#2b84ff; visibility:hidden; }
    .acc-item.active .check{ visibility:visible; }

    .acc-new{
      width:100%;
      display:flex; align-items:center; gap:10px;
      border:0; background:transparent;
      padding:10px; border-top:1px solid var(--line);
      font-size:13px; color:#111;
    }
    .acc-new:active{ background:#f6f7fa; }
    .acc-new .round{
      width:26px; height:26px; border-radius:999px;
      border:1px dashed #9aa3ad;
      display:grid; place-items:center; color:#6b7280;
      flex:0 0 auto;
    }
    .acc-new i{ font-size:18px; transform: translateY(2px); }

    /* ============ 通用弹窗（添加账号 / 加好友 / 编辑头像 / 建群） ============ */
    .qq-modal-mask{ position:absolute; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:95; }
    .qq-modal-mask.show{ display:flex; }
    .qq-modal{ width:86%; max-width:340px; background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.2); padding:12px; }
    .qq-modal .title{ font-weight:700; font-size:14px; margin-bottom:8px; }
    .qq-field{ display:flex; flex-direction:column; gap:6px; margin:8px 0; }
    .qq-field label{ font-size:12px; color:#6b7280; }
    .qq-field input{ height:32px; border:1px solid #eef1f5; border-radius:8px; padding:0 10px; outline:none; font-size:13px; background:#fff; color:#111; }
    .qq-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
    .qq-btn{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; font-size:12px; }
    .qq-btn.primary{ background:#2b84ff; color:#fff; border-color:#2b84ff; }
    .qq-error{ color:#ff4d4f; font-size:12px; min-height:1.2em; }
  </style>

  <div class="qq-wrap" id="qq">
    <div class="mask" id="mask"></div>

    <div class="drawer" id="drawer" aria-label="个人账号页" role="dialog">
      <div class="drawer-scroll">
        <section class="account">
          <div class="account-top">
            <div class="avatar" id="avatar"></div>
            <div class="acc-right">
              <div class="acc-headline">
                <div class="acc-name">落水的林维</div>
                <button class="switch-btn"><i class="fi fi-rr-exchange"></i><span>切换账号</span></button>

                <!-- 账号切换弹窗 -->
                <div class="acc-switch" id="accSwitch" role="menu" aria-hidden="true">
                  <div class="acc-switch-scroll" id="accSwitchList"></div>
                  <button class="acc-new" id="accSwitchNew">
                    <div class="round"><i class="fi fi-rr-plus-small"></i></div>
                    <span>登录新账户</span>
                  </button>
                </div>
                <!-- 账号切换弹窗结束 -->
              </div>
              <div class="acc-sign">编辑个签，展示我的独特态度。</div>
            </div>
          </div>
          <div class="acc-tags">
            <span class="tag vip">年SVIP9</span>
            <span class="tag crown"><i class="fi fi-rr-crown"></i> 特权</span>
            <span class="tag star">⭐️⭐️⭐️⭐️⭐️</span>
          </div>
        </section>

        <nav class="func" aria-label="功能列表">
          <div class="func-item">
            <i class="fi fi-rr-picture" style="color:#f2b91e"></i>
            <span class="label">相册</span>
            <i class="fi fi-rr-angle-small-right chev gray"></i>
          </div>
          <div class="func-item">
            <i class="fi fi-rr-wishlist-star" style="color:#2b84ff"></i>
            <span class="label">收藏</span>
            <i class="fi fi-rr-angle-small-right chev gray"></i>
          </div>
          <div class="func-item">
            <i class="fi fi-rr-folder" style="color:#2b84ff"></i>
            <span class="label">文件</span>
            <i class="fi fi-rr-angle-small-right chev gray"></i>
          </div>
          <div class="func-item">
            <i class="fi fi-rr-wallet" style="color:#2b84ff"></i>
            <span class="label">钱包</span>
            <i class="fi fi-rr-angle-small-right chev gray"></i>
          </div>
          <div class="func-item">
            <i class="fi fi-rr-crown" style="color:#ff4d4f"></i>
            <span class="label">会员中心</span>
            <i class="fi fi-rr-angle-small-right chev gray"></i>
          </div>
          <div class="func-item">
            <i class="fi fi-rr-tshirt" style="color:#ff4d4f"></i>
            <span class="label">个性装扮</span>
            <i class="fi fi-rr-angle-small-right chev gray"></i>
          </div>
          <div class="func-item">
            <i class="fi fi-rr-broadcast-tower" style="color:#22c55e"></i>
            <span class="label">免流量</span>
            <i class="fi fi-rr-angle-small-right chev gray"></i>
          </div>
        </nav>
      </div>

      <div class="drawer-bottom">
        <div class="mini" id="btnSettings" role="button" tabindex="0"><i class="fi fi-tc-settings"></i><span>设置</span></div>
        <div class="mini"><i class="fi fi-tc-moon"></i><span>夜间</span></div>
        <div class="mini"><i class="fi fi-tr-cloud-sun"></i><span>天气</span></div>
        <div class="qa-menu" id="setMenu" role="menu" aria-hidden="true"
          style="left:6px;right:auto;top:auto;bottom:58px;transform-origin:bottom left;">
          <button class="qa-item" id="btnLogout" aria-label="注销账号">
            <i class="fi fi-rr-exit"></i><span>注销账号</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 添加账号弹窗 -->
    <div class="qq-modal-mask" id="dlgAddAccount" aria-hidden="true">
      <div class="qq-modal" role="dialog" aria-label="添加账号">
        <div class="title">添加账号</div>
        <div class="qq-field">
          <label>名字</label>
          <input id="accAddName" placeholder="例如：小明">
        </div>
        <div class="qq-field">
          <label>头像 URL（可空）</label>
          <input id="accAddAvatar" placeholder="https://...">
        </div>
        <div class="qq-error" id="accAddErr"></div>
        <div class="qq-actions">
          <button class="qq-btn" id="accAddCancel">取消</button>
          <button class="qq-btn primary" id="accAddOK">确定</button>
        </div>
      </div>
    </div>

    <!-- 编辑我的头像弹窗 -->
    <div class="qq-modal-mask" id="dlgEditSelfAvatar" aria-hidden="true">
      <div class="qq-modal" role="dialog" aria-label="编辑我的头像">
        <div class="title">编辑我的头像</div>
        <div class="qq-field">
          <label>头像 URL</label>
          <input id="selfAvatarUrl" placeholder="https://..." />
        </div>
        <div class="qq-field">
          <label>预览</label>
          <div id="selfAvatarPreview"
              style="width:56px;height:56px;border-radius:50%;
                    background:#eef1f5 center/cover no-repeat;"></div>
        </div>
        <div class="qq-error" id="selfAvatarErr"></div>
        <div class="qq-actions">
          <button class="qq-btn" id="selfAvatarCancel">取消</button>
          <button class="qq-btn primary" id="selfAvatarOK">确认</button>
        </div>
      </div>
    </div>

    <!-- 加好友弹窗 -->
    <div class="qq-modal-mask" id="dlgAddFriend" aria-hidden="true">
      <div class="qq-modal" role="dialog" aria-label="加好友">
        <div class="title">加好友</div>
        <div class="qq-field">
          <label>好友名字</label>
          <input id="frAddName" placeholder="例如：阿土">
        </div>
        <div class="qq-field">
          <label>头像 URL（可空）</label>
          <input id="frAddAvatar" placeholder="https://...">
        </div>
        <div class="qq-error" id="frAddErr"></div>
        <div class="qq-actions">
          <button class="qq-btn" id="frAddCancel">取消</button>
          <button class="qq-btn primary" id="frAddOK">确定</button>
        </div>
      </div>
    </div>

    <!-- 创建群聊弹窗 -->
    <div class="qq-modal-mask" id="dlgCreateGroup" aria-hidden="true">
      <div class="qq-modal" role="dialog" aria-label="创建群聊">
        <div class="title">创建群聊</div>
        <div class="qq-field">
          <label>群聊名</label>
          <input id="grpName" placeholder="比如：我们的快乐老家">
        </div>
        <div class="qq-field">
          <label>群头像 URL（可空）</label>
          <input id="grpAvatar" placeholder="https://">
        </div>
        <div class="qq-field">
          <label>搜索好友</label>
          <input id="grpSearch" placeholder="输入名字筛选">
        </div>
        <div id="grpFriendList"
            style="max-height:200px; overflow:auto; border:1px solid #eef1f5; border-radius:10px; padding:6px; display:flex; flex-direction:column; gap:6px;"
            aria-label="好友列表（可多选）">
        </div>
        <div class="qq-error" id="grpErr"></div>
        <div class="qq-actions">
          <button class="qq-btn" id="grpCancel">取消</button>
          <button class="qq-btn primary" id="grpOK">确定</button>
        </div>
      </div>
    </div>

    <div class="edge" id="edge"></div>

    <!-- 三页 -->
    <div class="pages">
      <div class="track" id="track">
        <!-- 消息 -->
        <section class="page page--chats">
          <header class="topbar">
            <div class="topline">
              <div class="top-left">
                <div class="avatar" id="tbarAvatar" title="打开侧边栏"></div>
                <div class="uinfo">
                  <div class="name">落水的林维</div>
                  <div class="online"><span class="dot"></span><span>iPhone 15 Plus 在线</span></div>
                </div>
              </div>
              <button class="top-btn" aria-label="新建"><i class="fi fi-rr-plus"></i></button>
              <div class="qa-menu" role="menu">
                <button class="qa-item" data-act="create-group"><i class="fi fi-rr-comment-medical"></i><span>创建群聊</span></button>
                <button class="qa-item" data-act="create-channel"><i class="fi fi-rc-hashtag"></i><span>创建频道</span></button>
                <button class="qa-item" data-act="add-friend"><i class="fi fi-rr-user-add"></i><span>加好友</span></button>
                <button class="qa-item" data-act="scan"><i class="fi fi-rr-qr-scan"></i><span>扫一扫</span></button>
                <button class="qa-item" data-act="file"><i class="fi fi-rr-move-to-folder-2"></i><span>传文件</span></button>
                <button class="qa-item" data-act="pay"><i class="fi fi-rr-barcode-scan"></i><span>收付款</span></button>
              </div>
            </div>
          </header>

          <main class="list" aria-label="消息列表">
            <div class="searchbar" role="search">
              <div class="hint"><i class="fi fi-rr-search"></i><span>搜索对话/内容</span></div>
              <input aria-label="搜索对话/内容">
            </div>
            <ul class="items" id="chatList"><!-- 数据订阅后会填充 --></ul>
          </main>
        </section>

        <!-- 联系人 -->
        <section class="page page--contacts">
          <header class="topbar">
            <div class="topline">
              <div class="top-left">
                <div class="avatar" title="打开侧边栏"></div>
                <div class="uinfo"><div class="name">联系人</div></div>
              </div>
              <button class="top-btn" aria-label="添加联系人"><i class="fi fi-rr-user-add"></i></button>
            </div>
          </header>

          <main class="list" aria-label="联系人列表">
            <div class="searchbar" role="search">
              <div class="hint"><i class="fi fi-rr-search"></i><span>搜索联系人/群聊</span></div>
              <input aria-label="搜索联系人/群聊">
            </div>

            <ul class="items" id="ctTop">
              <li class="item">
                <div class="row" style="--action-frac:0">
                  <div class="cell">
                    <div class="meta">
                      <div class="row1"><div class="title">新朋友</div><i class="fi fi-rr-angle-small-right chev"></i></div>
                    </div>
                  </div>
                  <div class="actions" aria-hidden="true"></div>
                </div>
              </li>
              <li class="item">
                <div class="row" style="--action-frac:0">
                  <div class="cell">
                    <div class="meta">
                      <div class="row1"><div class="title">群通知</div><i class="fi fi-rr-angle-small-right chev"></i></div>
                    </div>
                  </div>
                  <div class="actions" aria-hidden="true"></div>
                </div>
              </li>
            </ul>

            <div class="ct-tabs" id="ctTabs" role="tablist">
              <button class="ct-tab" data-type="groups">分组</button>
              <button class="ct-tab active" data-type="friends">好友</button>
              <button class="ct-tab" data-type="groupchats">群聊</button>
              <button class="ct-tab" data-type="channels">频道</button>
              <button class="ct-tab" data-type="bots">机器人</button>
              <button class="ct-tab" data-type="devices">设备</button>
            </div>

            <ul class="items" id="ctContainer"></ul>
          </main>
        </section>

        <!-- 动态 -->
        <section class="page page--feed">
          <header class="topbar">
            <div class="topline">
              <div class="top-left">
                <div class="avatar"></div>
                <div class="uinfo"><div class="name">动态</div></div>
              </div>
              <div class="top-right">
                <button class="top-btn" aria-label="分类"><i class="fi fi-rc-category fi-rr-apps"></i></button>
                <button class="top-btn" aria-label="设置"><i class="fi fi-rc-settings fi-rr-settings"></i></button>
              </div>
            </div>
          </header>

          <main class="list" aria-label="动态列表">
            <div class="searchbar" role="search">
              <div class="hint"><i class="fi fi-rr-search"></i><span>搜索动态入口</span></div>
              <input aria-label="搜索动态入口">
            </div>
            <nav class="func" aria-label="动态入口" id="feedNav">
              <div class="func-item" id="openSpaceEntry">
                <i class="fi fi-rr-stars" style="color:#f2b91e"></i>
                <span class="label">空间动态</span>
                <span class="badge" id="spaceEntryBadge">1</span>
                <i class="fi fi-rr-angle-small-right chev"></i>
              </div>
            </nav>
          </main>
        </section>
      </div>
    </div>

    <nav class="tabbar" id="tabbar" aria-label="底部导航">
      <button class="tab active" data-tab="0" aria-label="消息">
        <span class="icon-wrap">
          <i class="fa-regular fa-comment-dots icon-off"></i>
          <i class="fa-solid   fa-comment-dots icon-on"></i>
        </span>
        <span class="label">消息</span>
        <span class="badge" id="tabBadge">1</span>
      </button>
      <button class="tab" data-tab="1" aria-label="联系人">
        <span class="icon-wrap">
          <i class="fa-regular fa-user icon-off"></i>
          <i class="fa-solid   fa-user icon-on"></i>
        </span>
        <span class="label">联系人</span>
      </button>
      <button class="tab tab--feed" data-tab="2" aria-label="动态">
        <span class="icon-wrap">
          <i class="fi fi-rr-world icon-off"></i>
          <i class="fi fi-sr-world icon-on"></i>
          <span class="badge" id="tabBadgeFeed">1</span>
        </span>
        <span class="label">动态</span>
      </button>
    </nav>
  </div>
    `;

    const $ = s => this.root.querySelector(s);
    const $$ = s => Array.from(this.root.querySelectorAll(s));

    // ===== 通用工具 =====
    const DEFAULT_AVATAR = 'https://files.catbox.moe/pcwffp.jpg';
    const showMask = el => { el?.classList.add('show');  el?.setAttribute('aria-hidden','false'); };
    const hideMask = el => { el?.classList.remove('show'); el?.setAttribute('aria-hidden','true'); };
    const setSelfAvatarEverywhere = (url) => {
      [
        '#avatar',
        '#tbarAvatar',
        '.page--contacts .topbar .avatar',
        '.page--feed .topbar .avatar',
      ].forEach(sel => {
        const el = this.root.querySelector(sel);
        if (el) {
          el.style.background = '#e9eef6';
          el.style.backgroundImage = `url('${url}')`;
          el.style.backgroundPosition = 'center';
          el.style.backgroundSize = 'cover';
          el.style.backgroundRepeat = 'no-repeat';
        }
      });
    };

    const wireOtherUnreadBadge = () => {
  const avatars = [
    this.root.querySelector('#tbarAvatar'),
    this.root.querySelector('.page--contacts .topbar .avatar'),
    this.root.querySelector('.page--feed .topbar .avatar'),
  ].filter(Boolean);

  const ensureDot = (host) => {
    let dot = host.querySelector(':scope > .badge');
    if (!dot) {
      dot = document.createElement('span');
      dot.className = 'badge';
      host.appendChild(dot);
    }
    return dot;
  };

  const dots = avatars.map(ensureDot);

  let othersMsgUnread = false;
  const spaceUnseenMap = new Map(); // login -> boolean（该账号有未浏览动态）
  this._spaceHasUnseen = spaceUnseenMap;

  const anyOtherSpaceUnseen = () => {
    return Array.from(spaceUnseenMap.entries())
      .some(([lg, unseen]) => lg !== this.login && unseen);
  };

  const apply = () => {
    const show = !!(othersMsgUnread || anyOtherSpaceUnseen());
    dots.forEach(dot => dot.classList.toggle('show', show));
  };

  // 订阅“其它登录是否有未读消息”
  this._offOtherUnread?.();
  this._offOtherUnread = RMQQ.Data.subscribeAnyUnreadExceptLogin?.(
    { login: this.login },
    flag => { othersMsgUnread = !!flag; apply(); }
  );

  // 订阅“其它登录的空间”以判断是否有动态未浏览
  // 收集所有登录（当前 + 世界书 + ChatMessage 里的）
  (async () => {
    const qq = RMPhoneToChatMessage.getApp('qq') || { accounts: [] };
    const cmLogins = (Array.isArray(qq.accounts) ? qq.accounts : [])
      .map(a => (a?.login || '').trim()).filter(Boolean);

    let wb = {};
    try { wb = (await RMPhoneToWorldBook.getApp('qq')) || {}; } catch {}
    const wbLoginObj = wb.login && typeof wb.login === 'object' ? wb.login : {};
    const wbLogins = Object.keys(wbLoginObj);

    const set = new Set([this.login, ...cmLogins, ...wbLogins].filter(Boolean));
    const allLogins = Array.from(set);

    // 先清旧的
    this._offSpaceOthers?.forEach(off => { try { off(); } catch {} });
    this._offSpaceOthers = [];

    for (const lg of allLogins) {
      // 给每个账号单独订阅空间
      // 给每个账号单独订阅空间（不用 lastSeen，只要 append 就点亮）
const off = RMQQ.Data.subscribeSpace?.({ login: lg }, e => {
  const ms = Array.isArray(e?.moments) ? e.moments : [];
  const added = e?.type === 'append' && ms.length > 0;
  if (added) spaceUnseenMap.set(lg, true); // 记为未浏览
  apply(); // 更新“其它账号红点”
});
      if (typeof off === 'function') this._offSpaceOthers.push(off);
    }
  })();
};

    // 用当前登录名覆盖界面里的占位名
    const loginName = this.login && String(this.login).trim() ? this.login.trim() : '游客';
    const chatTopName = this.root.querySelector('.page--chats .topbar .top-left .uinfo .name');
    if (chatTopName) chatTopName.textContent = loginName;
    const drawerAccName = this.root.querySelector('.drawer .account .acc-name');
    if (drawerAccName) drawerAccName.textContent = loginName;

    const wrap = $('#qq');
    const track = $('#track');
    const tabs = $$('.tabbar .tab');
    const tabbar = $('#tabbar');
    const drawer = $('#drawer');
    const mask = $('#mask');
    const edge = $('#edge');

    // 让左侧拖拽热区 .edge 从“顶栏底部”开始，避免盖住顶栏头像
    const placeEdgeBelowTopbar = () => {
      const bars = Array.from(this.root.querySelectorAll('.topbar'));
      const topH = bars.reduce((m, el) => Math.max(m, el.getBoundingClientRect().height || 0), 0);
      edge.style.top = `${topH}px`;
    };
    placeEdgeBelowTopbar();
    window.addEventListener('resize', placeEdgeBelowTopbar);
    this._edgeReflow = placeEdgeBelowTopbar;

    const avatar = $('#avatar');
    const tbarAvatar = this.root.querySelector('#tbarAvatar') || this.root.querySelector('.page--chats .avatar');

    // 三页切换
    let current = 0;
    const setTab = (i, animate = true) => {
      current = Math.max(0, Math.min(2, i));
      track.style.transition = animate ? 'transform .28s cubic-bezier(.4,0,.2,1)' : 'none';
      track.style.transform = `translate3d(${-current * 33.3333}%,0,0)`;
      tabs.forEach((t, idx) => t.classList.toggle('active', idx === current));
    };
    setTab(0, false);
    tabs.forEach(btn => {
      let pid = null, sx = 0, sy = 0, moved = false;
      const down = e => { pid = e.pointerId; sx = e.clientX; sy = e.clientY; moved = false; btn.setPointerCapture?.(pid); };
      const move = e => { if (pid == null) return; if (Math.abs(e.clientX - sx) > 6 || Math.abs(e.clientY - sy) > 6) moved = true; };
      const up = e => {
        if (pid != null) { try { btn.releasePointerCapture(pid); } catch {}
        if (!moved) setTab(parseInt(btn.dataset.tab, 10), true);
        pid = null; moved = false; }
      };
      btn.addEventListener('pointerdown', down);
      btn.addEventListener('pointermove', move, { passive: true });
      btn.addEventListener('pointerup', up);
      btn.addEventListener('pointercancel', up);
      btn.addEventListener('lostpointercapture', up);
    });

    // 抽屉开合/拖拽
    let dragging = false, lock = null, pid = null, sx = 0, sy = 0, startFrac = 0, width = 0, progress = 0;
    const getW = () => drawer.getBoundingClientRect().width;
    const renderDrawer = f => {
      progress = Math.max(0, Math.min(1, f));
      const x = -getW() + progress * getW();
      drawer.style.transform = `translateX(${x}px)`;
      mask.style.opacity = progress * 0.6;
      mask.style.pointerEvents = progress > 0 ? 'auto' : 'none';
    };
    const openDrawer = () => {
      drawer.style.transition = 'transform .24s cubic-bezier(.4,0,.2,1)';
      renderDrawer(1);
      setTimeout(() => { drawer.style.transition = 'none'; }, 240);
    };
    const closeDrawer = () => {
      drawer.style.transition = 'transform .24s cubic-bezier(.4,0,.2,1)';
      renderDrawer(0);
      setTimeout(() => { drawer.style.transition = 'none'; }, 240);
    };

    const startDrag = (e, capTarget = edge) => {
      pid = e.pointerId ?? 9999;
      width = getW();
      dragging = true; lock = null;
      sx = e.clientX; sy = e.clientY;
      startFrac = progress;
      drawer.style.transition = 'none';
      mask.style.transition = 'none';
      capTarget && capTarget.setPointerCapture && capTarget.setPointerCapture(pid);
    };
    const moveDrag = e => {
      if (!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      if (lock == null && (Math.abs(dx) > 10 || Math.abs(dy) > 10)) lock = Math.abs(dx) >= Math.abs(dy) ? 'x':'y';
      if (lock === 'y') return;
      if (lock === 'x') {
        e.preventDefault && e.preventDefault();
        const px = Math.max(0, Math.min(width, startFrac * width + dx));
        renderDrawer(px / width);
      }
    };
    const endDrag = e => {
      progress >= 0.5 ? openDrawer() : closeDrawer();
      if (e?.target?.releasePointerCapture) try { e.target.releasePointerCapture(pid); } catch {}
      dragging = false; pid = null; lock = null; mask.style.transition = 'opacity .2s ease';
    };

    const START_ZONE = 56;
    edge.addEventListener('pointerdown', e => {
      const rect = wrap.getBoundingClientRect();
      const y = e.clientY - rect.top;
      const btmH = tabbar.getBoundingClientRect().height || rect.height * 0.07;
      const topH = Math.max(...Array.from(this.root.querySelectorAll('.topbar')).map(b => b.getBoundingClientRect().height || 0),0);
      if (y <= topH) return;
      if (y >= rect.height - btmH) return;
      startDrag(e, edge);
    });
    edge.addEventListener('pointermove', moveDrag);
    edge.addEventListener('pointerup', endDrag);
    edge.addEventListener('pointercancel', endDrag);
    edge.addEventListener('lostpointercapture', endDrag);
    mask.addEventListener('pointerdown', e => startDrag(e, mask));
    mask.addEventListener('pointermove', moveDrag);
    mask.addEventListener('pointerup', endDrag);
    mask.addEventListener('pointercancel', endDrag);
    mask.addEventListener('lostpointercapture', endDrag);
    mask.addEventListener('click', () => closeDrawer());

    drawer.addEventListener('pointerdown', e => {
      const inNoDragArea = e.target.closest('.switch-btn') || e.target.closest('#accSwitch');
      if (inNoDragArea) return;
      const rect = drawer.getBoundingClientRect();
      const isInRightEdge = rect.right - e.clientX <= START_ZONE;
      if (!isInRightEdge) return;
      startDrag(e, drawer);
    });
    drawer.addEventListener('pointermove', moveDrag);
    drawer.addEventListener('pointerup', endDrag);
    drawer.addEventListener('pointercancel', endDrag);
    drawer.addEventListener('lostpointercapture', endDrag);

    // —— 编辑“我的头像”——
    const dlgSelf  = this.root.querySelector('#dlgEditSelfAvatar');
    const iptSelf  = this.root.querySelector('#selfAvatarUrl');
    const prevSelf = this.root.querySelector('#selfAvatarPreview');
    const errSelf  = this.root.querySelector('#selfAvatarErr');
    const okSelf   = this.root.querySelector('#selfAvatarOK');
    const cancelSelf = this.root.querySelector('#selfAvatarCancel');

    const openSelfAvatarDialog = async () => {
      if (!dlgSelf) return;
      if (errSelf) errSelf.textContent = '';
      let url = '';
      try {
        const wb = await RMPhoneToWorldBook.getApp('qq');
        url = wb?.login?.[this.login]?.avatar || '';
      } catch {}
      if (iptSelf)  iptSelf.value = url;
      if (prevSelf) prevSelf.style.backgroundImage = url ? `url('${url}')` : 'none';
      showMask(dlgSelf);
    };
    this.openSelfAvatarDialog = openSelfAvatarDialog;

    iptSelf?.addEventListener('input', () => {
      const u = (iptSelf.value || '').trim();
      if (prevSelf) prevSelf.style.backgroundImage = u ? `url('${u}')` : 'none';
    });
    cancelSelf?.addEventListener('click', () => hideMask(dlgSelf));
    okSelf?.addEventListener('click', async () => {
      const u = (iptSelf?.value || '').trim();
      if (!u) { if (errSelf) errSelf.textContent = '请输入头像 URL'; return; }
      try {
        const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
        wb.login ||= {};
        wb.login[this.login] ||= { avatar: u, contacts: { friends: {}, groups: {} } };
        wb.login[this.login].avatar = u;
        await RMPhoneToWorldBook.saveApp('qq', wb);

        setSelfAvatarEverywhere(u);
        try { this._avatarMap?.set(`${this.login}|__self__`, u); } catch {}
        window.dispatchEvent(new CustomEvent('rmqq:self-avatar-updated', {
          detail: { login: this.login, url: u }
        }));
        hideMask(dlgSelf);
      } catch {
        if (errSelf) errSelf.textContent = '保存失败，请重试';
      }
    });

    avatar.addEventListener('click', openSelfAvatarDialog);
    tbarAvatar?.addEventListener('click', openDrawer);
    this.root.querySelector('.page--contacts .topbar .avatar')?.addEventListener('click', openDrawer);
    this.root.querySelector('.page--feed .topbar .avatar')?.addEventListener('click', openDrawer);
    renderDrawer(0);

    // ====== 搜索条状态 ======
    const markSearchbarState = box => {
      const input = box.querySelector('input');
      const update = () => box.classList.toggle('not-empty', !!input.value.trim());
      input.addEventListener('focus', () => box.classList.add('focused'));
      input.addEventListener('blur', () => box.classList.remove('focused'));
      input.addEventListener('input', update);
      update();
    };
    $$('.searchbar').forEach(markSearchbarState);

    // ====== 列表工具（未读/置顶/角标） ======
    const tabBadge = $('#tabBadge');
    const msgTab = tabs[0];
    const iconWrap = msgTab?.querySelector('.icon-wrap');
    if (tabBadge && iconWrap && tabBadge.parentElement !== iconWrap) {
      iconWrap.appendChild(tabBadge);
    }

// ==== 更稳健的“空间动态”红点逻辑 ====
// 依赖：applySpaceBadges() 用来把 spaceUnseen 显示成红点
const tabBadgeFeed = this.root.querySelector('#tabBadgeFeed');
let spaceUnseen = false;

const applySpaceBadges = () => {
  const tabBadgeFeed    = this.root.querySelector('#tabBadgeFeed');
  const spaceEntryBadge = this.root.querySelector('#spaceEntryBadge');

  tabBadgeFeed?.classList.toggle('show', spaceUnseen);

  // “空间动态”后的红点
  if (spaceEntryBadge) {
    if (spaceUnseen) {
      spaceEntryBadge.textContent = '1';
      spaceEntryBadge.classList.add('show');
      spaceEntryBadge.style.display = '';   // 以防之前有内联 display 残留
    } else {
      spaceEntryBadge.classList.remove('show');
      spaceEntryBadge.style.display = '';
    }
  }
};

// 记录“我最后一次看过”的指纹（按账号保存），以及最近一次回调的快照
const seenFPByLogin = new Map();
const getSeenFP = (lg) => seenFPByLogin.get(lg) || '';
const setSeenFP = (lg, fp) => seenFPByLogin.set(lg, fp);
let lastSnapshot = [];

// 生成指纹：对前 12 条做一个很便宜的 fingerprint
const makeFingerprint = (moments, N = 12) => {
  const head = (Array.isArray(moments) ? moments : []).slice(0, N);
  const parts = [];
  for (const m of head) {
    const its = Array.isArray(m.items) ? m.items : [];
    const len = its.length;
    const firstTs = len ? Number(its[0]?.ts || 0) : 0;
    const lastTs  = len ? Number(its[len - 1]?.ts || 0) : 0;
    parts.push(`${m.lane}|${m.ts}|${len}|${firstTs}|${lastTs}|${m.pending ? 'p' : ''}`);
  }
  return parts.join('~');
};

// 封装：按“当前账号”重新挂载空间未读订阅（切换账号也会用到）
const wireSpaceUnreadForCurrentLogin = () => {
  // 先卸载旧订阅
  this._offSpaceInTabs?.();
  this._offSpaceInTabs = null;

  // 切账号/重挂时，先把本地状态清干净
  lastSnapshot = [];
  spaceUnseen = false;
  applySpaceBadges();

  // 只订阅当前账号
  this._offSpaceInTabs = RMQQ.Data.subscribeSpace?.({ login: this.login }, (e) => {
    const ms = Array.isArray(e?.moments) ? e.moments : [];
    lastSnapshot = ms;

    const fp = makeFingerprint(ms);
    const seen = getSeenFP(this.login);

    // 首次见到这个账号：只记录指纹，不点亮
   if (!seen) { setSeenFP(this.login, fp); return; }

    // 指纹变化 → 点亮当前账号的小红点
    if (fp !== seen) {
      spaceUnseen = true;
     applySpaceBadges();
    }
  });
};

// 首次挂载 TabsView 时，先挂一次当前账号的订阅
wireSpaceUnreadForCurrentLogin();

// 进入“空间动态”页时调用：把“已读指纹”推进到当前快照并清红点
const markSpaceSeen = () => {
  const fp = makeFingerprint(lastSnapshot || []);
  setSeenFP(this.login, fp);   //  针对“当前登录账号”记录已读指纹
  spaceUnseen = false;
  applySpaceBadges();
};
this._markSpaceSeen = markSpaceSeen;

    const LAYOUT = {
      normal: { frac: 0.56, w1: 16 / 56, w2: 24 / 56, w3: 16 / 56 },
      pinned: { frac: 0.64, w1: 24 / 64, w2: 24 / 64, w3: 16 / 64 },
    };

    const updateActionsLayout = li => {
      const row = li.querySelector('.row');
      const actions = li.querySelector('.actions');
      const pinBtn = actions.querySelector('.pin');
      const unreadBtn = actions.querySelector('.unread');
      const pinned = li.dataset.pinned === '1';
      const unread = li.dataset.unread === '1';
      pinBtn.textContent = pinned ? '取消置顶' : '置顶';
      unreadBtn.textContent = unread ? '标为已读' : '标为未读';
      const cfg = pinned ? LAYOUT.pinned : LAYOUT.normal;
      row.style.setProperty('--action-frac', String(cfg.frac));
      row.style.setProperty('--w1', String(cfg.w1));
      row.style.setProperty('--w2', String(cfg.w2));
      row.style.setProperty('--w3', String(cfg.w3));
    };

    const refreshTabBadge = () => {
      const anyUnread = $$('#chatList > .item').some(li => li.dataset.unread === '1');
      if (tabBadge) {
        if (anyUnread) {
          tabBadge.textContent = '1';
          tabBadge.classList.add('show');
        } else {
          tabBadge.classList.remove('show');
        }
      }
    };

    const setPinned = (li, val) => {
      const chatUl = $('#chatList');
      if (!chatUl) return;
      if (val) {
        const pinnedElsExcl = Array.from(chatUl.children).filter(x => x !== li && x.classList?.contains('pinned'));
        const target = pinnedElsExcl[0] || chatUl.firstElementChild;
        chatUl.insertBefore(li, target);
      } else {
        const pinnedElsExcl = Array.from(chatUl.children).filter(x => x !== li && x.classList?.contains('pinned'));
        const lastPinned = pinnedElsExcl[pinnedElsExcl.length - 1];
        if (lastPinned) chatUl.insertBefore(li, lastPinned.nextElementSibling);
        else chatUl.appendChild(li);
      }
      li.dataset.pinned = val ? '1' : '0';
      li.classList.toggle('pinned', !!val);
      updateActionsLayout(li);
    };

    const setUnreadCount = (li, n) => {
      const count = Math.max(0, parseInt(n || 0, 10) || 0);
      li.dataset.unread = count > 0 ? '1' : '0';
      const ava = li.querySelector('.ava');
      let dot = li.querySelector('.ava > .badge');
      if (count > 0) {
        const txt = count > 99 ? '99+' : String(count);
        if (!dot) {
          dot = document.createElement('span');
          dot.className = 'badge show';
          dot.style.pointerEvents = 'none';
          dot.setAttribute('aria-label', `未读 ${txt} 条`);
          dot.textContent = txt;
          ava.appendChild(dot);
        } else {
          dot.textContent = txt;
          dot.classList.add('show');
          dot.setAttribute('aria-label', `未读 ${txt} 条`);
        }
      } else if (dot) {
        dot.classList.remove('show');
      }
      updateActionsLayout(li);
      refreshTabBadge();
    };

    // 记录已展开项
    let openItem = null;
    const closeOpened = (except = null) => {
      if (openItem && openItem !== except) {
        const r = openItem.querySelector('.row');
        const c = openItem.querySelector('.cell');
        r?.style.setProperty('--reveal', '0px');
        if (c) {
          c.style.transition = 'transform .2s cubic-bezier(.4,0,.2,1)';
          c.style.transform = 'translateX(0px)';
        }
        openItem = null;
      }
    };

    const attachSwipe = li => {
      if (!li.dataset.pinned) li.dataset.pinned = '0';
      if (!li.dataset.unread) li.dataset.unread = '0';
      updateActionsLayout(li);

      const row = li.querySelector('.row');
      const cell = li.querySelector('.cell');
      const actions = li.querySelector('.actions');

      const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
      const getReveal = () => parseFloat(row.style.getPropertyValue('--reveal') || '0') || 0;
      const setReveal = px => {
        row.style.setProperty('--reveal', `${px}px`);
        cell.style.transform = `translateX(${-px}px)`;
      };

      const closeWithAnim = () => {
        cell.style.transition = 'transform .2s cubic-bezier(.4,0,.2,1)';
        actions.style.transition = 'transform .2s cubic-bezier(.4,0,.2,1)';
        setReveal(0);
        openItem = null;
      };

      const THRESH = 8, BIAS = 4, TAP_D = 6, TAP_T = 250;

      let pid = null;
      let startX = 0, startY = 0, startReveal = 0;
      let lock = null, moving = false, tapMoved = false, t0 = 0;
      let suppressNextClick = false;

      const maxOpen = () => actions.offsetWidth;

      const onDown = e => {
        if (pid !== null) return;
        closeOpened(li);
        pid = e.pointerId ?? 0;
        startX = e.clientX; startY = e.clientY;
        startReveal = getReveal();
        lock = null; moving = false; tapMoved = false;
        t0 = performance.now();
        cell.style.transition = 'none';
        actions.style.transition = 'none';
        try { cell.setPointerCapture(pid); } catch {}
      };

      const onMove = e => {
        if (pid === null) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        if (!moving) {
          if (Math.abs(dx) > TAP_D || Math.abs(dy) > TAP_D) tapMoved = true;
        }
        if (lock === null) {
          const ax = Math.abs(dx), ay = Math.abs(dy);
          if (ax > THRESH || ay > THRESH) {
            lock = ax > ay + BIAS ? 'x' : 'y';
            moving = true;
          }
        }
        if (lock === 'x') {
          if (e.cancelable) e.preventDefault();
          const want = startReveal - dx;
          const reveal = clamp(want, 0, maxOpen());
          setReveal(reveal);
        }
      };

      const onUpLike = () => {
        if (pid === null) return;
        try { cell.releasePointerCapture(pid); } catch {}
        pid = null;
        cell.style.transition = 'transform .2s cubic-bezier(.4,0,.2,1)';
        actions.style.transition = 'transform .2s cubic-bezier(.4,0,.2,1)';

        const dt = performance.now() - t0;
        if ((lock === null || lock === 'y') && !tapMoved && dt <= TAP_T) {
          if (openItem === li) {
            closeWithAnim();
          } else {
            const title = li.querySelector('.title')?.textContent?.trim() || '';
            const kind = li.dataset.kind === 'group' ? 'group' : 'dm';
            this.onOpenChat?.({ kind, peer: title, login: this.login });
          }
          return;
        }

        if (lock === 'x') {
          const now = getReveal();
          const limit = maxOpen();
          if (now > limit / 2) {
            setReveal(limit);
            openItem = li;
            suppressNextClick = true;
            setTimeout(() => { suppressNextClick = false; }, 260);
          } else {
            closeWithAnim();
            suppressNextClick = true;
            setTimeout(() => { suppressNextClick = false; }, 260);
          }
        }
      };

      cell.addEventListener('pointerdown', onDown);
      cell.addEventListener('pointermove', onMove, { passive: false });
      cell.addEventListener('pointerup', onUpLike);
      cell.addEventListener('pointercancel', onUpLike);
      cell.addEventListener('lostpointercapture', onUpLike);

      li.addEventListener('click', e => {
        if (suppressNextClick) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        if (!e.target.closest('.actions') && openItem === li) {
          closeWithAnim();
        }
      });

      const pinBtn = actions.querySelector('.pin');
      const unreadBtn = actions.querySelector('.unread');
      const delBtn = actions.querySelector('.del');

      pinBtn.addEventListener('click', e => {
        e.preventDefault(); e.stopPropagation();
        const nowPinned = li.dataset.pinned === '1';
        setPinned(li, !nowPinned);
        closeWithAnim();
      });

      unreadBtn.addEventListener('click', e => {
        e.preventDefault(); e.stopPropagation();
        const nowUnread = li.dataset.unread === '1';
        const kind = li.dataset.kind === 'group' ? 'group' : 'dm';
        const peer = li.querySelector('.title')?.textContent?.trim();
        if (nowUnread) {
          RMQQ.Data.markRead?.({ login: this.login, kind, peer });
          setUnreadCount(li, 0);
        } else {
          RMQQ.Data.markUnread?.({ login: this.login, kind, peer, count: 1 });
          setUnreadCount(li, 1);
        }
        closeWithAnim();
      });

      delBtn.addEventListener('click', e => {
        e.preventDefault(); e.stopPropagation();
        if (openItem === li) openItem = null;
        li.remove();
        refreshTabBadge();
      });
    };

    // 暴露给外部使用（Data 或其它地方会来调用）
    if (!this.root.__rmqq) this.root.__rmqq = {};
    this.root.__rmqq.attachSwipe = attachSwipe;
    this.root.__rmqq.refreshTabBadge = refreshTabBadge;

    // resize 同步已展开条目的按钮宽度（保存引用 + 卸载解绑）
    this._onResize = () => {
      const open = this.root.querySelector('#chatList > .item .row[style*="--reveal"]')?.closest('.item') || null;
      const target = open || null;
      if (!target) return;
      const r = target.querySelector('.row');
      const a = target.querySelector('.actions');
      const c = target.querySelector('.cell');
      if (!r || !a || !c) return;
      const w = a.offsetWidth;
      r.style.setProperty('--reveal', `${w}px`);
      c.style.transform = `translateX(${-w}px)`;
    };
    window.addEventListener('resize', this._onResize);

    // ====== 过滤器 ======
    const makeFilter = (container, itemSelector, textGetter) => {
      const items = typeof itemSelector === 'string'
        ? () => Array.from(container.querySelectorAll(itemSelector))
        : itemSelector;
      return kw => {
        const key = String(kw || '').trim().toLowerCase();
        items().forEach(el => {
          const txt = (textGetter ? textGetter(el) : el.textContent).toLowerCase();
          el.style.display = key ? (txt.includes(key) ? '' : 'none') : '';
        });
      };
    };
    const chatFilter = makeFilter(
      this.root,
      '#chatList > .item',
      el => (el.querySelector('.title')?.textContent || '') + ' ' + (el.querySelector('.row2')?.textContent || '')
    );
    this.root.querySelector('.page--chats .searchbar input')?.addEventListener('input', e => {
      chatFilter(e.target.value);
    });

    const ctTabs = $('#ctTabs');
    const ctContainer = $('#ctContainer');

    ctTabs.addEventListener('click', e => {
      const btn = e.target.closest('.ct-tab');
      if (!btn) return;
      const t = btn.dataset.type;
      if (t === 'friends') {
        renderContactsFromWB('friends');
      } else if (t === 'groupchats' || t === 'groups') {
        renderContactsFromWB('groups');
      } else {
        ctContainer.innerHTML = '';
      }
      contactFilter(currentContactKw);
    });

    let currentContactKw = '';
    const contactFilter = kw => {
      currentContactKw = kw || '';
      const f1 = makeFilter($('#ctTop'), '.item', el => el.textContent);
      const f2 = makeFilter(
        $('#ctContainer'),
        '.item',
        el => (el.querySelector('.title')?.textContent || '') + ' ' + (el.querySelector('.row2')?.textContent || '')
      );
      f1(kw); f2(kw);
    };
    this.root.querySelector('.page--contacts .searchbar input')?.addEventListener('input', e => {
      contactFilter(e.target.value);
    });

    // 联系人/群聊项点击后进入聊天
    ctContainer.addEventListener('click', e => {
      const li = e.target.closest('.item');
      if (!li) return;
      const name = li.querySelector('.title')?.textContent?.trim();
      if (!name) return;
      const activeTab = ctTabs.querySelector('.ct-tab.active')?.dataset?.type || 'friends';
      const kind = activeTab === 'groupchats' || activeTab === 'groups' ? 'group' : 'dm';
      this.onOpenChat?.({ kind, peer: name, login: this.login });
    });

    // —— 头像/联系人更新工具 —— //
    const updateAvatarInLists = ({ kind, peer, url }) => {
      const ul1 = this.root.querySelector('.page--chats #chatList');
      if (ul1) {
        const li = Array.from(ul1.children).find(x => x.querySelector('.title')?.textContent?.trim() === peer);
        if (li) {
          const ava = li.querySelector('.ava');
          if (ava) {
            ava.style.backgroundImage = `url('${url}')`;
            ava.style.backgroundPosition = 'center';
            ava.style.backgroundSize = 'cover';
            ava.style.backgroundRepeat = 'no-repeat';
          }
        }
      }
      const li2 = Array.from(ctContainer.querySelectorAll('.item')).find(
        x => x.querySelector('.title')?.textContent?.trim() === peer
      );
      if (li2) {
        const ava2 = li2.querySelector('.ava');
        if (ava2) {
          ava2.style.backgroundImage = `url('${url}')`;
          ava2.style.backgroundPosition = 'center';
          ava2.style.backgroundSize = 'cover';
          ava2.style.backgroundRepeat = 'no-repeat';
        }
      }
    };

    // 监听 ChatView 发出的头像更新事件
    const onPeerAvatarUpdated = e => {
      const d = e.detail || {};
      if (!d.login || d.login !== this.login) return;
      if (d.kind !== 'dm') return;
      this._avatarMap?.set(`${this.login}|dm|${d.peer}`, d.avatar);
      updateAvatarInLists({ kind: 'dm', peer: d.peer, url: d.avatar });
    };
    window.addEventListener('rmqq:peer-avatar-updated', onPeerAvatarUpdated, { passive: true });
    this._onPeerAvatarUpdated = onPeerAvatarUpdated;

    // 监听 ChatView 的“删除聊天/好友/群聊”
    const onChatDeleted = async e => {
      const d = e.detail || {};
      if (!d.login || d.login !== this.login) return;
      try {
        const { wb, amap } = await syncWBFromDataAndBuildAvatarMap(this.login);
        this._wbQQ = wb;
        this._avatarMap = amap;
      } catch {}
      const ul = this.root.querySelector('.page--chats #chatList');
      if (ul) {
        const li = Array.from(ul.children).find(x => {
          const name = x.querySelector('.title')?.textContent?.trim();
          const isGroup = x.dataset.kind === 'group';
          return name === d.peer && (d.kind === 'group' ? isGroup : !isGroup);
        });
        li?.remove();
        this.root.__rmqq?.refreshTabBadge?.();
      }
      typeof renderContactsFromWB === 'function' && renderContactsFromWB(d.kind === 'group' ? 'groups' : 'friends');
    };
    window.addEventListener('rmqq:chat-deleted', onChatDeleted, { passive: true });
    this._onChatDeleted = onChatDeleted;

    // 动态入口
    $('#openSpaceEntry')?.addEventListener('click', () => {
      try { this._markSpaceSeen?.(); } catch {}
      this.onOpenSpace?.(this.login);
    });

    /* ================== 顶栏“+”菜单 + 加好友/建群 ================== */
    (() => {
      const chatsTopbar = this.root.querySelector('.page--chats .topbar');
      const addBtn = this.root.querySelector('.page--chats .topbar .topline .top-btn');
      if (chatsTopbar && addBtn) {
        const qaMenu = this.root.querySelector('.page--chats .qa-menu');
        const showMenu = () => {
          qaMenu.classList.add('show');
          addBtn.setAttribute('aria-expanded', 'true');
          this.root.addEventListener('pointerdown', onOutside, true);
          this.root.querySelector('.page--chats .list')?.addEventListener('scroll', hideMenu, { passive: true });
        };
        const hideMenu = () => {
          qaMenu.classList.remove('show');
          addBtn.setAttribute('aria-expanded', 'false');
          this.root.removeEventListener('pointerdown', onOutside, true);
          this.root.querySelector('.page--chats .list')?.removeEventListener('scroll', hideMenu);
        };
        const onOutside = e => {
          if (qaMenu.contains(e.target) || e.target === addBtn || e.target.closest('.top-btn') === addBtn) return;
          hideMenu();
        };
        const onToggle = e => {
          e.stopPropagation();
          qaMenu.classList.contains('show') ? hideMenu() : showMenu();
        };
        addBtn.addEventListener('click', onToggle);

        // 联系人页右上角“加好友”按钮
        const ctAddBtn = this.root.querySelector('.page--contacts .topbar .topline .top-btn');
        if (ctAddBtn) {
          ctAddBtn.addEventListener('click', () => openAddFriendDialog());
        }

        // ===== 加好友弹窗脚本 =====
        const dlgFr = this.root.querySelector('#dlgAddFriend');
        const frName = this.root.querySelector('#frAddName');
        const frAva = this.root.querySelector('#frAddAvatar');
        const frErr = this.root.querySelector('#frAddErr');
        const frOK = this.root.querySelector('#frAddOK');
        const frCancel = this.root.querySelector('#frAddCancel');

        const openAddFriendDialog = () => {
          frErr.textContent = '';
          frName.value = '';
          frAva.value = '';
          showMask(dlgFr);
        };

        const doAddFriend = async () => {
          const name = (frName.value || '').trim();
          const url = (frAva.value || '').trim();
          if (!name) { frErr.textContent = '请输入好友名字'; return; }

          const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
          wb.login ||= {};
          wb.login[this.login] ||= { avatar: DEFAULT_AVATAR, contacts: { friends: {}, groups: {} } };
          wb.login[this.login].contacts ||= { friends: {}, groups: {} };
          wb.login[this.login].contacts.friends[name] = { avatar: url || DEFAULT_AVATAR };
          await RMPhoneToWorldBook.saveApp('qq', wb);
          this._wbQQ = wb;

          this._avatarMap.set(`${this.login}|dm|${name}`, url || DEFAULT_AVATAR);
          refreshContactsAll();
          appendGhostChatRow({ peer: name, kind: 'dm' });

          hideMask(dlgFr);
        };

        frCancel?.addEventListener('click', () => hideMask(dlgFr));
        frOK?.addEventListener('click', doAddFriend);
        this.root.addEventListener('keydown', e => { if (e.key === 'Escape') hideMask(dlgFr); });

        // ===== 创建群聊弹窗 =====
        const dlgGrp = this.root.querySelector('#dlgCreateGroup');
        const iptGrpName = this.root.querySelector('#grpName');
        const iptGrpAva = this.root.querySelector('#grpAvatar');
        const iptGrpSearch = this.root.querySelector('#grpSearch');
        const boxGrpList = this.root.querySelector('#grpFriendList');
        const txtGrpErr = this.root.querySelector('#grpErr');
        const btnGrpOK = this.root.querySelector('#grpOK');
        const btnGrpCancel = this.root.querySelector('#grpCancel');

        function makePickItem({ name, avatar }) {
          const li = document.createElement('div');
          li.className = 'grp-item';
          li.dataset.name = name;
          li.style.cssText =
            'display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;cursor:pointer;';
          li.innerHTML = `
            <i class="fi fi-rr-check-circle tick" style="font-size:18px;color:#9aa3ad;"></i>
            <div class="ava" style="width:28px;height:28px;border-radius:999px;background:#e9eef6 center/cover no-repeat;"></div>
            <div class="name" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
          `;
          li.querySelector('.name').textContent = name;
          const ava = li.querySelector('.ava');
          ava.style.backgroundImage = `url('${avatar || DEFAULT_AVATAR}')`;
          const toggle = () => {
            const picked = li.classList.toggle('selected');
            li.querySelector('.tick').style.color = picked ? '#2b84ff' : '#9aa3ad';
          };
          li.addEventListener('click', toggle);
          return li;
        }

        const renderGroupFriends = async () => {
          boxGrpList.innerHTML = '';
          try {
            const wb = await RMPhoneToWorldBook.getApp('qq');
            const node = wb?.login?.[this.login];
            const friends = Object.entries(node?.contacts?.friends || {}).map(([n, meta]) => ({
              name: n, avatar: meta?.avatar || DEFAULT_AVATAR
            }));
            if (!friends.length) {
              boxGrpList.innerHTML = `<div style="color:#6b7280;padding:8px;">还没有好友哦</div>`;
              return;
            }
            friends.forEach(f => boxGrpList.appendChild(makePickItem(f)));
            iptGrpSearch?.addEventListener('input', e => {
              const key = String(e.target.value || '').trim().toLowerCase();
              Array.from(boxGrpList.children).forEach(el => {
                const ok = el.dataset.name.toLowerCase().includes(key);
                el.style.display = ok ? '' : 'none';
              });
            }, { passive: true });
          } catch (e) {
            console.error('[创建群聊] 好友列表读取失败：', e);
            boxGrpList.innerHTML = `<div style="color:#ef4444;padding:8px;">好友列表读取失败</div>`;
          }
        };

        const openCreateGroupDialog = async () => {
          txtGrpErr.textContent = '';
          iptGrpName.value = '';
          iptGrpAva.value = '';
          iptGrpSearch.value = '';
          await renderGroupFriends();
          showMask(dlgGrp);
        };

        btnGrpCancel?.addEventListener('click', () => hideMask(dlgGrp));
        btnGrpOK?.addEventListener('click', async () => {
          const name = (iptGrpName.value || '').trim();
          if (!name) { txtGrpErr.textContent = '请填写群聊名'; return; }

          const picks = Array.from(boxGrpList.querySelectorAll('.grp-item.selected'))
            .map(el => el.dataset.name).filter(Boolean);
          if (!picks.length) { txtGrpErr.textContent = '至少选择 1 位好友'; return; }

          const avatar = (iptGrpAva.value || '').trim() || DEFAULT_AVATAR;

          const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
          wb.login ||= {};
          wb.login[this.login] ||= { avatar: DEFAULT_AVATAR, contacts: { friends: {}, groups: {} } };
          wb.login[this.login].contacts ||= { friends: {}, groups: {} };
          const meta = (wb.login[this.login].contacts.groups[name] ||= {});
          meta.avatar = avatar;
          meta.members = [this.login, ...picks];
          await RMPhoneToWorldBook.saveApp('qq', wb);
          this._wbQQ = wb;
          this._avatarMap?.set?.(`${this.login}|group|${name}`, avatar);

          const content = `${this.login}、${picks.join('、')}在群聊${name}中。`;
          await RMPhoneToWorldBook.createQQGroupEntry?.(name, content);

          refreshContactsAll();
          appendGhostChatRow({ peer: name, kind: 'group' });
          hideMask(dlgGrp);
        });

        this._qa = { addBtn, onToggle, onOutside, hideMenu, qaMenu };
        // 菜单项点击
        qaMenu.addEventListener('click', e => {
          const btn = e.target.closest('.qa-item');
          if (!btn) return;
          const act = btn.dataset.act || '';
          hideMenu();
          if (act === 'create-group') openCreateGroupDialog();
          else if (act === 'add-friend') openAddFriendDialog();
        });
      }
    })();

    /* ====== WB 同步 + 头像映射（工具） ====== */
    function deepMerge(base, patch) {
      if (!base || typeof base !== 'object') return JSON.parse(JSON.stringify(patch || {}));
      const out = Array.isArray(base) ? base.slice() : { ...base };
      if (patch && typeof patch === 'object') {
        for (const [k, v] of Object.entries(patch)) {
          if (Array.isArray(v)) {
            if (k === 'members') {
              const cur = Array.isArray(out[k]) ? out[k] : [];
              out[k] = Array.from(new Set([...cur, ...v]));
            } else {
              out[k] = v;
            }
          } else if (v && typeof v === 'object') {
            out[k] = deepMerge(out[k] || {}, v);
          } else {
            if (out[k] === undefined) out[k] = v;
          }
        }
      }
      return out;
    }

    const syncWBFromDataAndBuildAvatarMap = async loginName => {
      RMQQ.Data.init?.();
      const state = RMQQ.Data.getState(); // QQ 分区
      const wbQQ = (await RMPhoneToWorldBook.getApp('qq')) || {};
      const patch = { login: {} };

      const accounts = Array.isArray(state.accounts) ? state.accounts : [];

        for (const acc of accounts) {
          const login = String(acc?.login || '').trim();
          if (!login) continue;
          const node = (patch.login[login] ||= { avatar: DEFAULT_AVATAR, contacts: { friends: {}, groups: {} } });

          for (const s of acc.sessions || []) {
            const peer = String(s?.peer || '').trim();
            if (!peer) continue;
            if (s.kind === 'group') {
              const g = (node.contacts.groups[peer] ||= { avatar: DEFAULT_AVATAR });
              const speakers = new Set(
                Array.isArray(s.items) ? s.items.map(it => String(it?.speaker || '').trim()).filter(Boolean) : []
              );
              speakers.add(login);
              const mem = new Set(Array.isArray(g.members) ? g.members : []);
              for (const name of speakers) mem.add(name);
              g.members = Array.from(mem);
              for (const name of speakers) {
                if (name && name !== login) node.contacts.friends[name] ||= { avatar: DEFAULT_AVATAR };
              }
            } else {
              node.contacts.friends[peer] ||= { avatar: DEFAULT_AVATAR };
            }
          }
        }

      const merged = Object.keys(patch.login).length ? deepMerge(wbQQ, patch) : wbQQ;
      if (Object.keys(patch.login).length) {
        await RMPhoneToWorldBook.saveApp('qq', merged);
      }

      const amap = new Map();
      for (const [login, info] of Object.entries(merged.login || {})) {
        amap.set(`${login}|__self__`, info.avatar || DEFAULT_AVATAR);
        for (const [n, o] of Object.entries(info.contacts?.friends || {})) {
          amap.set(`${login}|dm|${n}`, o?.avatar || DEFAULT_AVATAR);
        }
        for (const [n, o] of Object.entries(info.contacts?.groups || {})) {
          amap.set(`${login}|group|${n}`, o?.avatar || DEFAULT_AVATAR);
        }
      }
      return { wb: merged, amap };
    };

    // ===== 联系人渲染 =====
    const renderContactsFromWB = (which = 'friends') => {
      const loginNode = this._wbQQ?.login?.[this.login];
      const store = loginNode?.contacts || { friends: {}, groups: {} };
      const ctContainer = this.root.querySelector('#ctContainer');
      if (!ctContainer) return;

      const ctTabs = this.root.querySelector('#ctTabs');
      if (ctTabs) {
        ctTabs.querySelectorAll('.ct-tab').forEach(b => b.classList.remove('active'));
        const key = which === 'groups' ? 'groupchats' : 'friends';
        ctTabs.querySelector(`.ct-tab[data-type="${key}"]`)?.classList.add('active');
      }

      const listObj = which === 'groups' ? store.groups || {} : store.friends || {};
      const entries = Object.entries(listObj);

      if (!entries.length) { ctContainer.innerHTML = ''; return; }

      ctContainer.innerHTML = entries.map(([name, meta]) => {
        const url = meta && meta.avatar ? meta.avatar : DEFAULT_AVATAR;
        return `
          <li class="item">
            <div class="row" style="--action-frac:0">
              <div class="cell">
                <div class="ava" style="background:#e9eef6; background-image:url('${url}'); background-position:center; background-size:cover; background-repeat:no-repeat;"></div>
                <div class="meta">
                  <div class="row1"><div class="title">${name}</div></div>
                  <div class="row2">${which === 'groups' ? '群聊' : '好友'}</div>
                </div>
              </div>
              <div class="actions" aria-hidden="true"></div>
            </div>
          </li>`;
      }).join('');
    };

    // A. 一次刷“好友+群聊”
    const refreshContactsAll = () => {
      renderContactsFromWB('friends');
      renderContactsFromWB('groups');
    };

    // B. “空对话”占位
    const appendGhostChatRow = ({ peer, kind }) => {
      const ul = this.root.querySelector('.page--chats #chatList');
      if (!ul || !peer) return;
      const exists = Array.from(ul.children).some(li => li.querySelector('.title')?.textContent?.trim() === peer);
      if (exists) return;
      const li = makeChatRow(peer, kind, kind === 'group' ? '群聊' : '好友');
      li.dataset.ghost = '1';
      li.classList.add('ghost');
      li.querySelector('.time')?.replaceChildren(document.createTextNode('刚刚'));
      ul.prepend(li);
      this.root.__rmqq?.attachSwipe?.(li);
      this.root.__rmqq?.refreshTabBadge?.();
    };

    // C. 首次见到“新会话”时，同步世界书 + 刷联系人（轻微防抖）
    let _wbSyncTimer = null;
    const syncWBAndRefreshContacts = () => {
      clearTimeout(_wbSyncTimer);
      _wbSyncTimer = setTimeout(async () => {
        try {
          const { wb, amap } = await syncWBFromDataAndBuildAvatarMap(this.login);
          this._wbQQ = wb;
          this._avatarMap = amap;
          refreshContactsAll();
        } catch {}
      }, 120);
    };

    // 造一行（只保留这一份）
    const makeChatRow = (title, kind, preview) => {
      const li = document.createElement('li');
      li.className = 'item';
      if (kind === 'group') li.dataset.kind = 'group';
      li.innerHTML = `
        <div class="row" style="--action-frac:.56">
          <div class="cell">
            <div class="ava"></div>
            <div class="meta">
              <div class="row1"><div class="title"></div><time class="time">刚刚</time></div>
              <div class="row2"></div>
            </div>
          </div>
          <div class="actions">
            <button class="action pin">置顶</button>
            <button class="action unread">标为未读</button>
            <button class="action del">删除</button>
          </div>
        </div>`;
      li.querySelector('.title').textContent = title || '';
      li.querySelector('.row2').textContent = preview || (kind === 'group' ? '群聊' : '好友');
      const ava = li.querySelector('.ava');
      if (ava) {
        const key = `${this.login}|${kind === 'group' ? 'group' : 'dm'}|${title || ''}`;
        const url = this._avatarMap?.get(key) || DEFAULT_AVATAR;
        ava.style.background = '#e9eef6';
        ava.style.backgroundImage = `url('${url}')`;
        ava.style.backgroundPosition = 'center';
        ava.style.backgroundSize = 'cover';
        ava.style.backgroundRepeat = 'no-repeat';
      }
      return li;
    };

    // 最近一条 time 消息设时间
    const setTimeFromLastTimeMsg = (li, kind, peer) => {
      try {
        const sess = RMQQ.Data.findSession?.(this.login, kind, peer);
        const arr = Array.isArray(sess?.items) ? sess.items : [];
        for (let i = arr.length - 1; i >= 0; i--) {
          const it = arr[i];
          if (it && it.type === 'time') {
            const v = String((Array.isArray(it.args) && it.args[0]) || it.content || '');
            li.querySelector('.time').textContent = v;
            return;
          }
        }
      } catch {}
    };

    // ===== 统一的 tabs 订阅函数 =====
    const startTabsSubscription = () => {
      const ul = this.root.querySelector('.page--chats #chatList');
      if (!ul) return () => {};

      this._unsubTabs?.();
      this._unsubTabs = RMQQ.Data.subscribeTabsSummaries({ login: this.login }, e => {
        if (e.type === 'init') {
          ul.innerHTML = '';
          for (const s of e.summaries) {
            const li = makeChatRow(s.peer, s.kind, s.preview || (s.kind === 'group' ? '群聊' : '好友'));
            ul.appendChild(li);
            setTimeFromLastTimeMsg(li, s.kind, s.peer);
            setUnreadCount(li, s.unreadCount || 0);
          }
          const binder = this.root.__rmqq?.attachSwipe;
          if (typeof binder === 'function') {
            ul.querySelectorAll('.item').forEach(li => {
              if (!li.__rmqqBound) { binder(li); li.__rmqqBound = true; }
            });
          }
          this.root.__rmqq?.refreshTabBadge?.();

          (async () => {
            const { wb, amap } = await syncWBFromDataAndBuildAvatarMap(this.login);
            this._wbQQ = wb;
            this._avatarMap = amap;

            // 用最新头像表补一次头像
            try {
              ul.querySelectorAll('.item').forEach(li => {
                const title = li.querySelector('.title')?.textContent?.trim();
                const kind = li.dataset?.kind === 'group' ? 'group' : 'dm';
                if (!title) return;
                const key = `${this.login}|${kind}|${title}`;
                const url = this._avatarMap?.get(key) || DEFAULT_AVATAR;
                const ava = li.querySelector('.ava');
                if (ava) {
                  ava.style.background = '#e9eef6';
                  ava.style.backgroundImage = `url('${url}')`;
                  ava.style.backgroundPosition = 'center';
                  ava.style.backgroundSize = 'cover';
                  ava.style.backgroundRepeat = 'no-repeat';
                }
              });
            } catch {}
            refreshContactsAll();
          })();
        } else if (e.type === 'patch') {
          // 移除同名占位
          const ghost = Array.from(ul.children).find(x =>
            x.dataset.ghost === '1' && x.querySelector('.title')?.textContent?.trim() === e.summary.peer
          );
          ghost?.remove();

          let li = Array.from(ul.children).find(
            x => x.querySelector('.title')?.textContent?.trim() === e.summary.peer
          );

          if (!li) {
            li = makeChatRow(
              e.summary.peer,
              e.summary.kind,
              e.summary.preview || (e.summary.kind === 'group' ? '群聊' : '好友'),
            );
            ul.appendChild(li);
            syncWBAndRefreshContacts();
            setUnreadCount(li, (e.summary && e.summary.unreadCount) || 0);

            const key0 = `${this.login}|${e.summary.kind === 'group' ? 'group' : 'dm'}|${e.summary.peer}`;
            const url0 = this._avatarMap?.get(key0) || DEFAULT_AVATAR;
            const ava0 = li.querySelector('.ava');
            if (ava0) {
              ava0.style.background = '#e9eef6';
              ava0.style.backgroundImage = `url('${url0}')`;
              ava0.style.backgroundPosition = 'center';
              ava0.style.backgroundSize = 'cover';
              ava0.style.backgroundRepeat = 'no-repeat';
            }

            const binder = this.root.__rmqq?.attachSwipe;
            if (typeof binder === 'function') {
              if (!li.__rmqqBound) { binder(li); li.__rmqqBound = true; }
            }
          } else {
            li.querySelector('.row2').textContent = e.summary.preview || '';
            const t = li.querySelector('.time');
            if (t) setTimeFromLastTimeMsg(li, e.summary.kind, e.summary.peer);
          }
          setUnreadCount(li, (e.summary && e.summary.unreadCount) || 0);

          this.root.__rmqq?.refreshTabBadge?.();

          (async () => {
            const { wb, amap } = await syncWBFromDataAndBuildAvatarMap(this.login);
            this._wbQQ = wb;
            this._avatarMap = amap;

            try {
              if (this.kind === 'group' && this.peerName === e.summary.peer) {
                const body = this.root.querySelector('#cvSetBody');
                if (body) body.innerHTML = renderGroup();
              }
            } catch {}

            const key = `${this.login}|${e.summary.kind === 'group' ? 'group' : 'dm'}|${e.summary.peer}`;
            const url = this._avatarMap?.get(key) || DEFAULT_AVATAR;
            const li2 = Array.from(ul.children).find(
              x => x.querySelector('.title')?.textContent?.trim() === e.summary.peer
            );
            const ava = li2?.querySelector('.ava');
            if (ava) {
              ava.style.background = '#e9eef6';
              ava.style.backgroundImage = `url('${url}')`;
              ava.style.backgroundPosition = 'center';
              ava.style.backgroundSize = 'cover';
              ava.style.backgroundRepeat = 'no-repeat';
            }
            refreshContactsAll();
          })();
        } else if (e.type === 'remove') {
          const li = Array.from(ul.children).find(
            x => x.querySelector('.title')?.textContent?.trim() === e.summary.peer
          );
          if (li) li.remove();
          this.root.__rmqq?.refreshTabBadge?.();
          refreshContactsAll();
        }
      });

      return this._unsubTabs;
    };

    // ===== 切换账号（弹窗 + 逻辑） =====
    (() => {
      const switchBtn = this.root.querySelector('.switch-btn');
      const accSwitch = this.root.querySelector('#accSwitch');
      const accList = this.root.querySelector('#accSwitchList');
      const accNewBtn = this.root.querySelector('#accSwitchNew');
      const drawerScroll = this.root.querySelector('.drawer-scroll');

      // 添加账号弹窗
      const dlgAcc = this.root.querySelector('#dlgAddAccount');
      const accName = this.root.querySelector('#accAddName');
      const accAva = this.root.querySelector('#accAddAvatar');
      const accErr = this.root.querySelector('#accAddErr');
      const accOK = this.root.querySelector('#accAddOK');
      const accCancel = this.root.querySelector('#accAddCancel');

      const renderAccList = async () => {
        const qq = RMPhoneToChatMessage.getApp('qq') || { accounts: [] };
        const cmLogins = (Array.isArray(qq.accounts) ? qq.accounts : [])
          .map(a => ((a && a.login) || '').trim()).filter(Boolean);

        let wb = {};
        try { wb = (await RMPhoneToWorldBook.getApp('qq')) || {}; } catch {}
        const wbLoginObj = wb.login && typeof wb.login === 'object' ? wb.login : {};
        const wbLogins = Object.keys(wbLoginObj);

        const set = new Set([this.login, ...cmLogins, ...wbLogins].filter(Boolean));
        const allLogins = Array.from(set);

        const html = allLogins.map(login => {
          const a1 = this._avatarMap?.get(`${login}|__self__`);
          const a2 = wbLoginObj?.[login]?.avatar;
          const avatar = a1 || a2 || DEFAULT_AVATAR;
          const loginUnread = RMQQ.Data.getLoginUnreadTotal?.(login) || 0;
          const active = login === this.login;
          const hasDot = (loginUnread > 0) || !!this._spaceHasUnseen?.get(login);
          return `
            <button class="acc-item ${active ? 'active' : ''}" data-login="${login}">
              <div class="head" style="background-image:url('${avatar}')">${hasDot?'<span class="badge show" aria-label="未读"></span>':''}</div>
              <div class="name">${login}</div>
              <i class="fi fi-rr-check check" aria-label="当前账号"></i>
            </button>`;
        }).join('') || `<div style="padding:10px; color:#6b7280; font-size:12px;">暂无账号</div>`;

        accList.innerHTML = html;
      };

      const showAcc = async e => {
        e?.stopPropagation?.();
        await renderAccList();
        accSwitch.classList.add('show');
        accSwitch.setAttribute('aria-hidden', 'false');
        this.root.addEventListener('pointerdown', onOutside, true);
        drawerScroll?.addEventListener('scroll', hideAcc, { passive: true, once: true });
      };
      const hideAcc = () => {
        accSwitch.classList.remove('show');
        accSwitch.setAttribute('aria-hidden', 'true');
        this.root.removeEventListener('pointerdown', onOutside, true);
      };
      const onOutside = e => {
        if (accSwitch.contains(e.target)) return;
        if (switchBtn.contains(e.target)) return;
        hideAcc();
      };
      const onToggle = e => {
        accSwitch.classList.contains('show') ? hideAcc() : void showAcc(e);
      };

      // 真·切换账号
      const switchLogin = async sel => {
        if (!sel || sel === this.login) { hideAcc(); return; }
        this.login = sel;

        // 顶栏名字 / 抽屉名字
        const chatTopName = this.root.querySelector('.page--chats .topbar .top-left .uinfo .name');
        const drawerAccName = this.root.querySelector('.drawer .account .acc-name');
        if (chatTopName) chatTopName.textContent = sel;
        if (drawerAccName) drawerAccName.textContent = sel;

        // 同步 WB + 头像映射
        const { wb, amap } = await syncWBFromDataAndBuildAvatarMap(this.login);
        this._wbQQ = wb;
        this._avatarMap = amap;

        // 顶栏/抽屉头像
        const selfUrl = this._avatarMap.get(`${this.login}|__self__`) || DEFAULT_AVATAR;
        setSelfAvatarEverywhere(selfUrl);
        wireOtherUnreadBadge();

        // 刷联系人
        refreshContactsAll();

        wireSpaceUnreadForCurrentLogin(); 

        // 重新订阅 tabs
        startTabsSubscription();

        this.onLoginChanged?.(this.login);

        hideAcc();
      };

      const onListClick = e => {
        const btn = e.target.closest('.acc-item');
        if (!btn) return;
        const sel = btn.dataset.login || '';
        accList.querySelectorAll('.acc-item').forEach(x => x.classList.toggle('active', x === btn));
        switchLogin(sel);
      };

      // “登录新账户” → 打开弹窗
      const onNewClick = () => {
        accErr.textContent = '';
        accName.value = '';
        accAva.value = '';
        showMask(dlgAcc);
        hideAcc();
      };

      // 弹窗：添加账号
      const doAddAccount = async () => {
        const name = (accName.value || '').trim();
        const url = (accAva.value || '').trim();
        if (!name) { accErr.textContent = '请输入名字'; return; }

        const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
        wb.login ||= {};
        wb.login[name] ||= { avatar: url || DEFAULT_AVATAR, contacts: { friends: {}, groups: {} } };
        if (url) wb.login[name].avatar = url;
        await RMPhoneToWorldBook.saveApp('qq', wb);

        const { wb: wb2, amap } = await syncWBFromDataAndBuildAvatarMap(this.login);
        this._wbQQ = wb2;
        this._avatarMap = amap;
        await renderAccList();
        hideMask(dlgAcc);
      };

      const onEsc = e => {
        if (e.key === 'Escape') {
          hideAcc();
          hideMask(dlgAcc);
        }
      };

      switchBtn?.addEventListener('click', onToggle);
      switchBtn?.addEventListener('pointerdown', e => e.stopPropagation());
      switchBtn?.addEventListener('touchstart', e => e.stopPropagation(), { passive: true });
      accList?.addEventListener('click', onListClick);
      accNewBtn?.addEventListener('click', onNewClick);
      this.root.addEventListener('keydown', onEsc);
      accCancel?.addEventListener('click', () => hideMask(dlgAcc));
      accOK?.addEventListener('click', doAddAccount);

      // 暴露到实例，供注销后切换
      this._accSwitch = { switchLogin, refreshFromWB: renderAccList, hideAcc, onToggle, onListClick, onNewClick, onEsc, switchBtn, accList, accNewBtn };
    })();

    // —— 设置（左下角）小菜单 + 注销账号 —— //
    (() => {
      const btnSettings = this.root.querySelector('#btnSettings');
      const setMenu = this.root.querySelector('#setMenu');
      const btnLogout = this.root.querySelector('#btnLogout');
      const drawerScroll = this.root.querySelector('.drawer-scroll');

      const showSet = e => {
        e?.stopPropagation?.();
        setMenu.classList.add('show');
        setMenu.setAttribute('aria-hidden','false');
        this.root.addEventListener('pointerdown', onOutside, true);
        drawerScroll?.addEventListener('scroll', hideSet, { passive:true, once:true });
      };
      const hideSet = () => {
        setMenu.classList.remove('show');
        setMenu.setAttribute('aria-hidden','true');
        this.root.removeEventListener('pointerdown', onOutside, true);
      };
      const onOutside = e => {
        if (setMenu.contains(e.target)) return;
        if (btnSettings.contains(e.target)) return;
        hideSet();
      };
      const onToggle = e => {
        setMenu.classList.contains('show') ? hideSet() : void showSet(e);
      };

      btnSettings?.addEventListener('click', onToggle);
      btnSettings?.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') onToggle(e);
      });

      const doLogout = async () => {
        try {
          const login = this.login || '';
          if (!login) return;

          const app = RMPhoneToChatMessage.getApp('qq') || (RMPhoneToChatMessage.apps.qq = { accounts: [] });
          if (Array.isArray(app.accounts)) {
            const i = app.accounts.findIndex(a => a && a.login === login);
            if (i >= 0) app.accounts.splice(i, 1);
          }
          try { await RMQQ?.Data?.commit?.({ immediate: true }); } catch {}

          try {
            const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
            if (wb.login && wb.login[login]) {
              delete wb.login[login];
              await RMPhoneToWorldBook.saveApp('qq', wb);
            }
          } catch {}

          hideSet();

          const cmNext = RMPhoneToChatMessage.getApp('qq')?.accounts?.find(a => a?.login && a.login !== login)?.login || null;
          let wbNext = null; try { const wb2 = (await RMPhoneToWorldBook.getApp('qq').catch(()=>({}))) || {}; const keys = Object.keys(wb2.login||{}).filter(x => x !== login); wbNext = keys[0] || null; } catch {}
          const next = cmNext || wbNext;
          if (next) {
            await this._accSwitch?.switchLogin?.(next);
          } else {
            this.onLoginChanged?.(null);
          }
        } catch {}
      };

      btnLogout?.addEventListener('click', doLogout);
    })();

    // ===== 初始化：先同步 WB/头像 → 灌头像 → 联系人 → 订阅 tabs → 其他未读红点 =====
    (async () => {
      const { wb, amap } = await syncWBFromDataAndBuildAvatarMap(this.login);
      this._wbQQ = wb;
      this._avatarMap = amap;

      const selfUrl = this._avatarMap.get(`${this.login}|__self__`) || DEFAULT_AVATAR;
      setSelfAvatarEverywhere(selfUrl);

      const ctType = this.root.querySelector('#ctTabs .ct-tab.active')?.dataset.type;
      renderContactsFromWB(ctType === 'groupchats' ? 'groups' : 'friends');

      startTabsSubscription();
      wireOtherUnreadBadge();

      // 给已存在的消息项补头像（理论上此时为空，但为兼容保留）
      this.root.querySelectorAll('#chatList > .item').forEach(li => {
        const kind = li.dataset.kind === 'group' ? 'group' : 'dm';
        const title = li.querySelector('.title')?.textContent?.trim() || '';
        const key = `${this.login}|${kind}|${title}`;
        const url = this._avatarMap.get(key) || DEFAULT_AVATAR;
        const ava = li.querySelector('.ava');
        if (ava) {
          ava.style.background = '#e9eef6';
          ava.style.backgroundImage = `url('${url}')`;
          ava.style.backgroundPosition = 'center';
          ava.style.backgroundSize = 'cover';
          ava.style.backgroundRepeat = 'no-repeat';
        }
      });

      // 刷一次账号切换列表
      await this._accSwitch?.refreshFromWB?.();
    })();
  }

  onShow() { /* 根屏显现 */ }
  onHide() { /* 根屏被遮，keepAlive=true，啥都不做 */ }

  unmount() {
    this._unsubTabs?.();
    this._unsubTabs = null;

    this._offOtherUnread?.();
    this._offOtherUnread = null;

    if (this._onResize) {
      window.removeEventListener('resize', this._onResize);
      this._onResize = null;
    }

    if (this._qa) {
      this._qa.addBtn?.removeEventListener('click', this._qa.onToggle);
      this.root?.removeEventListener?.('pointerdown', this._qa.onOutside, true);
      this._qa.hideMenu?.();
      this._qa.qaMenu?.remove?.();
      this._qa = null;
    }

    if (this._accSwitch) {
      const { switchBtn, accList, accNewBtn, onToggle, onListClick, onNewClick, onEsc, hideAcc } = this._accSwitch;
      try { hideAcc?.(); } catch {}
      switchBtn?.removeEventListener('click', onToggle);
      accList?.removeEventListener('click', onListClick);
      accNewBtn?.removeEventListener('click', onNewClick);
      this.root?.removeEventListener?.('keydown', onEsc);
      this._accSwitch = null;
    }

    if (this._edgeReflow) {
      window.removeEventListener('resize', this._edgeReflow);
      this._edgeReflow = null;
    }

    if (this._onPeerAvatarUpdated) {
      window.removeEventListener('rmqq:peer-avatar-updated', this._onPeerAvatarUpdated, { passive: true });
      this._onPeerAvatarUpdated = null;
    }

    if (this._onChatDeleted) {
      window.removeEventListener('rmqq:chat-deleted', this._onChatDeleted, { passive: true });
      this._onChatDeleted = null;
    }

    this.root = null;
  }
}


/**
 * 类：ChatView（聊天页）
 * 作用：展示/发送消息，联动未读统计，支持滚动到底/新消息插入等
 *
 * 公开特性：
 *   - key = 'chat'，keepAlive = false
 *   - 构造参数：{ login, kind='dm'|'group', peerName, onBack, leftAvatar?, rightAvatar? }
 *
 * 内部做的事（核心点）：
 *   - 订阅 Data.subscribeChat({login, kind, peer}, cb)
 *       · e.type==='init'：首屏渲染所有消息
 *       · e.type==='append'：增量渲染新消息（随后滚动到底）
 *   - 发送输入：把“我发的消息”交给 Data.pushMsg，再由 Data 触发增量渲染
 *   - 顶部未读提示：可订阅登录账号的未读总数（同账号其它会话）
 *   - 返回按钮：调用 onBack()，由外壳（ScreenManager）处理导航
 *
 * 联动：
 *   - 读/写都走 Data（ChatView 不碰持久化；Data 视情况 commit）
 *
 * 注意点：
 *   - 渲染消息时区分系统提示/左泡/右泡，所有文本用 textContent
 *   - 插入图片/表情时注意 CORS 与懒加载
 */

        class ChatView {
  constructor({ login, kind = 'dm', peerName = '聊天', onBack, leftAvatar = null, rightAvatar = null } = {}) {
    this.key = 'chat';
    this.keepAlive = false;
    this.login = login;         // 当前账号
    this.kind = kind;           // 'dm' | 'group'
    this.peerName = peerName;
    this.onBack = onBack;
    this.leftAvatar = leftAvatar;
    this.rightAvatar = rightAvatar;

    this.root = null;
    this._handlers = [];
    this._offHdrUnread = null;  // 顶部“其它会话未读总数”订阅

    // 运行时缓存
    this._wbQQ = null;          // 世界书 qq app 节点
    this._friendMap = {};       // 好友映射：用于群聊渲染头像
    this._unsubChat = null;     // 取消订阅
    this._avatarMap = new Map();// 可选：缓存 (login|kind|peer)→avatar
  }

  mount(container) {
    this.root = container;
    this.root.innerHTML = `
<link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
  crossorigin="anonymous" referrerpolicy="no-referrer">
<style>
  .chat-wrap{
    --accent:#0099ff;
    --bg:#f2f4f7;
    --line:#e8ecf2;
    --topbot-alpha:.82;         /* 顶/底栏透明度 */
    --island-clearance:10%;
    position:absolute; inset:0; display:flex; flex-direction:column; background:var(--bg); color:#111;
    font:12px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    -webkit-user-select:none; user-select:none;
  }
  .chat-wrap *{ -webkit-tap-highlight-color: transparent; }

  /* 顶部栏 */
  .chat-topbar{
    position:sticky; top:0; z-index:5;
    background:rgba(242,244,247,var(--topbot-alpha));
    backdrop-filter:saturate(160%) blur(10px);
    border-bottom:1px solid var(--line);
    padding: calc(env(safe-area-inset-top, 0px) + var(--island-clearance)) 8px 6px;
    display:flex; align-items:center; justify-content:space-between; gap:8px;
  }
  .chat-left{ display:flex; align-items:center; min-width:0; }
  .chat-back{
    width:24px; height:24px; border:0; background:transparent; border-radius:8px;
    display:grid; place-items:center; flex:0 0 auto;
  }
  .chat-back i{ font-size:16px; transform:translateX(-0.3em); }
  .chat-back:active{ background:rgba(0,0,0,.06); }
  .chat-center{ display:flex; flex-direction:column; min-width:0; }
  .chat-name{ font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .chat-status{ font-size:10.5px; color:#6b7280; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .cv-hdr-unread{
    margin:0 6px 0 0;
    min-width:16px; height:16px;
    border-radius:999px;
    background:#ff3b30; color:#fff;
    font-size:10px; line-height:16px;
    padding:0 4px;
    display:none; align-items:center; justify-content:center;
  }
  .cv-hdr-unread.show{ display:inline-flex; }
  .chat-right .chat-more{
    font-size:16px; width:28px; height:28px; border:0; background:transparent; border-radius:8px; display:grid; place-items:center;
  }
  .chat-right .chat-more:active{ background:rgba(0,0,0,.06); }

  /* 消息列表 */
  .chat-main{ flex:1; overflow:auto; padding:10px 10px 12px; background:transparent; }
  .chat-main::-webkit-scrollbar{ width:0; height:0; }

  /* 行、头像、气泡 */
  .cv-row{ width:100%; margin:6px 0; display:flex; align-items:flex-start; gap:6px; }
  .cv-row--left{ justify-content:flex-start; }
  .cv-row--right{ justify-content:flex-end; }

  .cv-txt{
    --fz:13px; --lh:1.35; --vpad:8px;
    max-width:76%;
    padding: calc(var(--vpad) * var(--cv-msg-scale,1)) 10px;
    line-height: var(--lh);
    font-size: calc(var(--fz) * var(--cv-msg-scale,1));
    border-radius:12px;
    word-break:break-word;
  }
  .cv-row--left  .cv-txt{ background:#fff; color:#111; border:1px solid #eef1f5; }
  .cv-row--right .cv-txt{ background:var(--accent); color:#fff; }

  /* 群聊：名字标签 + 包裹 */
  .cv-name{ font-size:11px; color:#6b7280; margin:0 0 2px 6px; }
  .cv-wrap{ display:flex; flex-direction:column; align-items:flex-start; max-width:100%; flex:1 1 auto; min-width:0; }

  .chat-ava{
    width: calc((2*var(--vpad,8px) + var(--fz,13px)*var(--lh,1.35)) * var(--cv-ava-scale,1));
    height: calc((2*var(--vpad,8px) + var(--fz,13px)*var(--lh,1.35)) * var(--cv-ava-scale,1));
    border-radius:999px; flex:0 0 auto;
    background:#dfe3ea center/cover no-repeat;
  }

  /* ===== 表情包 ===== */
  .cv-bqb{ max-width:40%; border-radius:12px; overflow:hidden; padding:0; border:0; background:transparent; }
  .cv-bqb img{ display:block; width:100%; height:auto; object-fit:contain; -webkit-user-drag:none; user-select:none; }

  /* ===== 语音 ===== */
  .cv-voice-wrap{ display:flex; flex-direction:column; gap:4px; max-width:76%; }
  .cv-row--left  .cv-voice-wrap{ align-items:flex-start; }
  .cv-row--right .cv-voice-wrap{ align-items:flex-end; }
  .cv-voice{
    display:flex; align-items:center; gap:6px;
    padding:8px 10px; border-radius:12px;
    box-sizing:border-box; white-space:nowrap; cursor:pointer; user-select:none;
    max-width:100%;
  }
  .cv-voice i{ font-size:14px; transform:translateY(1px); opacity:.9; }
  .cv-voice::after{
    content: attr(data-dur) "''";
    display:inline-block;
    flex:0 0 auto;
    line-height:1; font-weight:600; letter-spacing:.2px;
  }
  .cv-row--left  .cv-voice{ background:#fff; color:#111; border:1px solid #eef1f5; }
  .cv-row--right .cv-voice{ background:var(--accent); color:#fff; }
  .cv-voice-text{ max-width:100%; }
  .cv-hidden{ display:none !important; }

  /* ===== dmt ===== */
  .cv-dmt{
    position:relative; overflow:hidden; border-radius:12px;
    border:1px solid #eef1f5; background:#eceff3;
    width: clamp(200px, 66%, 320px);
    max-width:76%;
    min-height:140px;
    cursor:pointer; user-select:none;
  }
  .cv-dmt-mask{
    position:absolute; inset:0; background:#e5e9f0;
    display:grid; place-items:center; color:#6b7280; font-size:22px;
    transition: opacity .18s ease;
  }
  .cv-dmt.is-open .cv-dmt-mask{ opacity:0; pointer-events:none; }
  .cv-dmt-text{
    position:absolute; inset:0; padding:10px 12px; box-sizing:border-box;
    color:#111; background:transparent; overflow:auto; opacity:0; transition:opacity .18s ease;
    scrollbar-width:none; -ms-overflow-style:none;
  }
  .cv-dmt-text::-webkit-scrollbar{ width:0; height:0; display:none; }
  .cv-dmt.is-open .cv-dmt-text{ opacity:1; }

  /* ===== 文件 ===== */
  .cv-file{
    display:flex; align-items:center; gap:10px;
    background:#fff; color:#111;
    border:1px solid #eef1f5;
    border-radius:12px;
    padding:10px 10px 10px 12px;
    max-width:76%;
    width: clamp(200px, 66%, 320px);
    box-sizing:border-box;
    user-select:none; cursor:pointer;
  }
  .cv-file:active{ transform:scale(.995); }
  .cv-file-info{ flex:1; min-width:0; }
  .cv-file-name{ font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .cv-file-meta{ margin-top:2px; font-size:11.5px; color:#6b7280; }
  .cv-file-ico{ flex:0 0 auto; width:44px; height:44px; border-radius:12px; background:#0069cd; display:grid; place-items:center; }
  .cv-file-ico i{ color:#fff; font-size:20px; line-height:1; }

  /* ===== 转账 ===== */
  .cv-xfr{
    background:#fff; border:1px solid #eef1f5; border-radius:12px; overflow:hidden;
    width:clamp(200px,66%,320px); max-width:76%;
    user-select:none; cursor:pointer;
  }
  .cv-xfr:active{ transform:scale(.995); }
  .cv-xfr .xfr-top{
    display:flex; align-items:center; gap:8px;
    padding:8px 12px;
    background:#2b84ff; color:#fff;
  }
  .cv-xfr .xfr-ico{ width:auto; height:auto; border:0; border-radius:0; display:grid; place-items:center; }
  .cv-xfr .xfr-ico i{ color:#fff; font-size:26px; line-height:1; transform: translateY(2px); }
  .cv-xfr .xfr-txt{ flex:1; min-width:0; }
  .cv-xfr .line1{ display:flex; align-items:baseline; gap:4px; line-height:1.15; font-size:16px; letter-spacing:.2px; }
  .cv-xfr .line1 .yen{ opacity:.95; }
  .cv-xfr .line2{ font-size:10px; opacity:.95; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .cv-xfr .xfr-bottom{ background:#fff; color:#6b7280; padding:2px 12px; font-size:10px; }

  /* ===== 定位 ===== */
  .cv-loc{ background:#fff; border:1px solid #eef1f5; border-radius:12px; overflow:hidden; max-width:66%; }
  .cv-loc-head{ background:#fff; padding:10px 12px; font-size:13px; font-weight:600; color:#111; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .cv-loc-map{ position:relative; background:#f2f4f7; }
  .cv-loc-map img{ display:block; width:100%; height:auto; }
  .cv-loc-map i{
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%);
    font-size:24px; color:#9aa3ad;
  }

/* ===== 说说转发（mmtshare） ===== */
.cv-mmtshare{ background:#fff; border:1px solid var(--line); border-radius:14px; overflow:hidden; max-width:66%; }
.cv-mmtshare .row{ display:flex; align-items:center; gap:6px; padding:6px 8px; }

/* ↓ 头/尾行：整体文字缩小 */
.cv-mmtshare .row.head,
.cv-mmtshare .row.tail{ font-size:11px; color:#6b7280; }

/* ↓ 图标也缩小，并向下挪一点点 */
.cv-mmtshare .row.head i,
.cv-mmtshare .row.tail i{
  font-size:13px;
  line-height:1;
  transform: translateY(2px);
}

/* 保持原有颜色 */
.cv-mmtshare .row.head i{ color:#16a34a; }
.cv-mmtshare .row.tail i{ color:#f59e0b; }
.cv-mmtshare .txt{ padding:2px 8px 8px; font-size:14px; color:#111; white-space:pre-wrap; word-break:break-all; }
.cv-mmtshare .media{ padding:0 8px 8px; }
/* 如果有配图：固定成 4:5（宽:高）并裁切居中 */
.cv-mmtshare .media img{
  width:100%;
  display:block;
  border-radius:10px;
  aspect-ratio: 5 / 4;   /* ★ 新增 */
  object-fit: cover;     /* ★ 新增 */
}

  /* 底部输入区 */
  .chat-bottom{
    position:relative;
    background:rgba(242,244,247,var(--topbot-alpha));
    border-top:1px solid var(--line);
    backdrop-filter:saturate(160%) blur(10px);
    padding:6px 8px calc(env(safe-area-inset-bottom, 0px) + var(--pad) * 1);
  }
  .cv-input-row{ display:flex; gap:8px; align-items:center; margin-bottom:2px; }
  .cv-input{ flex:1; height:34px; border:1px solid #eef1f5; border-radius:10px; padding:0 10px; outline:none; font-size:13px; background:#fff; color:#111; }
  .cv-send{ border:0; padding:0 12px; height:34px; border-radius:10px; background:var(--accent); color:#fff; font-weight:700; font-size:12px; }

  .cv-tools{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:2px 2px 0; }
  .cv-tool-btn{ border:0; background:transparent; padding:6px; border-radius:10px; outline:none; }
  .cv-tool-btn img{ width:22px; height:22px; display:block; }

  /* plus 展开区 */
  .cv-expand{ height:0; overflow:hidden; background:rgba(242,244,247,var(--topbot-alpha)); transition:height .22s cubic-bezier(.4,0,.2,1); }
  .cv-expand.show{ height: var(--cv-expand-h, 40vh); border-top:1px solid var(--line); margin-top:6px; }
  .cv-panel{ height:100%; margin:10px 6px 0; background:transparent; border:0; border-radius:14px; box-shadow:none; overflow:hidden; display:flex; }
  .cv-panel .body{ flex:1; overflow:auto; padding:12px; scrollbar-width:none; -ms-overflow-style:none; }
  .cv-panel .body::-webkit-scrollbar{ width:0; height:0; display:none; }
  .cv-expand-scroll{ height:100%; overflow-y:auto; padding:10px 6px calc(env(safe-area-inset-bottom,0px) + 28px); scrollbar-width:none; -ms-overflow-style:none; }
  .cv-expand-scroll::-webkit-scrollbar{ width:0; height:0; display:none; }
  .cv-ext-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
  .cv-ext-item{ display:flex; flex-direction:column; align-items:center;gap:2px; background:transparent; padding:0; text-align:center; border:0; }
  .cv-ext-item .box{ width:100%; aspect-ratio:1; background:#fff; border:1px solid var(--line); border-radius:12px; display:grid; place-items:center; }
  .cv-ext-item .box img{ width: 100%; height: 100%; object-fit: contain; display: block; }
  .cv-ext-item.add .box{ background: transparent; border: 1px dashed var(--line); }
  .cv-ext-item.add .box i{ opacity: .6; }
  .cv-ext-item i{ font-size:20px; color:#666; transform: translateY(0.1em);}
  .cv-ext-item .label{ font-size:10px; color:#666;}

  /* 触发生成：范围菜单 */
  .gen-menu{
    position:absolute; right:8px; bottom:58px; z-index:20;
    background:#fff; border:1px solid var(--line); border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,.08);
    transform: translateY(6px) scale(.98);
    opacity:0; visibility:hidden;
    transition: transform .18s cubic-bezier(.4,0,.2,1), opacity .18s, visibility .18s steps(1,end);
  }
  .gen-menu.show{ transform: translateY(0) scale(1); opacity:1; visibility:visible; }
  .gen-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; font-size:13px; border:0; background:transparent; width:180px; text-align:left; }
  .gen-item:active{ background:#f6f7fa; }
  .gen-mark{ margin-left:auto; color:#2b84ff; visibility:hidden; }
  .gen-item.checked .gen-mark{ visibility:visible; }

  .cv-empty{ color:#9aa3ad; text-align:center; margin:12px 0; font-size:12px; }

  /* 兜底进入动效 */
  .chat-fallback-enter-from{
    transform:translate3d(24px,0,0); opacity:.001;
    transition: transform .28s cubic-bezier(.4,0,.2,1), opacity .28s cubic-bezier(.4,0,.2,1);
  }
  .chat-fallback-enter-to{ transform:translate3d(0,0,0); opacity:1; }

  /* ============ 设置子页面（覆盖在 ChatView 内） ============ */
  .cvset{
    position:absolute; inset:0; z-index:6; display:flex; flex-direction:column;
    background:var(--bg); transform: translate3d(100%,0,0);
    transition: transform .28s cubic-bezier(.4,0,.2,1); pointer-events:none; will-change: transform;
  }
  .cvset.show{ transform: translate3d(0,0,0); pointer-events:auto; }
  .cvset-top{
    position:sticky; top:0; z-index:2; background:rgba(255,255,255,.96); border-bottom:1px solid var(--line);
    backdrop-filter:saturate(160%) blur(10px);
    padding: calc(env(safe-area-inset-top, 0px) + var(--island-clearance)) 8px 6px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .cvset-back{ width:28px; height:28px; border:0; background:transparent; border-radius:8px; display:grid; place-items:center; }
  .cvset-back:active{ background:rgba(0,0,0,.06); }
  .cvset-title{ font-weight:700; font-size:14px; margin-left:2px; }
  .cvset-body{ flex:1; overflow:auto; padding:10px; }
  .cvset-body::-webkit-scrollbar{ width:0; height:0; }

  .cvset-card{ background:#fff; border:1px solid var(--line); border-radius:14px; overflow:hidden; margin-bottom:10px; }
  .cvset-row{ display:flex; align-items:center; gap:10px; padding:12px; font-size:13px; color:#111; }
  .cvset-row + .cvset-row{ border-top:1px solid #f0f2f5; }
  .cvset-row .label{ flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .cvset-row .sub{ font-size:11px; color:#6b7280; }
  .cvset-row .chev{ color:#9aa3ad; }
  .cvset-row.center{ justify-content:center; gap:0; }
  .cvset-danger{ color:#ff4d4f; font-weight:700; }
  .cvset-plus{ background:#eef1f5; color:#6b7280; display:grid; place-items:center; }
  .cvset-plus i{ font-size:28px; transform:translateY(0.08em);}
  .cvset-avatar{ width:44px; height:44px; border-radius:999px; background:#e9eef6 center/cover no-repeat; flex:0 0 auto; }
  .cvset-name{ font-weight:700; }

  /* 开关 */
  .cvset-switch{ -webkit-appearance:none; appearance:none; width:44px; height:24px; border-radius:999px; background:#e5e7eb; border:1px solid #e5e7eb; position:relative; cursor:pointer; outline:none; flex:0 0 auto; transition: background .18s, border-color .18s; }
  .cvset-switch::after{ content:''; position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:999px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.12); transition: transform .18s; }
  .cvset-switch:checked{ background:#2b84ff; border-color:#2b84ff; }
  .cvset-switch:checked::after{ transform:translateX(20px); }

  /* 群成员 */
  .cvset-grid{ display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:10px 8px; padding:10px 10px 12px; }
  .cvset-mem{ display:flex; flex-direction:column; align-items:center; gap:6px; }
  .cvset-mem .head{ width:42px; height:42px; border-radius:999px; background:#eef2f7 center/cover no-repeat; }
  .cvset-mem .name{ font-size:11px; max-width:56px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#374151; }
  .cvset-invite .head{ display:grid; place-items:center; font-size:28px; color:#6b7280; }
  .cvset-invite i{ transform:translateY(0.08em);}

  /* —— 通用弹窗 —— */
  .cv-modal-mask{ position:absolute; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:99; }
  .cv-modal-mask.show{ display:flex; }
  .cv-modal{ width:86%; max-width:340px; background:#fff; border:1px solid #e8ecf2; border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.2); padding:12px; color:#111; }
  .cv-modal .title{ font-weight:700; font-size:14px; margin-bottom:8px; }
  .cv-field{ display:flex; flex-direction:column; gap:6px; margin:8px 0; }
  .cv-field label{ font-size:12px; color:#6b7280; }
  .cv-field input{ height:32px; border:1px solid #eef1f5; border-radius:8px; padding:0 10px; outline:none; font-size:13px; background:#fff; color:#111; }
  .cv-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
  .cv-btn{ border:1px solid #e8ecf2; background:#fff; border-radius:10px; padding:6px 10px; font-size:12px; }
  .cv-btn.primary{ background:#2b84ff; color:#fff; border-color:#2b84ff; }
  .cv-error{ color:#ff4d4f; font-size:12px; min-height:1.2em; }
  .cv-preview{ width:56px; height:56px; border-radius:999px; background:#e9eef6 center/cover no-repeat; border:1px solid #eef1f5; }

  /* 群聊消息：宽度控制外移到 wrap */
  .cv-row--left .cv-wrap { max-width: 76%; }
  .cv-wrap .cv-txt,
  .cv-wrap .cv-voice-wrap,
  .cv-wrap .cv-dmt,
  .cv-wrap .cv-file,
  .cv-wrap .cv-xfr,
  .cv-wrap .cv-loc,
  .cv-wrap .cv-mmtshare{ max-width:100%; }
  .cv-wrap .cv-bqb { max-width: 52%; }
</style>

<div class="chat-wrap" role="dialog" aria-label="聊天窗口">
  <!-- 顶部栏 -->
  <header class="chat-topbar">
    <div class="chat-left">
      <button class="chat-back" aria-label="返回"><i class="fa-solid fa-angle-left"></i></button>
      <div class="cv-hdr-unread" id="cvHdrUnread" aria-label="其他会话未读"></div>
      <div class="chat-center">
        <div class="chat-name" id="chatTitle">${this.peerName}</div>
        <div class="chat-status" id="chatStatus">多人在线</div>
      </div>
    </div>
    <div class="chat-right">
      <button class="chat-more" aria-label="更多"><i class="fi fi-rr-menu-burger"></i></button>
    </div>
  </header>

  <!-- 消息区 -->
  <main class="chat-main" id="cvMain">
    <div class="cv-empty">（示例）与「${this.peerName}」的聊天开始了</div>
  </main>

  <!-- 底部栏 -->
  <footer class="chat-bottom">
    <div class="cv-input-row">
      <input id="cvInput" class="cv-input" placeholder="发个消息…" />
      <button id="cvSend" class="cv-send">发送</button>
    </div>
    <div class="cv-tools" id="cvTools" aria-label="快捷工具">
      <button class="cv-tool-btn" data-key="micro"><img alt="microphone" src="https://i.postimg.cc/dVM9xnDD/micro1.png"></button>
      <button class="cv-tool-btn" data-key="image"><img alt="image" src="https://i.postimg.cc/VvdF3Vj0/image1.png"></button>
      <button class="cv-tool-btn" data-key="camera"><img alt="camera" src="https://i.postimg.cc/sDbnRsHj/camera1.png"></button>
      <button class="cv-tool-btn" data-key="hongbao"><img alt="redpack" src="https://i.postimg.cc/RZfgSy2c/hongbao1.png"></button>
      <button class="cv-tool-btn" data-key="emoji"><img alt="emoji" src="https://i.postimg.cc/cHDmkS8N/emoji1.png"></button>
      <button class="cv-tool-btn" data-key="plus"><img alt="plus" src="https://i.postimg.cc/Bv4Bq6T0/plus1.png"></button>
    </div>
    <div class="cv-expand" id="cvExpand" aria-hidden="true">
      <div class="cv-panel" id="cvPanel" role="region" aria-label="展开区内容"></div>
    </div>
  </footer>

  <!-- 触发生成：范围菜单 -->
  <div id="genMenu" class="gen-menu" aria-hidden="true">
    <button class="gen-item" data-scope="all">触发生成（全部会话）<span class="gen-mark">✔︎</span></button>
    <button class="gen-item" data-scope="current">触发生成（仅本会话）<span class="gen-mark">✔︎</span></button>
  </div>

  <!-- 设置子页面 -->
  <section class="cvset" id="cvSet" aria-label="聊天设置" aria-hidden="true">
    <div class="cvset-top">
      <button class="cvset-back" aria-label="返回"><i class="fa-solid fa-angle-left"></i></button>
      <div class="cvset-title" id="cvSetTitle">${this.kind === 'group' ? '群聊设置' : '聊天设置'}</div>
      <div style="width:28px;height:28px;"></div>
    </div>
    <div class="cvset-body" id="cvSetBody"><!-- 动态填充 --></div>
  </section>

  <!-- 设置对方头像 -->
  <div class="cv-modal-mask" id="dlgPeerAvatar" aria-hidden="true">
    <div class="cv-modal" role="dialog" aria-label="设置角色头像">
      <div class="title">设置角色头像</div>
      <div class="cv-field"><label>联系人名字（不可编辑）</label><input id="peerNameFixed" disabled></div>
      <div class="cv-field"><label>头像 URL</label><input id="peerAvatarUrl" placeholder="https://..."></div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="cv-preview" id="peerAvatarPreview"></div>
        <div class="cv-error" id="peerAvatarErr"></div>
      </div>
      <div class="cv-actions"><button class="cv-btn" id="peerAvatarCancel">取消</button><button class="cv-btn primary" id="peerAvatarOK">确定</button></div>
    </div>
  </div>

  <!-- 设置当前聊天背景 -->
  <div class="cv-modal-mask" id="dlgChatBg" aria-hidden="true">
    <div class="cv-modal" role="dialog" aria-label="设置聊天背景">
      <div class="title">设置当前聊天背景</div>
      <div class="cv-field"><label>背景图 URL</label><input id="chatBgUrl" placeholder="https://..."></div>
      <div class="cv-error" id="chatBgErr"></div>
      <div class="cv-actions"><button class="cv-btn" id="chatBgCancel">取消</button><button class="cv-btn primary" id="chatBgOK">确定</button></div>
    </div>
  </div>

  <!-- 设置聊天缩放（全局） -->
  <div class="cv-modal-mask" id="dlgChatScale" aria-hidden="true">
    <div class="cv-modal" role="dialog" aria-label="设置聊天缩放">
      <div class="title">设置聊天缩放（全局）</div>
      <div class="cv-field"><label>消息大小</label><input id="chatScaleMsg" type="range" min="0.8" max="1.6" step="0.05"></div>
      <div class="cv-field"><label>头像大小</label><input id="chatScaleAva" type="range" min="0.8" max="1.6" step="0.05"></div>
      <div id="chatScaleDemo" style="display:flex;align-items:flex-end;gap:8px;margin:10px 2px;">
        <div class="chat-ava" style="background-image:url('https://files.catbox.moe/pcwffp.jpg');"></div>
        <div class="cv-txt">示例：你好！</div>
      </div>
      <div class="cv-actions"><button class="cv-btn" id="chatScaleCancel">取消</button><button class="cv-btn primary" id="chatScaleOK">确定</button></div>
    </div>
  </div>

  <!-- 确认：清空聊天/删除/解散 -->
  <div class="cv-modal-mask" id="dlgConfirmClear" aria-hidden="true">
    <div class="cv-modal" role="dialog" aria-label="确认删除聊天记录">
      <div class="title">确认操作</div>
      <div class="cv-field"><div id="confirmClearText">你确认删除所有聊天记录吗？</div></div>
      <div class="cv-actions"><button class="cv-btn" id="confirmClearCancel">取消</button><button class="cv-btn primary" id="confirmClearOK">确定</button></div>
    </div>
  </div>

  <div class="cv-modal-mask" id="dlgConfirmDelete" aria-hidden="true">
    <div class="cv-modal" role="dialog" aria-label="确认删除联系人或解散群聊">
      <div class="title">确认操作</div>
      <div class="cv-field"><div id="confirmDeleteText">你确认删除好友/解散群聊（同时清空聊天记录）吗？</div></div>
      <div class="cv-actions"><button class="cv-btn" id="confirmDeleteCancel">取消</button><button class="cv-btn primary" id="confirmDeleteOK">确定</button></div>
    </div>
  </div>

  <!-- 邀请加入群聊 -->
  <div class="cv-modal-mask" id="dlgInviteToGroup" aria-hidden="true">
    <div class="cv-modal" role="dialog" aria-label="邀请加入群聊">
      <div class="title">选择要邀请的好友</div>
      <div class="cv-field"><label>搜索好友</label><input id="invSearch" placeholder="输入名字过滤"></div>
      <div id="invFriendList" style="max-height:220px; overflow:auto; border:1px solid #eef1f5; border-radius:8px; padding:6px;"></div>
      <div class="cv-error" id="invErr"></div>
      <div class="cv-actions"><button class="cv-btn" id="invCancel">取消</button><button class="cv-btn primary" id="invOK">确认</button></div>
    </div>
  </div>

  <!-- 生成返回值解析失败 -->
  <div class="cv-modal-mask" id="dlgGenError" aria-hidden="true">
    <div class="cv-modal" role="alertdialog" aria-label="返回值解析失败">
      <div class="title">返回值解析失败</div>
      <div class="cv-field"><textarea id="genErrorText" readonly style="height:160px; width:100%; box-sizing:border-box;"></textarea></div>
      <div class="cv-actions"><button class="cv-btn" id="genErrorCopy">复制</button><button class="cv-btn primary" id="genErrorOK">确认</button></div>
    </div>
  </div>
</div>
`;

    // ---------- DOM 快捷 ----------
    const $ = sel => this.root.querySelector(sel);
    const main  = $('#cvMain');
    const input = $('#cvInput');
    const send  = $('#cvSend');
    const tools = $('#cvTools');
    const expand= $('#cvExpand');
    const panel = $('#cvPanel');
    const chatStatus = $('#chatStatus');

    // 禁止底部工具栏里的 img 被拖动
    this.root.querySelectorAll('.cv-tool-btn img').forEach(img => {
      img.setAttribute('draggable', 'false');
      img.addEventListener('dragstart', e => e.preventDefault());
    });
    tools.addEventListener('dragstart', e => { if (e.target && e.target.tagName === 'IMG') e.preventDefault(); });

    // ---------- 小工具 & 常量（集中去重） ----------
    const FALLBACK_AVATAR = 'https://files.catbox.moe/pcwffp.jpg';
    const CATBOX = 'https://files.catbox.moe/';
    const isFullUrl = s => /^https?:\/\//i.test(String(s || ''));
    const normCatboxUrl = s => (s ? (isFullUrl(s) ? s : CATBOX + s) : '');
    const setBgImage = (el, url) => {
      if (!el) return;
      el.style.backgroundImage = `url('${url}')`;
      el.style.backgroundPosition = 'center';
      el.style.backgroundSize = 'cover';
      el.style.backgroundRepeat = 'no-repeat';
    };
    const showMask = el => { el?.classList.add('show'); el?.setAttribute('aria-hidden','false'); };
    const hideMask = el => { el?.classList.remove('show'); el?.setAttribute('aria-hidden','true'); };
    const notifyChatDeleted = (detail) => {
      window.dispatchEvent(new CustomEvent('rmqq:chat-deleted', { detail }));
    };
    const applyChatBg = (url) => {
      const wrap = this.root.querySelector('.chat-wrap');
      if (!wrap) return;
      if (url) setBgImage(wrap, url); else wrap.style.removeProperty('background-image');
    };
    const scrollToBottom = () => { main.scrollTop = main.scrollHeight + 999; };
    const keepAtBottomIfUserWasThere = (anchorEl) => {
      const nearBottom = main.scrollHeight - main.scrollTop - main.clientHeight < 4;
      requestAnimationFrame(() => {
        if (nearBottom) main.scrollTop = main.scrollHeight;
        else anchorEl?.scrollIntoView({ block: 'nearest' });
      });
    };

    // ---------- 头像：优先传入 → 世界书回填 ----------
    let selfAvatar = this.rightAvatar || '';
    let peerAvatar = this.leftAvatar  || '';
    (async () => {
      try {
        const wb = await RMPhoneToWorldBook.getApp('qq');
        const node = wb?.login?.[this.login];
        this._wbQQ = wb;
        this._friendMap = node?.contacts?.friends || {};

        selfAvatar = selfAvatar || node?.avatar || FALLBACK_AVATAR;
        const peerNode = this.kind === 'group'
          ? node?.contacts?.groups?.[this.peerName]
          : node?.contacts?.friends?.[this.peerName];
        peerAvatar = peerAvatar || peerNode?.avatar || FALLBACK_AVATAR;

        // 刷当前已渲染消息中的头像
        this.root.querySelectorAll('.cv-row').forEach(row => {
          const isRight = row.classList.contains('cv-row--right');
          const ava = row.querySelector('.chat-ava');
          if (ava) setBgImage(ava, isRight ? selfAvatar : peerAvatar);
        });

        // 存回实例与设置页头像
        this.rightAvatar = selfAvatar;
        this.leftAvatar  = peerAvatar;
        const cvAva = this.root.querySelector('#cvSet .cvset-avatar');
        if (cvAva) setBgImage(cvAva, peerAvatar);
      } catch {}
    })();

    // ---------- 返回 ----------
    const onBack = () => this.onBack?.();
    $('.chat-back')?.addEventListener('click', onBack);
    this._handlers.push(['.chat-back', 'click', onBack]);

    // ---------- 顶部状态：使用最新 sig ----------
    const applySigStatus = () => {
      if (!chatStatus || this.kind !== 'dm') return;
      const sess = RMQQ.Data.findSession?.(this.login, 'dm', this.peerName);
      const items = Array.isArray(sess?.items) ? sess.items : [];
      let sig = '';
      for (let i = items.length - 1; i >= 0; i--) {
        const it = items[i];
        if (!it || it.type !== 'sig') continue;
        const fromPeer = (String(it.speaker || '') === String(this.peerName)) || it.out === false;
        if (fromPeer) {
          sig = String(Array.isArray(it.args) ? (it.args[0] ?? it.content) : it.content || '').trim();
          if (sig) break;
        }
      }
      const txt = sig || '在线';
      chatStatus.textContent = txt.length > 20 ? (txt.slice(0, 20) + '…') : txt;
    };
    applySigStatus();

    // ---------- 应用“全局聊天缩放” ----------
    (async () => {
      try {
        const all = await RMPhoneToWorldBook.getAll();
        const cs  = all?.global?.chatScale || {};
        document.documentElement.style.setProperty('--cv-msg-scale', String(Number(cs.msg) || 1));
        document.documentElement.style.setProperty('--cv-ava-scale', String(Number(cs.ava) || 1));
      } catch {}
    })();

    // ---------- 进入聊天：若有会话背景则应用 ----------
    (async () => {
      try {
        const wb = await RMPhoneToWorldBook.getApp('qq');
        const node = wb?.login?.[this.login];
        const friend = this.kind === 'group'
          ? node?.contacts?.groups?.[this.peerName]
          : node?.contacts?.friends?.[this.peerName];
        const bg = friend?.chatBg || '';
        if (bg) applyChatBg(bg);
      } catch {}
    })();

    // ---------- 发送 ----------
    const sendNow = () => {
      const txt = (input.value || '').trim();
      if (!txt) return;
      RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'txt', args: [txt] });
      input.value = '';
      scrollToBottom();
    };
    const onEnter = (e) => { if (e.key === 'Enter') { e.preventDefault(); sendNow(); } };
    input?.addEventListener('keydown', onEnter);
    this._handlers.push(['#cvInput', 'keydown', onEnter]);

    // ---------- 生成错误弹窗 ----------
    const dlgGenError  = this.root.querySelector('#dlgGenError');
    const genErrorText = this.root.querySelector('#genErrorText');
    const genErrorCopy = this.root.querySelector('#genErrorCopy');
    const genErrorOK   = this.root.querySelector('#genErrorOK');
    genErrorCopy?.addEventListener('click', ()=> navigator.clipboard?.writeText(genErrorText.value||''));
    genErrorOK  ?.addEventListener('click', ()=>{ hideMask(dlgGenError); genErrorText.value=''; });

    // ---------- 触发生成：范围菜单（读写世界书） ----------
    const getGenScope = () => (this._wbQQ?.prefs?.generateScope) || 'all';
    const setGenScope = async (v) => {
      const scope = (v === 'current') ? 'current' : 'all';
      let wb = (this._wbQQ && typeof this._wbQQ==='object') ? this._wbQQ : await RMPhoneToWorldBook.getApp('qq').catch(()=>({})) || {};
      (wb.prefs ||= {}).generateScope = scope;
      this._wbQQ = await RMPhoneToWorldBook.saveApp('qq', wb);
      this.root.querySelectorAll('#genMenu .gen-item').forEach(btn=>{
        btn.classList.toggle('checked', btn.dataset.scope === getGenScope());
      });
    };
    const genMenu   = $('#genMenu');
    const menuItems = Array.from(genMenu?.querySelectorAll('.gen-item')||[]);
    const refreshMenu = () => {
      const cur = getGenScope();
      menuItems.forEach(it=> it.classList.toggle('checked', it.dataset.scope === cur));
    };
    const showGenMenu = () => {
      if(!genMenu) return;
      refreshMenu();
      genMenu.classList.add('show');
      genMenu.setAttribute('aria-hidden','false');
      const onOutside = (e)=>{ if (!genMenu.contains(e.target)) hideGenMenu(); };
      setTimeout(()=>document.addEventListener('mousedown', onOutside, { once:true }), 0);
      genMenu._off = ()=> document.removeEventListener('mousedown', onOutside);
    };
    const hideGenMenu = () => {
      if(!genMenu) return;
      genMenu.classList.remove('show');
      genMenu.setAttribute('aria-hidden','true');
      genMenu._off?.(); genMenu._off=null;
    };
    genMenu?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.gen-item'); if (!btn) return;
      const v = btn.dataset.scope === 'current' ? 'current' : 'all';
      setGenScope(v); hideGenMenu();
    });

    // ---------- collectTail（支持“额外查看列表”空框） ----------
    const collectTail = (scope, opts = {}) => {
      const data = RMQQ.Data.getState();
      const accounts = [];
      const addSession = (login, sess)=>{
        if(!sess || !Array.isArray(sess.items)) return;
        const tail=[], arr=sess.items;
        for(let i=arr.length-1;i>=0;i--){
          const it = arr[i];
          if(!it || it.out!==true) break;
          tail.push({
            type: it.type,
            speaker: login,
            args: Array.isArray(it.args) ? it.args.map(String) : [],
            content: it.content || ''
          });
        }
        if(!tail.length) return;
        tail.reverse();
        let acc = accounts.find(a=>a.login===login);
        if(!acc){ acc = { login, sessions: [] }; accounts.push(acc); }
        acc.sessions.push({ kind:sess.kind, peer:sess.peer, items: tail });
      };

      if (scope==='current'){
        const login = this.login, kind = this.kind, peer = this.peerName;
        const acc = (data.accounts||[]).find(a=>a.login===login) || {};
        const sess = (acc.sessions||[]).find(s=>s.kind===kind && s.peer===peer);
        addSession(login, sess);
      } else {
        for (const acc of (data.accounts||[])){
          for (const sess of (acc.sessions||[])){
            if (sess && (sess.kind==='dm' || sess.kind==='group')) addSession(acc.login, sess);
          }
        }
      }

      if (opts && Array.isArray(opts.extraBlankSessions)) {
        for (const sel of opts.extraBlankSessions) {
          if (!sel || !sel.login || !sel.kind || !sel.peer) continue;
          const login = sel.login, kind = sel.kind, peer = sel.peer;
          let acc = accounts.find(a => a.login === login);
          const hasSess = !!acc?.sessions?.some(s => s.kind === kind && s.peer === peer);
          if (!hasSess) {
            if (!acc) { acc = { login, sessions: [] }; accounts.push(acc); }
            acc.sessions.push({ kind, peer, items: [], _blank: true });
          }
        }
      }
      return { qq:{ accounts } };
    };

    // ---------- 真正触发 generate ----------
    const triggerGenerate = async (scope) => {
      const prevTxt = send.textContent;
      send.disabled = true; send.textContent = '生成中…';
      let raw = '';
      try{
        const extraList = (RMQQ?.Extra?.list && RMQQ.Extra.list()) || [];
        const fragment   = collectTail(scope, { extraBlankSessions: extraList });
        const user_input = RMPhoneToChatMessage.buildRaw(fragment);

        if (!user_input.trim()) {
          const hasBlank = Array.isArray(fragment?.qq?.accounts)
            && fragment.qq.accounts.some(a => Array.isArray(a.sessions)
              && a.sessions.some(s => s && s._blank === true));
          if (!hasBlank) throw new Error('没有可用的“我方未被回复的尾巴消息”。');
        }

        raw = await generate({ user_input });
        const changed = RMQQ.Data.applyRaw(raw);
        if (!changed) throw new Error('返回值为空或未产生任何可入库的消息。');

        scrollToBottom();
      }catch(err){
        console.warn('generate 失败：', err);
        genErrorText.value = String(raw || (err?.message || ''));
        showMask(dlgGenError);
      }finally{
        send.disabled = false; send.textContent = prevTxt;
      }
    };

    // ---------- 发送按钮：单击发、双击生成、长按范围菜单 ----------
    let clickTimer = null; const CLICK_GAP = 280;
    let pressTimer = null; const PRESS_MS  = 520;

    const onSendClick = () => {
      if (clickTimer){
        clearTimeout(clickTimer); clickTimer = null;
        triggerGenerate(getGenScope());
        return;
      }
      clickTimer = setTimeout(()=>{ clickTimer=null; sendNow(); }, CLICK_GAP);
    };
    const onPressStart = ()=>{ if (pressTimer) clearTimeout(pressTimer); pressTimer = setTimeout(()=> showGenMenu(), PRESS_MS); };
    const onPressEnd   = ()=>{ if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; } };
    const onContext    = (e)=>{ e.preventDefault(); showGenMenu(); };

    send?.addEventListener('click', onSendClick);
    send?.addEventListener('mousedown', onPressStart);
    send?.addEventListener('mouseup', onPressEnd);
    send?.addEventListener('mouseleave', onPressEnd);
    send?.addEventListener('touchstart', onPressStart, { passive:true });
    send?.addEventListener('touchend', onPressEnd);
    send?.addEventListener('contextmenu', onContext);
    this._handlers.push(
      ['#cvSend','click',onSendClick],
      ['#cvSend','mousedown',onPressStart],
      ['#cvSend','mouseup',onPressEnd],
      ['#cvSend','mouseleave',onPressEnd],
      ['#cvSend','touchstart',onPressStart],
      ['#cvSend','touchend',onPressEnd],
      ['#cvSend','contextmenu',onContext]
    );

    // ---------- 主区点击：语音展开、dmt 展开、xfr 操作、接收文件 ----------
    main.addEventListener('click', e => {
      const voice = e.target.closest('.cv-voice');
      if (voice) {
        const wrap = voice.parentElement?.classList.contains('cv-voice-wrap') ? voice.parentElement : null;
        const text = wrap?.querySelector('.cv-voice-text');
        if (text) {
          const open = voice.getAttribute('aria-expanded') === 'true';
          voice.setAttribute('aria-expanded', open ? 'false' : 'true');
          text.classList.toggle('cv-hidden', open);
          keepAtBottomIfUserWasThere(voice);
        }
        return;
      }
      const box = e.target.closest('.cv-dmt');
      if (box) {
        box.classList.toggle('is-open');
        keepAtBottomIfUserWasThere(box);
        return;
      }

      const xfr = e.target.closest('.cv-xfr.is-pending');
      if (xfr) {
        const sender   = xfr.getAttribute('data-sender')  || '';
        const receiver = xfr.getAttribute('data-receiver')|| '';
        const amount   = xfr.getAttribute('data-amount')  || '';
        const canHandle =
          (this.kind === 'dm'    && receiver === this.login && sender !== this.login) ||
          (this.kind === 'group' && receiver === this.login && sender !== this.login);
        if (canHandle) openXfrActionDialog(sender, amount);
        return;
      }

      const fileCard = e.target.closest('.cv-file');
      if (fileCard) {
        const row = fileCard.closest('.cv-row');
        const isIncoming = row?.classList.contains('cv-row--left');
        if (this.kind === 'dm' && isIncoming) {
          const fname = (fileCard.getAttribute('data-fname')
                      || fileCard.querySelector('.cv-file-name')?.textContent
                      || '未命名文件').trim();
          openFileRcvDialog(fname);
        }
      }
    });

    // ---------- 双击头像：拍一拍 ----------
    main.addEventListener('dblclick', e => {
      const ava = e.target.closest('.chat-ava');
      if (!ava) return;
      const row = ava.closest('.cv-row');
      let target = '';
      if (row?.classList.contains('cv-row--right')) {
        target = this.login;
      } else if (this.kind === 'group') {
        target = row?.querySelector('.cv-name')?.textContent?.trim() || '对方';
      } else {
        target = this.peerName;
      }
      RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'nudge', args: [target] });
    });

    // ---------- 工具栏（图标态 & 展开区）结构化 ----------
    const iconMap = {
      micro: ['https://i.postimg.cc/dVM9xnDD/micro1.png', 'https://i.postimg.cc/FFBpjh4y/micro2.png'],
      image: ['https://i.postimg.cc/VvdF3Vj0/image1.png', 'https://i.postimg.cc/QxKbmv8R/image2.png'],
      camera:['https://i.postimg.cc/sDbnRsHj/camera1.png', 'https://i.postimg.cc/tgj2YDH8/camera2.png'],
      hongbao:['https://i.postimg.cc/RZfgSy2c/hongbao1.png', 'https://i.postimg.cc/76P9N6hV/hongbao2.png'],
      emoji: ['https://i.postimg.cc/cHDmkS8N/emoji1.png', 'https://i.postimg.cc/wBQFJJqM/emoji2.png'],
      plus:  ['https://i.postimg.cc/Bv4Bq6T0/plus1.png', 'https://i.postimg.cc/Nj1xqTrD/plus2.png'],
    };
    const flipIconState = (btn) => {
      const key = btn.dataset.key;
      const img = btn.querySelector('img');
      if (!img || !iconMap[key]) return;
      const cur = btn.dataset.state === '2' ? 2 : 1;
      const next = cur === 1 ? 2 : 1;
      img.src = iconMap[key][next - 1];
      btn.dataset.state = String(next);
    };
    const resetOtherToolButtons = (activeBtn) => {
      this.root.querySelectorAll('.cv-tool-btn[data-key]').forEach(b => {
        if (b === activeBtn) return;
        b.classList.remove('is-active');
        b.dataset.state = '1';
        const k = b.dataset.key;
        const im = b.querySelector('img');
        if (im && iconMap[k]) im.src = iconMap[k][0];
      });
    };
    const setExpand = (open, key) => {
      const wasOpen = expand.classList.contains('show');
      expand.classList.toggle('show', open);
      expand.setAttribute('aria-hidden', open ? 'false' : 'true');
      if (open) {
        if (!wasOpen) {
          const refH = $('.chat-wrap')?.clientHeight || window.innerHeight;
          const h = Math.round(refH * 0.3);
          expand.style.setProperty('--cv-expand-h', h + 'px');
        }
        renderPanel(key);
        keepAtBottomIfUserWasThere(expand);
      } else {
        expand.style.removeProperty('--cv-expand-h');
        panel.innerHTML = '';
      }
    };
    const togglePanel = (key) => {
      const btn = tools.querySelector(`.cv-tool-btn[data-key="${key}"]`);
      const isOpen = expand.classList.contains('show');
      const same = btn?.classList.contains('is-active');
      // 先清除其它激活
      this.root.querySelectorAll('.cv-tool-btn.is-active').forEach(b => b.classList.remove('is-active'));
      if (isOpen && same) { setExpand(false); return; }
      btn?.classList.add('is-active');
      setExpand(true, key);
    };

    // ---- 动态弹窗工具（仅用于“创建型弹窗”）----
    const ensureDialog = (id, html) => {
      let dlg = this.root.querySelector('#' + id);
      if (!dlg) {
        dlg = document.createElement('div');
        dlg.id = id;
        dlg.className = 'cv-modal-mask';
        dlg.setAttribute('aria-hidden', 'true');
        dlg.innerHTML = html;
        this.root.querySelector('.chat-wrap')?.appendChild(dlg);
        dlg.addEventListener('click', e => { if (e.target === dlg) hideMask(dlg); });
      }
      return dlg;
    };

    // ---------- 通用“发送弹窗” ----------
    const openSendDialog = (title, fields, onOK) => {
      const dlg = ensureDialog('dlgSendGeneric', `
        <div class="cv-modal" role="dialog" aria-label="发送">
          <div class="title"></div>
          <div class="body"></div>
          <div class="cv-error" id="sgErr"></div>
          <div class="cv-actions">
            <button class="cv-btn" id="sgCancel">取消</button>
            <button class="cv-btn primary" id="sgOK">确认</button>
          </div>
        </div>`);
      const $d = s => dlg.querySelector(s);
      $d('.title').textContent = title || '发送';
      const body = $d('.body'); body.innerHTML = '';
      (fields || []).forEach(f => {
        const wrap = document.createElement('div');
        wrap.className = 'cv-field';
        wrap.innerHTML = `<label>${f.label || f.id}</label><input id="sg_${f.id}" placeholder="${f.placeholder || ''}" />`;
        body.appendChild(wrap);
      });
      $d('#sgErr').textContent = '';
      // 克隆重绑
      const oldOK = $d('#sgOK'), oldCancel = $d('#sgCancel');
      const btnOK = oldOK.cloneNode(true), btnCancel = oldCancel.cloneNode(true);
      oldOK.replaceWith(btnOK); oldCancel.replaceWith(btnCancel);
      btnCancel.addEventListener('click', () => hideMask(dlg), { once:true });
      btnOK.addEventListener('click', () => {
        const vals = {}; (fields || []).forEach(f => { vals[f.id] = ($d('#sg_' + f.id)?.value || '').trim(); });
        try { onOK && onOK(vals); hideMask(dlg); } catch { $d('#sgErr').textContent = '发送失败，请重试'; }
      }, { once:true });
      showMask(dlg);
    };

    // ---------- 添加表情弹窗 ----------
    const openAddEmojiDialog = () => {
      const dlg = ensureDialog('dlgAddEmoji', `
        <div class="cv-modal" role="dialog" aria-label="添加表情">
          <div class="title">添加表情</div>
          <div class="cv-field"><label>表情描述</label><input id="aeLabel" placeholder="比如：楚楚可怜" maxlength="20" /></div>
          <div class="cv-field"><label>表情图片 URL</label><input id="aeUrl" placeholder="完整或短链接，如 ls7328.jpg" /></div>
          <div class="cv-error" id="aeErr"></div>
          <div class="cv-actions"><button class="cv-btn" id="aeCancel">取消</button><button class="cv-btn primary" id="aeOK">确认</button></div>
        </div>`);
      const $d = s => dlg.querySelector(s);
      $d('#aeErr').textContent = '';
      $d('#aeCancel').onclick = () => hideMask(dlg);
      $d('#aeOK').onclick = async () => {
        const label = ($d('#aeLabel')?.value || '').trim();
        const url = ($d('#aeUrl')?.value || '').trim();
        if (!label || !url) { $d('#aeErr').textContent = '请把描述和 URL 填完整'; return; }
        try { await RMPhoneToWorldBook.addEmojiToStore?.(label, url); hideMask(dlg); renderPanel('emoji'); }
        catch { $d('#aeErr').textContent = '保存失败，请重试'; }
      };
      showMask(dlg);
    };

    // ---------- 转账弹窗 ----------
    const openTransferDialog = () => {
      const dlg = ensureDialog('dlgXfrSend', `
        <div class="cv-modal" role="dialog" aria-label="转账">
          <div class="title">请输入转账信息</div>
          <div class="cv-field"><label>转账金额</label><input id="xfrAmt" placeholder="比如：66.00" /></div>
          <div class="cv-field"><label>转账对象</label><div id="xfrToList" style="max-height:180px; overflow:auto; border:1px solid #eef1f5; border-radius:8px; padding:6px;"></div></div>
          <div class="cv-error" id="xfrErr"></div>
          <div class="cv-actions"><button class="cv-btn" id="xfrCancel">取消</button><button class="cv-btn primary" id="xfrOK">确认</button></div>
        </div>`);
      const $d = s => dlg.querySelector(s);
      const list = $d('#xfrToList'); list.innerHTML = '';
      const makeItem = (name) => {
        const el = document.createElement('label');
        el.style.cssText = 'display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;cursor:pointer;';
        el.innerHTML = `<input type="radio" name="xfrTo" value="${name}"><span>${name}</span>`;
        return el;
      };
      if (this.kind === 'dm') {
        list.appendChild(makeItem(this.peerName));
        const r = list.querySelector('input[name="xfrTo"]'); if (r) r.checked = true;
      } else {
        const getGroupMembers = (wb, login, gname) => {
          const node = wb?.login?.[login]?.contacts?.groups?.[gname];
          const arr = (node && Array.isArray(node.members)) ? node.members : [];
          return arr.map(m => (typeof m === 'string' ? m : m?.name)).filter(Boolean);
        };
        const names = getGroupMembers(this._wbQQ || {}, this.login, this.peerName);
        names.forEach(n => list.appendChild(makeItem(n)));
      }
      $d('#xfrErr').textContent = '';
      $d('#xfrCancel').onclick = () => hideMask(dlg);
      $d('#xfrOK').onclick = () => {
        const amt = ($d('#xfrAmt').value || '').trim();
        const to  = (dlg.querySelector('input[name="xfrTo"]:checked')?.value || '').trim();
        if (!to)  { $d('#xfrErr').textContent = '请选择转账对象'; return; }
        if (!amt) { $d('#xfrErr').textContent = '请输入金额'; return; }
        RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'xfr', args: [to, amt] });
        hideMask(dlg);
      };
      showMask(dlg);
    };

    // ---------- 处理转账 ----------
    const openXfrActionDialog = (sender, amount) => {
      const dlg = ensureDialog('dlgXfrAction', `
        <div class="cv-modal" role="dialog" aria-label="处理转账">
          <div class="title" id="xfrActTitle"></div>
          <div class="cv-field"><label>请选择</label>
            <div>
              <label style="display:flex;align-items:center;gap:6px;margin:4px 0;"><input type="radio" name="xfrAct" value="rcv" checked><span>接受</span></label>
              <label style="display:flex;align-items:center;gap:6px;margin:4px 0;"><input type="radio" name="xfrAct" value="rfd"><span>退回</span></label>
            </div>
          </div>
          <div class="cv-actions"><button class="cv-btn" id="xfrActCancel">取消</button><button class="cv-btn primary" id="xfrActOK">确认</button></div>
        </div>`);
      const $d = s => dlg.querySelector(s);
      $d('#xfrActTitle').textContent = `${sender}向您转账￥${amount}`;
      $d('#xfrActCancel').onclick = () => hideMask(dlg);
      $d('#xfrActOK').onclick = () => {
        const act = dlg.querySelector('input[name="xfrAct"]:checked')?.value;
        const type = act === 'rfd' ? 'xfr.rfd' : 'xfr.rcv';
        RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type, args: [ sender, String(amount || '') ] });
        hideMask(dlg);
      };
      showMask(dlg);
    };

    // ---------- 接受文件 ----------
    const openFileRcvDialog = (fname) => {
      const dlg = ensureDialog('dlgFileRcv', `
        <div class="cv-modal" role="dialog" aria-label="接收文件">
          <div class="title">是否接受该文件？</div>
          <div class="cv-field"><label>文件</label><div id="fileRcvName" style="font-size:13px;"></div></div>
          <div class="cv-actions"><button class="cv-btn" id="fileRcvCancel">取消</button><button class="cv-btn primary" id="fileRcvOK">确认</button></div>
        </div>`);
      const $d = s => dlg.querySelector(s);
      $d('#fileRcvName').textContent = fname || '未命名文件';
      $d('#fileRcvCancel').onclick = () => hideMask(dlg);
      $d('#fileRcvOK').onclick = () => {
        RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'file.rcv', args: [fname || '未命名文件'] });
        hideMask(dlg);
      };
      showMask(dlg);
    };

    // ---------- 邀请入群 ----------
    const openInviteDialog = async () => {
      const dlg = $('#dlgInviteToGroup'); if (!dlg) return;
      const $d = s => dlg.querySelector(s);
      const ipt = $d('#invSearch'), list = $d('#invFriendList'), err = $d('#invErr');
      const btnOK = $d('#invOK'), btnCancel = $d('#invCancel');

      const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
      const node = wb?.login?.[this.login] || {};
      const friends = Object.keys(node?.contacts?.friends || {});
      const members = Array.isArray(node?.contacts?.groups?.[this.peerName]?.members)
        ? node.contacts.groups[this.peerName].members.map(m => (typeof m === 'string' ? m : m?.name)).filter(Boolean)
        : [];
      const candidates = friends.filter(n => !members.includes(n));
      const makeItem = (name) => {
        const el = document.createElement('div');
        el.className = 'grp-item';
        el.dataset.name = name;
        el.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px;cursor:pointer;';
        el.innerHTML = `<span>${name}</span><i class="fi fi-rr-check" style="opacity:.2;"></i>`;
        el.addEventListener('click', () => {
          el.classList.toggle('selected');
          el.querySelector('i').style.opacity = el.classList.contains('selected') ? '1' : '.2';
        });
        return el;
      };
      list.innerHTML = ''; candidates.forEach(n => list.appendChild(makeItem(n)));
      ipt.value = '';
      ipt.oninput = (e) => {
        const key = String(e.target.value || '').trim().toLowerCase();
        Array.from(list.children).forEach(el => {
          const ok = (el.dataset.name || '').toLowerCase().includes(key);
          el.style.display = ok ? '' : 'none';
        });
      };
      err.textContent = '';
      btnCancel.onclick = () => hideMask(dlg);
      btnOK.onclick = () => {
        const picks = Array.from(list.querySelectorAll('.grp-item.selected')).map(el => el.dataset.name).filter(Boolean);
        if (!picks.length) { err.textContent = '请选择至少 1 位好友'; return; }
        RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'invite', args: [picks.join('、')] });
        hideMask(dlg);
      };
      // 只绑定一次蒙层关闭（模板已存在，不重复绑定）
      showMask(dlg);
    };

    // ---------- 展开区面板字典 ----------
    const renderPanel = (key) => {
      if (!panel) return;
      const wrap = (html) => `<div class="body cv-expand-scroll">${html}</div>`;

      const renderPlusPanel = () => {
        panel.innerHTML = wrap(`
          <div class="cv-ext-grid">
            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-phone-flip"></i></div><div class="label">语音通话</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-video-camera-alt"></i></div><div class="label">视频通话</div></button>
            <button class="cv-ext-item" data-act="loc"><div class="box"><i class="fi fi-sr-marker"></i></div><div class="label">位置</div></button>
            <button class="cv-ext-item" data-act="file"><div class="box"><i class="fi fi-sr-folder"></i></div><div class="label">文件</div></button>

            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-wishlist-star"></i></div><div class="label">收藏</div></button>
            <button class="cv-ext-item" data-act="transfer"><div class="box"><i class="fi fi-sr-wallet-change"></i></div><div class="label">转账</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-screen-share"></i></div><div class="label">屏幕分享</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-hand-back-point-left"></i></div><div class="label">戳一戳</div></button>

            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-id-card"></i></div><div class="label">名片</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-gift"></i></div><div class="label">礼物</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-earbuds"></i></div><div class="label">一起听歌</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-sr-sack-dollar"></i></div><div class="label">收款</div></button>
          </div>
        `);

        // 文件 → 弹窗 → 发送 file
        panel.querySelector('.cv-ext-item[data-act="file"]')?.addEventListener('click', () => {
          openSendDialog('请输入要发送的文件信息', [
            { id: 'fn', label: '文件名', placeholder: '比如：报告.docx' },
            { id: 'fs', label: '文件大小', placeholder: '比如：2.3 MB' }
          ], (vals) => {
            RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'file', args: [vals.fn || '未命名文件', vals.fs || ''] });
          });
        });

        // 转账 → 弹窗
        panel.querySelector('.cv-ext-item[data-act="transfer"]')?.addEventListener('click', () => {
          if (expand.classList.contains('show')) setExpand(false);
          openTransferDialog();
        });

        // 位置 → 弹窗 → 发送 loc
        panel.querySelector('.cv-ext-item[data-act="loc"]')?.addEventListener('click', () => {
          const dlg = ensureDialog('dlgLoc', `
            <div class="cv-modal" role="dialog" aria-label="发送位置">
              <div class="title">请输入位置信息</div>
              <div class="cv-field"><label>位置</label><input id="locText" placeholder="例如：椿城二中…"/></div>
              <div id="locErr" style="color:#e11;font-size:12px;margin-top:4px;"></div>
              <div class="cv-actions"><button class="cv-btn" id="locCancel">取消</button><button class="cv-btn primary" id="locOK">确认</button></div>
            </div>`);
          const $d = s => dlg.querySelector(s);
          $d('#locErr').textContent = '';
          $d('#locCancel').onclick = () => hideMask(dlg);
          $d('#locOK').onclick = () => {
            const txt = ($d('#locText').value || '').trim();
            if (!txt) { $d('#locErr').textContent = '请输入位置信息'; return; }
            RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'loc', args: [txt] });
            hideMask(dlg);
          };
          showMask(dlg);
        });
      };

      const renderEmojiPanel = () => {
        panel.innerHTML = wrap(`<div class="cv-ext-grid" id="cvEmojiGrid"></div>`);
        const grid = panel.querySelector('#cvEmojiGrid');

        // 添加按钮
        const addBtn = document.createElement('button');
        addBtn.className = 'cv-ext-item add';
        addBtn.innerHTML = '<div class="box"><i class="fi fi-rr-plus"></i></div><div class="label">添加表情</div>';
        addBtn.addEventListener('click', () => openAddEmojiDialog());
        grid.appendChild(addBtn);

        (async () => {
          try {
            await RMPhoneToWorldBook.ensureQQEmojiStore?.();
            const txt = (await RMPhoneToWorldBook.readQQEmojiStore?.()) || '';
            const m = txt.match(/<bqb>([\s\S]*?)<\/bqb>/i);
            const body = m ? m[1] : '';
            const lines = body.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            for (const line of lines) {
              const mm = line.match(/\[([^|\]]+)\|([^\]]+)\]/); // [label|url]
              if (!mm) continue;
              const label = mm[1].trim();
              const rawUrl = mm[2].trim();
              const url = normCatboxUrl(rawUrl);

              const btn = document.createElement('button');
              btn.className = 'cv-ext-item';
              btn.innerHTML = `<div class="box"><img alt="${label}"></div><div class="label"></div>`;
              btn.querySelector('img').src = url;
              btn.querySelector('.label').textContent = label;
              btn.addEventListener('click', () => {
                RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'bqb', args: [label, rawUrl] });
              });
              grid.appendChild(btn);
            }
          } catch (e) { console.warn('读取表情库失败：', e); }
        })();
      };

      const renderHongbaoPanel = () => {
        // 按你要求：占位保留
        panel.innerHTML = wrap(`
          <div class="cv-ext-grid">
            <button class="cv-ext-item"><div class="box"><i class="fi fi-ss-sack-dollar"></i></div><div class="label">发红包</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-rr-wallet"></i></div><div class="label">转账</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-rr-barcode-scan"></i></div><div class="label">收款码</div></button>
            <button class="cv-ext-item"><div class="box"><i class="fi fi-rr-move-to-folder-2"></i></div><div class="label">文件</div></button>
          </div>
        `);
      };

      const map = { plus: renderPlusPanel, emoji: renderEmojiPanel, hongbao: renderHongbaoPanel };
      map[key]?.();
    };

    // ---------- 工具栏动作字典 ----------
    const toolActions = {
      micro : () => {
        if (expand.classList.contains('show')) setExpand(false);
        openSendDialog('请输入要发送的语音消息', [
          { id: 'dur', label: '语音时长', placeholder: '比如：12s' },
          { id: 'txt', label: '语音内容', placeholder: '（可选）转成文字' }
        ], (vals) => {
          RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'voice', args: [vals.dur || '', vals.txt || ''] });
        });
      },
      image : () => {
        if (expand.classList.contains('show')) setExpand(false);
        openSendDialog('请输入要发送的文件信息', [{ id: 'txt', label: '多媒体消息内容', placeholder: '比如：这是一段视频/图片说明' }], (vals) => {
          RMQQ.Data.pushMsg({ login: this.login, kind: this.kind, peer: this.peerName, type: 'dmt', args: [vals.txt || ''] });
        });
      },
      plus  : () => togglePanel('plus'),
      emoji : () => togglePanel('emoji'),
      hongbao: () => togglePanel('hongbao'),
      camera: () => { /* 预留：相机 */ }
    };

    const onToolClick = e => {
      const btn = e.target.closest('.cv-tool-btn[data-key]');
      if (!btn) return;
      resetOtherToolButtons(btn);
      flipIconState(btn);
      toolActions[btn.dataset.key]?.();
      // 非展开面板键，如果展开着就收起
      const keys = ['plus','emoji','hongbao'];
      if (!keys.includes(btn.dataset.key) && expand.classList.contains('show')) setExpand(false);
    };
    tools?.addEventListener('click', onToolClick);
    this._handlers.push(['#cvTools', 'click', onToolClick]);

    // ---------- 兜底进入动效 ----------
    const hostScreen = this.root.closest('.qq-screen');
    const needFallback = !hostScreen || (!hostScreen.classList.contains('qq-enter-from') && !hostScreen.classList.contains('qq-enter-to'));
    if (needFallback) {
      const cw = this.root.querySelector('.chat-wrap');
      cw.classList.add('chat-fallback-enter-from');
      requestAnimationFrame(() => {
        void cw.offsetWidth;
        cw.classList.add('chat-fallback-enter-to');
        const done = () => cw.classList.remove('chat-fallback-enter-from', 'chat-fallback-enter-to');
        cw.addEventListener('transitionend', done, { once: true });
      });
    }

    // ---------- 设置子页面 ----------
    const cvSet = $('#cvSet'), cvSetBody = $('#cvSetBody'), cvSetTitle = $('#cvSetTitle');

    const renderDM = () => {
      const ava = this.leftAvatar ? `style="background-image:url('${this.leftAvatar}')" ` : '';
      return `
        <div class="cvset-card">
          <div class="cvset-row">
            <div class="cvset-avatar" ${ava}></div>
            <div class="label"><div class="cvset-name">${this.peerName}</div></div>
            <i class="fi fi-rr-angle-small-right chev"></i>
          </div>
          <div class="cvset-row">
            <div class="cvset-avatar cvset-plus"><i class="fi fi-rr-plus-small"></i></div>
            <div class="label">发起群聊</div>
          </div>
        </div>
        <div class="cvset-card">
          <div class="cvset-row"><div class="label">额外查看此会话</div><input type="checkbox" id="cvExtraInspectCurrent" class="cvset-switch"></div>
          <div class="cvset-row"><div class="label">加入黑名单</div><input type="checkbox" id="cvBlockThisPeer" class="cvset-switch"></div>
          <div class="cvset-row" data-act="set-peer-avatar"><div class="label">设置角色头像（对方的）</div><i class="fi fi-rr-angle-small-right chev"></i></div>
          <div class="cvset-row" data-act="set-chat-bg"><div class="label">设置当前聊天背景</div><i class="fi fi-rr-angle-small-right chev"></i></div>
          <div class="cvset-row" data-act="set-chat-scale"><div class="label">设置聊天页面缩放</div><i class="fi fi-rr-angle-small-right chev"></i></div>
          <div class="cvset-row" data-act="clear-chat"><div class="label">删除所有聊天记录</div><i class="fi fi-rr-angle-small-right chev"></i></div>
        </div>
        <div class="cvset-card"><div class="cvset-row center cvset-danger" data-act="delete-friend">删除好友</div></div>
      `;
    };

    const renderGroup = () => {
      const wb = this._wbQQ || {};
      const node = wb?.login?.[this.login] || {};
      const g = node?.contacts?.groups?.[this.peerName] || {};
      let names = Array.isArray(g.members) ? g.members.slice(0) : [];
      if (!names.length) {
        try {
          const st = RMQQ.Data.getState();
          const acc = (st.accounts || []).find(a => a.login === this.login) || (st.accounts || [])[0] || {};
          const sess = (acc.sessions || []).find(s => s.kind === 'group' && s.peer === this.peerName) || {};
          const set = new Set(); for (const m of sess.items || []) { if (m && m.speaker) set.add(m.speaker); }
          names = Array.from(set);
        } catch {}
      }
      if (this.login && !names.includes(this.login)) names.unshift(this.login);
      const fallback = FALLBACK_AVATAR;
      const memHTML = names.map(n => {
        const ava = n === this.login ? node?.avatar || fallback : node?.contacts?.friends?.[n]?.avatar || fallback;
        return `<div class="cvset-mem"><div class="head" style="background-image:url('${ava}');"></div><div class="name">${n}</div></div>`;
      }).join('') + `<div class="cvset-mem cvset-invite"><div class="head"><i class="fi fi-rr-plus-small"></i></div><div class="name">邀请</div></div>`;
      const grpAva = g?.avatar || fallback;
      return `
        <div class="cvset-card">
          <div class="cvset-row">
            <div class="cvset-avatar" style="background-image:url('${grpAva}');"></div>
            <div class="label"><div class="cvset-name">${this.peerName}</div><div class="muted">群聊介绍：在这里，发现更多~</div></div>
            <i class="fi fi-rr-angle-small-right chev"></i>
          </div>
        </div>
        <div class="cvset-card">
          <div class="cvset-row"><div class="label">群聊成员</div><div class="muted">查看${names.length}名群成员</div><i class="fi fi-rr-angle-small-right chev"></i></div>
          <div class="cvset-grid">${memHTML}</div>
        </div>
        <div class="cvset-card">
          <div class="cvset-row"><div class="label">额外查看此会话</div><input type="checkbox" id="cvExtraInspectCurrent" class="cvset-switch"></div>
          <div class="cvset-row" data-act="set-group-avatar"><div class="label">设置群聊头像</div><i class="fi fi-rr-angle-small-right chev"></i></div>
          <div class="cvset-row" data-act="set-chat-bg"><div class="label">设置当前聊天背景</div><i class="fi fi-rr-angle-small-right chev"></i></div>
          <div class="cvset-row" data-act="set-chat-scale"><div class="label">设置聊天页面缩放</div><i class="fi fi-rr-angle-small-right chev"></i></div>
          <div class="cvset-row" data-act="clear-chat"><div class="label">删除所有聊天记录</div><i class="fi fi-rr-angle-small-right chev"></i></div>
        </div>
        <div class="cvset-card"><div class="cvset-row center cvset-danger" data-act="disband-group">解散群聊</div></div>
        <div class="cvset-card"><div class="cvset-row center cvset-danger">退出群聊</div></div>
      `;
    };

    const renderSettings = () => {
      cvSetTitle.textContent = this.kind === 'group' ? '群聊设置' : '聊天设置';
      cvSetBody.innerHTML = this.kind === 'group' ? renderGroup() : renderDM();
    };
    renderSettings();

    // 开关状态回显
    const syncSettingsToggles = () => {
      const box2 = cvSetBody.querySelector('#cvExtraInspectCurrent');
      if (box2) box2.checked = RMQQ.Extra.has(this.login, this.kind, this.peerName);
      const blk = cvSetBody.querySelector('#cvBlockThisPeer');
      if (blk && this.kind === 'dm') {
        const sess = RMQQ.Data.findSession?.(this.login, 'dm', this.peerName);
        const items = Array.isArray(sess?.items) ? sess.items : [];
        let on = false;
        for (let i = items.length - 1; i >= 0; i--) {
          const it = items[i];
          if (!it || it.speaker !== this.login) continue;
          if (it.type === 'block')   { on = true;  break; }
          if (it.type === 'unblock') { on = false; break; }
        }
        blk.checked = on;
      }
    };

    const openSettings = () => { cvSet.classList.add('show'); cvSet.setAttribute('aria-hidden', 'false'); };
    const closeSettings= () => { cvSet.classList.remove('show'); cvSet.setAttribute('aria-hidden', 'true'); };
    const onMore = () => { renderSettings(); syncSettingsToggles(); openSettings(); };
    const onSetBack = () => closeSettings();
    $('.chat-more')?.addEventListener('click', onMore);
    $('#cvSet .cvset-back')?.addEventListener('click', onSetBack);
    this._handlers.push(['.chat-more', 'click', onMore], ['#cvSet .cvset-back', 'click', onSetBack]);

    const onExtraChange = (e)=>{
      if (e.target && e.target.id === 'cvExtraInspectCurrent'){
        const checked = !!e.target.checked;
        const info = { login: this.login, kind: this.kind, peer: this.peerName };
        if (checked) RMQQ.Extra.add(info.login, info.kind, info.peer);
        else RMQQ.Extra.remove(info.login, info.kind, info.peer);
      }
      if (e.target && e.target.id === 'cvBlockThisPeer' && this.kind === 'dm') {
        const checked = !!e.target.checked;
        RMQQ.Data.pushMsg({ login: this.login, kind: 'dm', peer: this.peerName, type: checked ? 'block' : 'unblock', args: [this.peerName] });
      }
    };
    cvSetBody.addEventListener('change', onExtraChange);
    this._handlers.push(['#cvSetBody','change',onExtraChange]);

    // 设置“对方头像 / 群头像 / 聊天背景 / 全局缩放”
    const dlgAva = $('#dlgPeerAvatar');
    const iptNameFixed = $('#peerNameFixed');
    const iptAva = $('#peerAvatarUrl');
    const preAva = $('#peerAvatarPreview');
    const errAva = $('#peerAvatarErr');
    const btnAvaOK = $('#peerAvatarOK');
    const btnAvaCancel = $('#peerAvatarCancel');

    const openPeerAvatarDialog = async () => {
      iptNameFixed.value = this.peerName;
      errAva.textContent = '';
      try {
        const wb = await RMPhoneToWorldBook.getApp('qq');
        const node = wb?.login?.[this.login];
        const friend = node?.contacts?.friends?.[this.peerName];
        const curUrl = friend?.avatar || this.leftAvatar || FALLBACK_AVATAR;
        iptAva.value = curUrl; setBgImage(preAva, curUrl);
      } catch { iptAva.value = ''; preAva.style.backgroundImage='none'; }
      showMask(dlgAva);
    };
    const openGroupAvatarDialog = async () => {
      iptNameFixed.value = this.peerName;
      errAva.textContent = '';
      try {
        const wb = await RMPhoneToWorldBook.getApp('qq');
        const node = wb?.login?.[this.login];
        const group = node?.contacts?.groups?.[this.peerName];
        const curUrl = group?.avatar || FALLBACK_AVATAR;
        iptAva.value = curUrl; setBgImage(preAva, curUrl);
      } catch { iptAva.value = ''; preAva.style.backgroundImage='none'; }
      showMask(dlgAva);
    };
    iptAva?.addEventListener('input', () => {
      const u = (iptAva.value || '').trim();
      setBgImage(preAva, u || '');
    });
    btnAvaCancel?.addEventListener('click', () => hideMask(dlgAva));
    btnAvaOK?.addEventListener('click', async () => {
      const url = (iptAva.value || '').trim();
      if (!url) { errAva.textContent = '请输入头像 URL'; return; }

      const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
      wb.login ||= {};
      wb.login[this.login] ||= { avatar: FALLBACK_AVATAR, contacts: { friends: {}, groups: {} } };
      wb.login[this.login].contacts ||= { friends: {}, groups: {} };
      if (this.kind === 'group') {
        wb.login[this.login].contacts.groups ||= {};
        wb.login[this.login].contacts.groups[this.peerName] ||= {};
        wb.login[this.login].contacts.groups[this.peerName].avatar = url;
      } else {
        wb.login[this.login].contacts.friends ||= {};
        wb.login[this.login].contacts.friends[this.peerName] ||= {};
        wb.login[this.login].contacts.friends[this.peerName].avatar = url;
      }
      await RMPhoneToWorldBook.saveApp('qq', wb);

      // 刷视图：左侧头像 + 设置页头像
      this.leftAvatar = url;
      this.root.querySelectorAll('.cv-row--left .chat-ava').forEach(ava => setBgImage(ava, url));
      const cvAvaNow = this.root.querySelector('#cvSet .cvset-avatar'); if (cvAvaNow) setBgImage(cvAvaNow, url);

      // 广播外层同步
      window.dispatchEvent(new CustomEvent('rmqq:peer-avatar-updated', {
        detail: { login: this.login, kind: this.kind === 'group' ? 'group' : 'dm', peer: this.peerName, avatar: url },
      }));

      hideMask(dlgAva);
    });

    const dlgBg = $('#dlgChatBg'), iptBg = $('#chatBgUrl'), errBg = $('#chatBgErr');
    const btnBgOK = $('#chatBgOK'), btnBgCancel = $('#chatBgCancel');

    const openChatBgDialog = async () => {
      errBg.textContent = '';
      try {
        const wb = await RMPhoneToWorldBook.getApp('qq');
        const node = wb?.login?.[this.login];
        const friend = this.kind === 'group' ? node?.contacts?.groups?.[this.peerName] : node?.contacts?.friends?.[this.peerName];
        iptBg.value = friend?.chatBg || '';
      } catch { iptBg.value = ''; }
      showMask(dlgBg);
    };
    btnBgCancel?.addEventListener('click', () => hideMask(dlgBg));
    btnBgOK?.addEventListener('click', async () => {
      const url = (iptBg.value || '').trim();
      const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
      wb.login ||= {};
      wb.login[this.login] ||= { avatar: FALLBACK_AVATAR, contacts: { friends: {}, groups: {} } };
      wb.login[this.login].contacts ||= { friends: {}, groups: {} };
      const bag = this.kind === 'group'
        ? (wb.login[this.login].contacts.groups ||= {})
        : (wb.login[this.login].contacts.friends ||= {});
      bag[this.peerName] ||= {};
      bag[this.peerName].chatBg = url;
      await RMPhoneToWorldBook.saveApp('qq', wb);
      applyChatBg(url);
      hideMask(dlgBg);
    });

    // 聊天缩放（全局）
    const dlgScale      = $('#dlgChatScale');
    const iptScaleMsg   = $('#chatScaleMsg');
    const iptScaleAva   = $('#chatScaleAva');
    const btnScaleOK    = $('#chatScaleOK');
    const btnScaleCancel= $('#chatScaleCancel');
    const setScaleVars = (msg = 1, ava = 1) => {
      document.documentElement.style.setProperty('--cv-msg-scale', String(msg || 1));
      document.documentElement.style.setProperty('--cv-ava-scale', String(ava || 1));
    };
    const openChatScaleDialog = async () => {
      let msg = 1, ava = 1;
      try {
        const all  = await RMPhoneToWorldBook.getAll();
        const cs   = all?.global?.chatScale || {};
        msg = Number(cs.msg) || 1; ava = Number(cs.ava) || 1;
      } catch {}
      iptScaleMsg.value = String(msg); iptScaleAva.value = String(ava);
      const onInput = () => setScaleVars(Number(iptScaleMsg.value), Number(iptScaleAva.value));
      iptScaleMsg.oninput = onInput; iptScaleAva.oninput = onInput; onInput();
      showMask(dlgScale);
      btnScaleCancel.onclick = () => { setScaleVars(msg, ava); hideMask(dlgScale); };
      btnScaleOK.onclick = async () => {
        const m = Number(iptScaleMsg.value) || 1;
        const a = Number(iptScaleAva.value) || 1;
        await RMPhoneToWorldBook.saveGlobal({ chatScale: { msg: m, ava: a } });
        hideMask(dlgScale);
      };
    };

    // 清空/删除确认
    const dlgClear = $('#dlgConfirmClear');
    const btnClearOK = $('#confirmClearOK');
    const btnClearCancel = $('#confirmClearCancel');
    const dlgDel = $('#dlgConfirmDelete');
    const btnDelOK = $('#confirmDeleteOK');
    const btnDelCancel = $('#confirmDeleteCancel');

    const doClearChat = async () => {
      try {
        RMQQ.Data.deleteSession?.({ login: this.login, kind: this.kind, peer: this.peerName });
        if (main) main.innerHTML = '<div class="cv-empty" style="color:#9aa3ad;text-align:center;padding:24px;">已清空</div>';
        notifyChatDeleted({ login: this.login, kind: this.kind, peer: this.peerName });
      } finally {
        hideMask(dlgClear);
      }
    };
    const doDeleteContact = async () => {
      try {
        const wb = (await RMPhoneToWorldBook.getApp('qq').catch(() => ({}))) || {};
        wb.login ||= {};
        wb.login[this.login] ||= { avatar: FALLBACK_AVATAR, contacts: { friends: {}, groups: {} } };
        wb.login[this.login].contacts ||= { friends: {}, groups: {} };
        if (this.kind === 'group') delete (wb.login[this.login].contacts.groups || {})[this.peerName];
        else delete (wb.login[this.login].contacts.friends || {})[this.peerName];
        await RMPhoneToWorldBook.saveApp('qq', wb);
        this._wbQQ = wb;

        const key = `${this.login}|${this.kind === 'group' ? 'group' : 'dm'}|${this.peerName}`;
        this._avatarMap?.delete?.(key);

        RMQQ.Data.deleteSession?.({ login: this.login, kind: this.kind, peer: this.peerName });
        notifyChatDeleted({ login: this.login, kind: this.kind, peer: this.peerName });

        if (typeof renderContactsFromWB === 'function') renderContactsFromWB(this.kind === 'group' ? 'groups' : 'friends');
        if (main) main.innerHTML = '<div class="cv-empty" style="color:#9aa3ad;text-align:center;padding:24px;">已清空</div>';
      } finally {
        hideMask(dlgDel);
        closeSettings();
        this.onBack?.();
      }
    };
    btnClearCancel?.addEventListener('click', () => hideMask(dlgClear));
    btnClearOK?.addEventListener('click', doClearChat);
    btnDelCancel?.addEventListener('click', () => hideMask(dlgDel));
    btnDelOK?.addEventListener('click', doDeleteContact);

    // 设置页点击动作
    cvSetBody.addEventListener('click', e => {
      const invTile = e.target.closest('.cvset-invite');
      if (invTile && this.kind === 'group') { openInviteDialog(); return; }
      const row = e.target.closest('.cvset-row'); if (!row) return;
      const act = row.dataset.act || '';
      if (act === 'set-peer-avatar' && this.kind === 'dm') openPeerAvatarDialog();
      if (act === 'set-group-avatar' && this.kind === 'group') openGroupAvatarDialog();
      if (act === 'set-chat-bg') openChatBgDialog();
      if (act === 'set-chat-scale') openChatScaleDialog();
      if (act === 'clear-chat') showMask(dlgClear);
      if (act === 'delete-friend' && this.kind === 'dm') {
        dlgDel.querySelector('#confirmDeleteText').textContent = '你确认删除好友（同时清空聊天记录）吗？';
        showMask(dlgDel);
      }
      if (act === 'disband-group' && this.kind === 'group') {
        dlgDel.querySelector('#confirmDeleteText').textContent = '你确认解散群聊（同时清空聊天记录）吗？';
        showMask(dlgDel);
      }
    });

    // ---------- 初始滚到底 ----------
    scrollToBottom();

    // ---------- 渲染器字典 + 兜底 ----------
    const centerTip = (text) => {
      const tip = document.createElement('div');
      tip.className = 'cv-empty';
      tip.textContent = (text || '').trim() || '...';
      return { center: true, el: tip };
    };
    const bubble = (text) => {
      const b = document.createElement('div'); b.className = 'cv-txt'; b.textContent = text || ''; return b;
    };
    const makeAvatar = (it) => {
      const a = document.createElement('div'); a.className = 'chat-ava';
      let url;
      if (it.out) url = selfAvatar || FALLBACK_AVATAR;
      else if (this.kind === 'group') url = (this._friendMap?.[it.speaker]?.avatar) || FALLBACK_AVATAR;
      else url = peerAvatar || FALLBACK_AVATAR;
      setBgImage(a, url); return a;
    };
    const wrapSide = (it, node) => {
      let payload = node;
      if (!it.out && this.kind === 'group') {
        const box = document.createElement('div'); box.className = 'cv-wrap';
        const name = document.createElement('div'); name.className = 'cv-name'; name.textContent = it.speaker || '';
        box.appendChild(name); box.appendChild(node); payload = box;
      }
      const row = document.createElement('div');
      row.className = 'cv-row ' + (it.out ? 'cv-row--right' : 'cv-row--left');
      if (it.out) { row.appendChild(payload); row.appendChild(makeAvatar(it)); }
      else { row.appendChild(makeAvatar(it)); row.appendChild(payload); }
      return { center: false, el: row };
    };

    const renderBQB = (it) => {
      const args = it.args || [];
      const desc = args[0] ?? '表情包';
      const raw  = (args[1] || args[0] || it.content || '').trim();
      const fileLike = raw.match(/\S+\.(?:png|jpe?g|gif|webp|svg)/i)?.[0] || '';
      const candidate = isFullUrl(raw) ? raw : (fileLike || (raw.match(/https?:\/\/\S+/)?.[0] || ''));
      const url = candidate ? normCatboxUrl(candidate) : 'https://i.postimg.cc/7P4Qj0sS/emoji-demo.png';
      const box = document.createElement('div'); box.className = 'cv-bqb';
      const img = document.createElement('img'); img.src = url; img.alt = desc; box.appendChild(img);
      return wrapSide(it, box);
    };
    const renderVoice = (it) => {
      const args = it.args || [];
      const wrap = document.createElement('div'); wrap.className = 'cv-voice-wrap';
      const voice = document.createElement('div'); voice.className = 'cv-voice'; voice.setAttribute('role','button'); voice.setAttribute('aria-expanded','false');
      if (args[0]) voice.setAttribute('data-dur', args[0]);
      const ico = document.createElement('i'); ico.className = 'fi fi-rr-feedback-cycle-loop'; voice.appendChild(ico);
      const t = document.createElement('div'); t.className = 'cv-voice-text cv-txt cv-hidden'; t.textContent = args[1] || '';
      wrap.appendChild(voice); wrap.appendChild(t);
      return wrapSide(it, wrap);
    };
    const renderDmt = (it) => {
      const args = it.args || [];
      const box = document.createElement('div'); box.className = 'cv-dmt'; box.title = '点击展开/收起';
      const mask = document.createElement('div'); mask.className = 'cv-dmt-mask';
      const icon = document.createElement('i'); icon.className = 'fi fi-rr-screen-play';
      mask.appendChild(icon);
      const body = document.createElement('div'); body.className = 'cv-dmt-text'; body.textContent = args[0] || '';
      box.appendChild(mask); box.appendChild(body);
      return wrapSide(it, box);
    };
    const renderFile = (it) => {
      const args = it.args || [];
      const fname = args[0] ?? '未命名文件';
      const fsize = args[1] ?? '';
      const card = document.createElement('div'); card.className = 'cv-file';
      const info = document.createElement('div'); info.className = 'cv-file-info';
      const name = document.createElement('div'); name.className = 'cv-file-name'; name.textContent = fname;
      const meta = document.createElement('div'); meta.className = 'cv-file-meta'; meta.textContent = fsize;
      info.appendChild(name); info.appendChild(meta);
      const ico = document.createElement('div'); ico.className = 'cv-file-ico';
      const ii = document.createElement('i'); ii.className = 'fi fi-sr-file'; ico.appendChild(ii);
      card.appendChild(info); card.appendChild(ico);
      card.setAttribute('data-fname', fname);
      return wrapSide(it, card);
    };
    const xfrCard = (mode, it) => {
      const args = it.args || [];
      const sender = it.speaker || '';
      const party  = args[0] ?? '';
      const amt    = args[1] ?? '';
      let line2 = '', icon = 'fi fi-tr-money-transfer-coin-arrow';
      if (mode === 'xfr')      line2 = `${sender}向${party}转账`;
      if (mode === 'xfr.rcv') { line2 = `${sender}接受${party}转账`; icon = 'fi fi-tr-check-circle'; }
      if (mode === 'xfr.rfd') { line2 = `${sender}退回${party}转账`;  icon = 'fi fi-tr-refund-alt'; }
      const card = document.createElement('div');
      card.className = 'cv-xfr' + (mode === 'xfr' ? ' is-pending' : '');
      card.setAttribute('data-type', mode);
      card.setAttribute('data-sender', sender);
      if (mode === 'xfr') card.setAttribute('data-receiver', party);
      card.setAttribute('data-amount', amt);
      card.innerHTML = `
        <div class="xfr-top">
          <div class="xfr-ico"><i class="${icon}"></i></div>
          <div class="xfr-txt">
            <div class="line1"><span class="yen">￥</span><span class="amt">${amt}</span></div>
            <div class="line2">${line2}</div>
          </div>
        </div>
        <div class="xfr-bottom">转账</div>`;
      return wrapSide(it, card);
    };
    const renderLoc = (it) => {
      const loc = (it.args?.[0] || '').trim();
      const card = document.createElement('div'); card.className = 'cv-loc';
      card.innerHTML = `
        <div class="cv-loc-head">${loc || '未知位置'}</div>
        <div class="cv-loc-map">
          <img alt="map">
          <i class="fi fi-sr-land-layer-location"></i>
        </div>`;
      card.querySelector('.cv-loc-map img').src =
        'https://i.postimg.cc/RVJf4JdG/file-000000001b2c6230b4489d26bf06fdff.png';
      return wrapSide(it, card);
    };
    const renderMmtshare = (it) => {
// it.args[0] = lane（唯一标识）
const lane = String(it.args?.[0] ?? '').trim();
// 从 Data 里找到“当前登录账号”的空间里的该 moment
let txt = '', pic = '';
try{
const st = RMQQ.Data.getState?.();
const acc = (st?.qq?.accounts || st?.accounts || []).find(a => a && a.login === this.login)
|| (st?.qq?.accounts || [])[0];
const moments = acc?.zone?.moments || [];
const m = moments.find(mm => String(mm?.lane) === lane);
const items = Array.isArray(m?.items) ? m.items : [];
const t = items.find(x => x && x.type === 'txt');
const hasDmt = items.some(x => x && x.type === 'dmt');
txt = (t?.content || '').trim();
pic = hasDmt ? 'https://files.catbox.moe/pcwffp.jpg' : '';
}catch(_){ /* 安全兜底 */ }


const card = document.createElement('div');
card.className = 'cv-mmtshare';
card.innerHTML = `
<div class="row head"><i class="fi fi-rr-comment-alt-dots"></i><span>说说</span></div>
${txt ? `<div class="txt"></div>` : ''}
${pic ? `<div class="media"><img alt="moment" /></div>` : ''}
<div class="row tail"><i class="fi fi-rr-star"></i><span>QQ空间</span></div>`;
if (txt) card.querySelector('.txt').textContent = txt;
if (pic) card.querySelector('img').src = pic;
return wrapSide(it, card);
};

    const renderers = {
      // 居中系统
      time   : (it) => centerTip((it.content || it.args?.[0] || '').trim() || '刚刚'),
      'file.rcv': (it) => centerTip(`${(it.speaker || '有人').trim()} 接受了文件“${(it.args?.[0] || '未命名文件').trim()}”`),
      block  : (it) => centerTip(`${(it.speaker||'某人')}拉黑了${(it.args?.[0]||'对方')}。`),
      unblock: (it) => centerTip(`${(it.speaker||'某人')}取消拉黑了${(it.args?.[0]||'对方')}。`),
      invite : (it) => {
        const who = (it.speaker || '某人').trim();
        const list = (Array.isArray(it.args) && it.args.length > 1)
          ? it.args.join('、')
          : String((it.args?.[0] || '')).split(/[，,、]\s*/).filter(Boolean).join('、');
        return centerTip(`${who}邀请${list}加入群聊`);
      },
      nudge  : (it) => {
        const who = (it.speaker || '有人').trim();
        const obj = (Array.isArray(it.args) && it.args[0] ? String(it.args[0]).trim() : '对方');
        return centerTip(`${who} 拍了拍 ${obj}`);
      },
      sig    : () => null, // 不渲染，顶部状态会更新

      // 侧边消息
      txt    : (it) => wrapSide(it, bubble(it.args?.[0] ?? '')),
      bqb    : renderBQB,
      voice  : renderVoice,
      dmt    : renderDmt,
      file   : renderFile,
      loc    : renderLoc,
      mmtshare: renderMmtshare,
      xfr    : (it) => xfrCard('xfr', it),
      'xfr.rcv': (it) => xfrCard('xfr.rcv', it),
      'xfr.rfd': (it) => xfrCard('xfr.rfd', it),

      __default: (it) => wrapSide(it, bubble(it.args?.[0] ?? it.content ?? ''))
    };

    const renderOne = (it) => {
      const fn = renderers[it.type] || renderers.__default;
      const out = fn?.(it);
      if (!out) return; // 如 sig
      main.appendChild(out.el);
    };

    // ---------- 数据订阅 ----------
    this._unsubChat = RMQQ.Data.subscribeChat(
      { login: this.login, kind: this.kind, peer: this.peerName },
      e => {
        if (e.type === 'init') {
          main.innerHTML = '';
          e.items.forEach(renderOne);
          applySigStatus();
          scrollToBottom();
        } else if (e.type === 'append') {
          e.items.forEach(renderOne);
          applySigStatus();
          scrollToBottom();
        }
      },
    );

    RMQQ.Data.setActiveChat?.({ login: this.login, kind: this.kind, peer: this.peerName });
    RMQQ.Data.markRead?.({ login: this.login, kind: this.kind, peer: this.peerName });

    // 顶部“其它会话未读总数”
    const hdr = this.root.querySelector('#cvHdrUnread');

let lastMsgTotal = 0;
let spaceUnseen = false;

const applyHdr = () => {
  const n = Math.max(0, (parseInt(lastMsgTotal || 0, 10) || 0) + (spaceUnseen ? 1 : 0));
  if (!hdr) return;
  if (n > 0) { hdr.textContent = n > 99 ? '99+' : String(n); hdr.classList.add('show'); }
  else hdr.classList.remove('show');
};

this._offHdrUnread?.();
this._offHdrUnread = RMQQ.Data.subscribeUnreadOfLogin?.(
  { login: this.login, exclude: { kind: this.kind, peer: this.peerName } },
  total => { lastMsgTotal = total || 0; applyHdr(); }
);

// 叠加“动态未浏览”：只要 append 就当作有 1
this._offHdrSpace?.();
this._offHdrSpace = RMQQ.Data.subscribeSpace?.({ login: this.login }, e => {
  const ms = Array.isArray(e?.moments) ? e.moments : [];
  const added = e?.type === 'append' && ms.length > 0;
  if (added) { spaceUnseen = true; applyHdr(); }
});

    // 列表委托（防重复绑定）
    const chatList = this.root.querySelector('.page--chats #chatList');
    if (chatList && !chatList.__rmqqDelegated) {
      chatList.__rmqqDelegated = true;
      chatList.addEventListener('click', e => {
        const li = e.target.closest('li.item'); if (!li) return;
        if (e.target.closest('.actions')) return;
        const title = li.querySelector('.title')?.textContent?.trim();
        const kind = li.dataset.kind === 'group' ? 'group' : 'dm';
        if (title) this.onOpenChat?.({ kind, peer: title, login: this.login });
      });
    }
  }

  onShow() {}

  unmount() {
    this._unsubChat?.(); this._unsubChat = null;
    this._offHdrUnread?.(); this._offHdrUnread = null;
    this._offHdrSpace?.(); this._offHdrSpace = null;
    RMQQ.Data.clearActiveChat?.();
    for (const [sel, type, fn] of this._handlers) {
      try { this.root.querySelector(sel)?.removeEventListener(type, fn); } catch {}
    }
    this._handlers.length = 0;
    this.root = null;
  }
}

        /* ----------------- SpaceView ----------------- */
class SpaceView {
  constructor({ login, onBack } = {}) {
  this.key = 'space';
  this.keepAlive = false;
  this.onBack = onBack;
  this.login = login;
  this.root = null;
  this._unsubSpace = null;
}

  mount(container) {
    this.root = container;
    this.root.innerHTML = `
<style>
  :root{
    --sv-bg:#F7F8FA;
    --sv-card:#FFFFFF;
    --sv-muted:#6b7280;
    --sv-border:#EDEEF2;
    --sv-tap:rgba(0,0,0,0.06);
    --sv-shadow:0 1px 2px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
    --sv-radius:16px;
    --sv-gap:12px;
    --sv-header-h:52px; /* 统一高度 */
    /* 读取你项目里其它视图的安全区变量，取不到再回退 env() */
    --sv-safe-top: var(--cv-safe-top, var(--tabs-safe-top, var(--qq-safe-top, env(safe-area-inset-top))));
  }

  .sv-wrap{ position:absolute; inset:0; background:#fff; display:flex; flex-direction:column; color:#111; --island-clearance: 10%; }

  /* 顶栏：与 chatview/tabsview 一致（安全区留白） */
  .sv-top{
    position:sticky; top:0; z-index:5;
    background:#fff;
    backdrop-filter:saturate(160%) blur(10px);
    border-bottom:1px solid var(--sv-border);
    display:flex; align-items:flex-end; gap:8px;
    padding: calc(env(safe-area-inset-top, 0px) + var(--island-clearance, 12px)) 12px 4px;
  }
  .sv-left, .sv-right{ display:flex; align-items:center; gap:8px; min-width:72px; }
  .sv-center{ flex:1; display:flex; justify-content:center; }
  .sv-title{ font-weight:700; font-size:15px; letter-spacing:.5px; }

  .sv-icon-btn{
    border:0; background:transparent; width:28px; height:28px; border-radius:10px; display:grid; place-items:center;
    -webkit-tap-highlight-color: transparent; cursor:pointer;
  }
  .sv-icon-btn:active{ background:var(--sv-tap); }
  .sv-icon-btn i{ font-size:16px; line-height:1; transform: translateY(2px); }

  /* 主滚动区 */
  .sv-body{ flex:1; overflow:auto; background:var(--sv-bg); }
  .sv-body::-webkit-scrollbar{ width:0; height:0; }
  .sv-scroller{ padding:12px; }

  /* 个人卡片 */
  .sv-profile-card{
    position:relative; border-radius:var(--sv-radius); overflow:hidden; background:#eee; box-shadow:var(--sv-shadow);
    aspect-ratio: 16/9;
    background-size:cover; background-position:center;
  }
  .sv-profile-mask{
    position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.00) 58%, rgba(0,0,0,0.36) 100%);
    pointer-events:none;
  }
  .sv-profile-info{
    position:absolute; left:10px; bottom:10px; display:flex; align-items:center; gap:10px; color:#fff; z-index:1;
  }
  .sv-avatar{ width:44px; height:44px; border-radius:999px; background:#dfe3ea center/cover no-repeat; box-shadow:0 2px 8px rgba(0,0,0,.2); }
  .sv-username{ font-weight:700; text-shadow:0 1px 2px rgba(0,0,0,.3); font-size:15px; }
  .sv-fav-btn{
    position:absolute; right:10px; bottom:10px; z-index:1;
    border:0; border-radius:12px; padding:8px 12px; display:flex; align-items:center; gap:8px;
    background:rgba(255,255,255,.96); color:#111; box-shadow:0 4px 12px rgba(0,0,0,.12); font-weight:600;
    cursor:pointer;
  }
  .sv-fav-btn:active{ transform:scale(.98); }
  .sv-fav-btn i{ font-size:16px; }

  /* 动态卡片 */
  .sv-moment{ background:#fff; border:1px solid var(--sv-border); border-radius:var(--sv-radius); padding:12px; margin-top:12px; box-shadow:var(--sv-shadow); }
  .sv-moment-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; }
  .sv-moment-author{ font-weight:600; font-size:14px; }
  .sv-moment-time{ color:var(--sv-muted); font-size:12px; }
  /* 定位行：跟时间一样大小与颜色 */
.sv-moment-loc{
  color: var(--sv-muted);
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 6px;
}
.sv-moment-loc i{
  font-size: 13px;
  transform: translateY(1px);
}
  .sv-moment-texts p{ margin:0; line-height:1.55; word-break:break-word; font-size:14px; }
  /* 同一块里的相邻元素统一拉开 8px 间距（txt 和 bqb 之间） */
.sv-moment-texts > * + * { margin-top: 8px; }
/* dmt 卡片与上面那块内容拉开 8px（txt/bqb 后面） */
.sv-moment .sv-dmt { margin-top: 8px; }
  .sv-moment-media{ margin-top:8px; border-radius:12px; overflow:hidden; background:#f0f3f6; }
  .sv-moment-media img{ width:100%; display:block; object-fit:cover; }
  /* dmt（SpaceView 版：灰遮罩，点击显示文字，1:1 正方形） */
.sv-dmt{
  position:relative; border-radius:12px; overflow:hidden;
  background:#eceff3; width:75%; aspect-ratio:1 / 1; cursor:pointer;
}
.sv-dmt-mask{
  position:absolute; inset:0; display:grid; place-items:center;
  background:#e5e9f0; color:#6b7280; font-size:22px; transition:opacity .18s ease;
}
.sv-dmt.is-open .sv-dmt-mask{ opacity:0; pointer-events:none; }
.sv-dmt-text{
  position:absolute; inset:0; padding:10px 12px; box-sizing:border-box;
  color:#111; background:transparent; overflow:auto; opacity:0; transition:opacity .18s ease;
  scrollbar-width:none; -ms-overflow-style:none;font-size:14px; line-height:1.55;
}
.sv-dmt-text::-webkit-scrollbar{ width:0; height:0; display:none; }
.sv-dmt.is-open .sv-dmt-text{ opacity:1; }

  .sv-moment-actions, .sv-moment-comments{ margin-top:6px; }
  /* 头部：头像 + 名字 + more */
.sv-ava{ width:32px; height:32px; border-radius:999px; background:#e9eef6 center/cover no-repeat; flex:0 0 32px; }
.sv-name{ font-weight:700; font-size:14px; }
.sv-more{ border:0; background:transparent; width:28px; height:28px; border-radius:10px; }
/* [NEW] 更多菜单 */
.sv-moment{ position: relative; }
.sv-more-menu{ position:absolute; right:8px; top:36px; z-index:10; background:#fff; border:1px solid #e8ecf2; border-radius:12px; padding:6px; box-shadow: 0 8px 20px rgba(0,0,0,.08); display:none; min-width:148px; }
.sv-more-menu.show{ display:block; }
.sv-more-menu .qa-item{ display:flex; align-items:center; gap:8px; width:100%; padding:8px 10px; border:0; background:transparent; border-radius:8px; cursor:pointer; font-size:14px; }
.sv-more-menu .qa-item:hover{ background:#f5f7fa; }
.sv-more-menu .qa-item i{ font-size:16px; }
.sv-more-menu .qa-item .y{ color:#f59e0b; }
.sv-more-menu .qa-item .b{ color:#3b82f6; }
.sv-more-menu .qa-item .r{ color:#ef4444; }
/* 第三行：时间在左，动作在右 */
.sv-moment-actions{ display:flex; align-items:center; justify-content:space-between; }
/* 两条动态之间画一条细线 */
#svFeed .sv-moment + .sv-moment{ position:relative; margin-top:18px; }
#svFeed .sv-moment + .sv-moment::before{
content:""; position:absolute; left:10px; right:10px; top:-10px; height:1px;
background: var(--sv-border);background: rgba(0,0,0,.10);pointer-events: none;
}
.sv-actions-right{ display:flex; align-items:center; gap:8px; }
.sv-act-btn{ border:0; background:transparent; cursor:pointer; width:24px; height:24px; display:grid; place-items:center;}
.sv-act-btn i{ font-size:18px; line-height:1;}
.sv-act-btn.liked i{ color:#1677ff; }     /* 点赞后变蓝 */
.sv-act-btn.is-like i{ transform: translateY(1px); }
.sv-act-btn.is-share i{ transform: translateY(-1px); }
  /* 第四行：点赞区（更柔） */
  .sv-likes{ font-size:12px; color:#6b7280; }
  /* 第五行：评论区 */
  .sv-comment{ font-size:13px; margin-top:6px; }
  .sv-comment .sv-name{ font-weight:600; margin-right:4px; }
  /* 第六行：输入区（银灰色） */
  .sv-input-row{ display:flex; align-items:center; gap:8px; padding:6px 8px; background:#f3f5f8; border-radius:12px; margin-bottom: 0; margin-top: 6px;}
  .sv-input-row .sv-ava{ width:20px; height:20px; border-radius: 9999px;overflow: hidden; flex: 0 0 20px;background-size: cover;background-position: center;background-repeat: no-repeat;}
  .sv-input-row input{ flex:1; border:0; outline:none; background:transparent; height:20px; font-size:14px; padding: 4px 0; }
  
  /* 空态 */
  .sv-empty{ color:var(--sv-muted); font-size:13px; text-align:center; padding:24px 0; }

  /* —— SpaceView 通用弹窗 —— */
.sv-modal-mask{ position:absolute; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:99; }
.sv-modal-mask.show{ display:flex; }
.sv-modal{ width:86%; max-width:340px; background:#fff; border:1px solid #e8ecf2; border-radius:14px; padding:12px; color:#111; }
.sv-modal .title{ font-weight:700; font-size:14px; margin-bottom:8px; }
.sv-field{ margin:8px 0; }
.sv-field input{ width:100%; height:32px; border:1px solid #eef1f5; border-radius:8px; padding:0 10px; outline:none; font-size:13px; }
.sv-tabs{ display:flex; gap:8px; margin:6px 0 10px; }
.sv-tabs button{ flex:1; height:30px; border-radius:8px; border:1px solid #e8ecf2; background:#fff; font-size:12px; }
.sv-tabs button.is-act{ background:#2b84ff; color:#fff; border-color:#2b84ff; }
.sv-list{ max-height:44vh; overflow:auto; border:1px solid #eef1f5; border-radius:10px; padding:4px; }
.sv-pick{ display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; }
.sv-pick + .sv-pick{ border-top:1px solid #f0f2f5; }
.sv-pick .ava{ width:34px; height:34px; border-radius:999px; background:#eef2f7 center/cover no-repeat; flex:0 0 auto; }
.sv-pick .name{ flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.sv-pick .chk{ width:22px; height:22px; border-radius:8px; border:1px solid #e5e7eb; display:grid; place-items:center; color:#fff; }
.sv-pick .chk i{ display:none; }
.sv-pick.sel .chk{ background:#2b84ff; border-color:#2b84ff; }
.sv-pick.sel .chk i{ display:block; }
.sv-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
.sv-btn{ border:1px solid #e8ecf2; background:#fff; border-radius:10px; padding:6px 10px; font-size:12px; }
.sv-btn.primary{ background:#2b84ff; color:#fff; border-color:#2b84ff; }

/* —— 已选项 —— */
.sv-selected{
display:flex; flex-wrap:wrap; gap:8px;
background:#fff; border:1px solid var(--sv-border);
border-radius:16px; padding:8px;
}
.sv-chip{ position:relative; display:inline-flex; align-items:center; gap:6px;
background:#f3f5f8; border:1px solid #e5e7eb; border-radius:12px;
padding:6px 28px 6px 8px; font-size:13px; }
.sv-chip .chip-img{ width:24px; height:24px; border-radius:6px; object-fit:cover; }
.sv-chip .chip-x{
  position:absolute;
  right:-6px; top:-6px;
  width:18px; height:18px;
  border:0; border-radius:50%;
  background:#ef4444; color:#fff;
  display:flex; align-items:center; justify-content:center; /* 居中 */
  padding:0; margin:0;
  font-size:12px;
  line-height:18px; /* 高度=行高，字符就垂直居中 */
  cursor:pointer;
}
/* —— BQB 选择器 —— */
.sv-modal .sv-bqb-grid{
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:6px;
  max-height:60vh;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:2px 2px 8px;
}

/* 卡片：去背景、去动效、更贴图 */
.sv-bqb-item{
  border:0;
  background:transparent;
  padding:4px;
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:pointer;
}

/* 正方形图片区域（仅此一版；不再有重复定义） */
.sv-bqb-imgbox{
  width:100%;
  aspect-ratio:1 / 1;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  border-radius:0;
  margin:0;
}

.sv-bqb-img{
  width:100%;
  height:auto;
  object-fit:contain;
  display:block;
}

.sv-bqb-label{
  margin-top:4px;
  font-size:10px;
  line-height:1.2;
  color:#6B7280;
  text-align:center;
  width:100%;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}

/* 小屏降列（保留自适应） */
@media (max-width:360px){
  .sv-modal .sv-bqb-grid{ grid-template-columns:repeat(3, minmax(0,1fr)); gap:6px; }
}
@media (max-width:300px){
  .sv-modal .sv-bqb-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); gap:6px; }
}

  /* 子视图：右→左（强制不透明背景） */
  .sv-subview{
    position:absolute; inset:0;
    background: var(--sv-sub-bg, #F2F4F7); /* ★ 不透明！ */
    display:flex; flex-direction:column; transform:translateX(100%);
    transition:transform .28s cubic-bezier(.4,0,2,1); z-index:10; pointer-events:none;
    isolation:isolate; /* 避免底层渗透 */
  }
  .sv-subview.sv-show{ transform:translateX(0); pointer-events:auto; }

  /* 子视图顶部栏：发布=银色；收藏=白色（与需求一致） */
  #svEditor .sv-top{ background:#F2F4F7; }
  #svFavsView .sv-top{ background:#fff; }
  #svEditor .sv-left, #svEditor .sv-right{ flex:0 0 72px; width:72px; }
  #svEditor .sv-right{ justify-content:flex-end; }

  /* 发布视图（全银色、更大输入、条目更高） */
  .sv-editor-wrap{ display:flex; flex-direction:column; height:100%; }
  .sv-editor-body{ flex:1; overflow:auto; }
  .sv-editor-scroller{ padding:12px; display:flex; flex-direction:column; gap:12px; }

  .sv-editor-input{
    background:#fff; border:1px solid var(--sv-border); border-radius:16px;
    padding:14px 14px 16px; min-height:160px;
    font-size:16px; line-height:1.6; width:100%; box-sizing:border-box; resize:none;
  }
  .sv-editor-input::placeholder{ color:#9aa1ac; }

  .sv-cells{ background:#fff; border:1px solid var(--sv-border); border-radius:16px; overflow:hidden; }
  .sv-cell{
    height:48px; display:flex; align-items:center; gap:12px; padding:0 14px;
    border-top:1px solid var(--sv-border);
  }
  .sv-cell:first-child{ border-top:none; }
  .sv-cell .sv-cell-ico{
    width:28px; height:28px; border-radius:9px; display:grid; place-items:center;
    background:transparent; flex:0 0 28px;
  }
  .sv-cell i{ font-size:18px; transform: translateY(2px);}
  .sv-cell .sv-cell-text{ font-size:15px; flex:1; }
  .sv-cell .sv-cell-desc{ font-size:13px; color:var(--sv-muted); }

  /* 顶栏里的“取消/发表”文本按钮（更像系统样式） */
  .sv-text-btn{
    border:0; background:transparent; padding:6px 10px; border-radius:9px; font-weight:700; cursor:pointer;
  }
  .sv-text-btn:active{ background:var(--sv-tap); }
  #svEditor .sv-text-btn{ transform: translateY(2px); }
  #svEditor .sv-publish-btn{ color:#1677ff; }
  .sv-publish-btn[disabled]{ opacity:.45; pointer-events:none; }

  /* 收藏视图主体（有背景） */
  .sv-favs-body{ flex:1; overflow:auto; background: var(--sv-sub-bg, #F2F4F7); }
  .sv-favs-body::-webkit-scrollbar{ width:0; height:0; }
  .sv-favs-scroller{ padding:12px; }
</style>

<div class="sv-wrap" role="dialog" aria-label="空间">
  <!-- 顶栏（白色） -->
  <div class="sv-top">
    <div class="sv-left">
      <button class="sv-icon-btn sv-btn-back" aria-label="返回" title="返回"><i class="fi fi-rr-angle-small-left"></i></button>
    </div>
    <div class="sv-center"><div class="sv-title">空间动态</div></div>
    <div class="sv-right">
      <button class="sv-icon-btn sv-btn-refresh" aria-label="刷新" title="刷新"><i class="fi fi-rr-refresh"></i></button>
      <button class="sv-icon-btn sv-btn-compose" aria-label="编写" title="编写"><i class="fi fi-rr-edit-message"></i></button>
    </div>
  </div>

  <!-- 主体滚动 -->
  <div class="sv-body">
    <div class="sv-scroller">
      <!-- 个人卡片 -->
      <section class="sv-profile-card" id="svProfileCard">
        <div class="sv-profile-mask"></div>
        <div class="sv-profile-info">
          <div class="sv-avatar" id="svAvatar"></div>
          <div class="sv-username" id="svUserName">未登录用户</div>
        </div>
        <button class="sv-fav-btn sv-btn-favs"><i class="fi fi-sr-wishlist-star"></i><span>收藏</span></button>
      </section>

      <!-- 动态列表（示例） -->
      <section id="svFeed">
        <article class="sv-moment">
          <div class="sv-moment-head">
            <div class="sv-moment-author">某人</div>
            <div class="sv-moment-time">刚刚</div>
          </div>
          <div class="sv-moment-texts"><p>空间第一条动态，样式已经统一啦～</p></div>
        </article>
      </section>

      <div class="sv-empty" id="svEmpty" style="display:none;">还没有动态</div>
    </div>
  </div>

  <!-- 发布子页（银色） -->
  <section class="sv-subview" id="svEditor">
    <div class="sv-top">
      <div class="sv-left">
        <button class="sv-text-btn sv-editor-cancel" aria-label="取消" title="取消">取消</button>
      </div>
      <div class="sv-center"><div class="sv-title">写说说</div></div>
      <div class="sv-right">
        <button class="sv-text-btn sv-publish-btn" aria-label="发表" title="发表">发表</button>
      </div>
    </div>
    <div class="sv-editor-wrap">
      <div class="sv-editor-body">
        <div class="sv-editor-scroller">
          <textarea class="sv-editor-input" id="svEditorInput" placeholder="这一刻的想法…"></textarea>
          <div class="sv-selected" id="svSelected"></div>
          <div class="sv-cells">
            <div class="sv-cell" data-act="dmt">
              <div class="sv-cell-ico"><i class="fi fi-rr-picture"></i></div>
              <div class="sv-cell-text">添加图片/视频</div>
              <div class="sv-cell-desc"></div>
            </div>
            <div class="sv-cell" data-act="bqb">
              <div class="sv-cell-ico"><i class="fi fi-rr-sticker"></i></div>
              <div class="sv-cell-text">添加表情包</div>
              <div class="sv-cell-desc"></div>
            </div>
            <div class="sv-cell" data-act="loc">
              <div class="sv-cell-ico"><i class="fi fi-rr-marker"></i></div>
              <div class="sv-cell-text">添加定位</div>
              <div class="sv-cell-desc"></div>
            </div>
            <div class="sv-cell" data-act="time">
              <div class="sv-cell-ico"><i class="fi fi-rr-time-twenty-four"></i></div>
              <div class="sv-cell-text">添加时间</div>
              <div class="sv-cell-desc"></div>
            </div>
            <div class="sv-cell">
              <div class="sv-cell-ico"><i class="fi fi-rr-eye"></i></div>
              <div class="sv-cell-text">谁能看见（暂未设计）</div>
              <div class="sv-cell-desc"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- 收藏子页（有背景、不透明覆盖） -->
  <section class="sv-subview" id="svFavsView">
    <div class="sv-top">
      <div class="sv-left">
        <button class="sv-icon-btn sv-favs-back" aria-label="返回" title="返回"><i class="fi fi-rr-angle-small-left"></i></button>
      </div>
      <div class="sv-center"><div class="sv-title">我的收藏</div></div>
      <div class="sv-right"></div>
    </div>
    <div class="sv-favs-body">
      <div class="sv-favs-scroller" id="svFavsBody">
        <div class="sv-empty">还没有收藏内容</div>
      </div>
    </div>
  </section>

  <!-- 分享弹窗（SpaceView 内） -->
<div class="sv-modal-mask" id="svShareMask" aria-hidden="true">
<div class="sv-modal" role="dialog" aria-label="分享至">
<div class="title">分享至</div>
<div class="sv-tabs top">
<button class="is-act" data-t="zone">QQ空间</button>
<button data-t="contacts">联系人</button>
</div>
<!-- 占位：QQ 空间 -->
<div class="sv-pane" id="svPaneZone">
<div class="sv-empty">（暂不实现，先留占位~）</div>
</div>
<!-- 选择联系人 -->
<div class="sv-pane" id="svPaneContacts" hidden>
<div class="sv-field"><input id="svShareSearch" placeholder="搜索好友/群聊"></div>
<div class="sv-tabs mid">
<button class="is-act" data-k="friends">好友</button>
<button data-k="groups">群聊</button>
</div>
<div class="sv-list" id="svShareList"></div>
</div>
<div class="sv-actions"><button class="sv-btn" id="svShareCancel">取消</button><button class="sv-btn primary" id="svShareSend">发送</button></div>
</div>
</div>

</div>
`;

    // ---------- 占位数据 ----------
  const setBg = (el, url) => { el && (el.style.backgroundImage = `url('${url}')`); };
  setBg(this.root.querySelector('#svProfileCard'),
    'https://i.postimg.cc/dtJ9Qqv2/file-00000000a35b-qqspacebg.jpg');

  // 覆盖：读取“RMPhone手机设置/按账号”的 SpaceView 背景
(async () => {
  try {
    const rm = await RMPhoneToWorldBook.getApp('rmphone');
    const bg = rm?.login?.[loginName]?.spaceview?.bg;
    if (bg) setBg(this.root.querySelector('#svProfileCard'), bg);
  } catch {}
})();

  const loginName = this.login || RMQQ.Data.getDefaultLogin?.() || '未登录用户';
  const name = this.root.querySelector('#svUserName');
  if (name) name.textContent = loginName;

  // 先清空头像，异步取“世界书”里当前登录的头像地址（有就替换）
  (async () => {
    try {
      const wb = await RMPhoneToWorldBook.getApp('qq');
      const url = wb?.login?.[loginName]?.avatar;
      if (url) setBg(this.root.querySelector('#svAvatar'), url);
    } catch {}
  })();

    // ---------- 订阅空间数据（只读） ----------
const feed  = this.root.querySelector('#svFeed');   // 已有：动态列表容器
const empty = this.root.querySelector('#svEmpty');  // 已有：空态占位

// 小工具：把时间戳变成人能看懂的
const fmtTime = (ts) => {
  try { return new Date(Number(ts) || Date.now()).toLocaleString(); }
  catch { return '刚刚'; }
};

const renderMoment = (m) => {
  // 优先级：txt > bqb > dmt > loc
  const items = Array.isArray(m.items) ? m.items : [];
  const pick = (t) => items.filter(x => x && x.type === t);

  const firstTxt = pick('txt')[0];
  const author   = (firstTxt && (firstTxt.speaker || firstTxt.author)) || m.author || m.user || m.owner || '某人';
  // [C1] 优先用 [time||...] 的原样文本；没有再回退到 ts（当前时间）
const tItem   = (Array.isArray(m.items) ? m.items : []).find(x => x && x.type === 'time');
const rawTime = tItem && tItem.content ? String(tItem.content).trim() : '';
const ts      = Number(m.ts) || Date.now();

  const art = document.createElement('article');
  art.className = 'sv-moment';

  // ========== (1) 顶部：头像 + 名字 + more ==========
  const row1 = document.createElement('div');
  row1.className = 'sv-moment-head';

  const left = document.createElement('div');
  left.style.display = 'flex';
  left.style.alignItems = 'center';
  left.style.gap = '8px';
  const ava = document.createElement('div');
  ava.className = 'sv-ava';
  const DEFAULT_AVATAR = 'https://files.catbox.moe/pcwffp.jpg';
(async () => {
  try {
    const wb = this._wbQQ || await RMPhoneToWorldBook.getApp('qq');
    let url = '';

    // 1) 自己发的：直接用自己的头像
    if (author === (this.login || '')) {
      url = wb?.login?.[this.login]?.avatar || '';
    }

    // 2) 好友映射
    if (!url) {
      url = wb?.login?.[this.login]?.contacts?.friends?.[author]?.avatar || '';
    }

    // 3) 兜底：如果 author 恰好是另一个已登录帐号的名字，也读它的头像
    if (!url) {
      url = wb?.login?.[author]?.avatar || '';
    }

    setBg(ava, url || DEFAULT_AVATAR);
  } catch {
    setBg(ava, DEFAULT_AVATAR);
  }
})();
  const nameEl = document.createElement('div');
  nameEl.className = 'sv-name';
  nameEl.textContent = author;
  left.append(ava, nameEl);

  const more = document.createElement('button');
  more.className = 'sv-more';
  more.innerHTML = '<i class="fi fi-rr-menu-dots"></i>';

  // [NEW] 右上角更多菜单（收藏 / 存入楼层 / 删除）
const menu = document.createElement('div');
menu.className = 'sv-more-menu';
menu.innerHTML = `
<button class="qa-item act-fav" type="button"><i class="fi fi-sr-wishlist-star y"></i><span class="txt">收藏</span></button>
<button class="qa-item act-pin" type="button"><i class="fi fi-rr-floppy-disk-pen b"></i><span class="txt">存入楼层</span></button>
<button class="qa-item act-del" type="button"><i class="fi fi-rr-trash r"></i><span>删除</span></button>`;
art.appendChild(menu);


const hideMenu = () => menu.classList.remove('show');
more.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('show'); }, {passive:true});
document.addEventListener('click', hideMenu, { once:true });


const btnFav = menu.querySelector('.act-fav');
const btnPin = menu.querySelector('.act-pin');
const btnDel = menu.querySelector('.act-del');


// 统一取当前账号的小函数
const getCurLogin = () =>
  this.login
  || RMQQ.Data.getActiveLogin?.()
  || RMQQ.Data.getDefaultLogin?.()
  || loginName;

// [NEW] 自动“存入楼层”（如果还没入）
const autoPin = async () => {
  const curLogin = getCurLogin();
  const st = RMQQ.Data.isLaneSaved?.({ login: curLogin, lane: m.lane }) || { inZone: !m.pending };
  if (!st.inZone) {
    RMQQ.Data.acceptPendingZone?.({ login: curLogin, lanes: m.lane });
  }
  await RMQQ.Data.commit?.();
};

// 同步更多菜单的文字
const syncMenuText = async () => {
  const curLogin = getCurLogin();
  const isFav = await (globalThis.Favs?.has?.(curLogin, m.lane) || false);
  btnFav.querySelector('.txt').textContent = isFav ? '取消收藏' : '收藏';

  const st = RMQQ.Data.isLaneSaved?.({ login: curLogin, lane: m.lane })
            || { inZone: !m.pending, inPending: !!m.pending };
  const saved = !!st.inZone;
  btnPin.querySelector('.txt').textContent = saved ? '取消存入' : '存入楼层';
};
setTimeout(syncMenuText, 0);

// 点击“收藏/取消收藏”
btnFav?.addEventListener('click', async () => {
  const curLogin = getCurLogin();
  const api = globalThis.Favs; if (!api) return;
const isFav = await api.has(curLogin, m.lane);
if (isFav) { await api.remove(curLogin, m.lane); }
else { await api.add(curLogin, m); }
  await syncMenuText();

  // 收藏页开着就顺手刷新一下
  if ($('#svFavsView')?.classList.contains('sv-show')) {
    await refreshFavs(curLogin);
  }
  hideMenu();
});

// 点击“存入/取消存入”
btnPin?.addEventListener('click', async () => {
  const curLogin = getCurLogin();
  const st = RMQQ.Data.isLaneSaved?.({ login: curLogin, lane: m.lane })
            || { inZone: !m.pending, inPending: !!m.pending };

  if (st.inZone) {
    RMQQ.Data.moveToPending?.({ login: curLogin, lanes: m.lane });
    await RMQQ.Data.commit?.();
  } else {
    RMQQ.Data.acceptPendingZone?.({ login: curLogin, lanes: m.lane });
    await RMQQ.Data.commit?.();
  }
  await syncMenuText();
  hideMenu();
});

btnDel?.addEventListener('click', ()=>{
const dlg = openSvDialog.call(this, '确认删除此动态吗？', `<div style="padding:8px 2px;color:#6b7280">删除后将从“收藏/楼层/PendingZone”全部移除，且不可恢复。</div>`, async ()=>{
try { await Favs.remove(this.login, m.lane); } catch {}
RMQQ.Data.removeMomentsEverywhere?.({ login:this.login, lanes:m.lane });
await RMQQ.Data.commit?.();
// 从当前列表移除这张卡（视觉反馈），真正的刷新由订阅负责
try { art.remove(); } catch {}
});
const okBtn = dlg && dlg.querySelector('#_svDlgOK');
if (okBtn) okBtn.textContent = '确认';
});

  row1.append(left, more);
  art.appendChild(row1);

// ========== (2) 内容区：按 txt > bqb > dmt > loc ==========
const row2 = document.createElement('div');
row2.className = 'sv-moment-texts';

// 2.1 文字
const txtVal = (firstTxt && String(firstTxt.content || '').trim()) || String(m.text || m.content || '').trim();
if (txtVal) { const p = document.createElement('p'); p.textContent = txtVal; row2.appendChild(p); }

// 2.2 表情包（bqb）
const bqbs = pick('bqb');
if (bqbs.length) {
const wrap = document.createElement('div');
wrap.className = 'sv-bqb-wrap';
wrap.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;';
bqbs.forEach(it => {
const name = Array.isArray(it.args) ? (it.args[0] || '') : (it.content || '');
const url = Array.isArray(it.args) ? (it.args[1] || '') : (it.url || '');
const img = document.createElement('img');
img.alt = name || 'bqb';
img.src = normCatboxUrl(String(url || ''));
img.style.cssText = 'max-width:120px;display:block;border-radius:12px;';
const box = document.createElement('div'); box.className = 'sv-bqb'; box.appendChild(img);
wrap.appendChild(box);
});
row2.appendChild(wrap);
}

// 先把“文字+表情包”这一块挂上去
art.appendChild(row2);

// 2.3 卡片（dmt）
const dmtIt = pick('dmt')[0];
if (dmtIt) {
const text = Array.isArray(dmtIt.args) ? (dmtIt.args[0] || '') : (dmtIt.content || '');
const box = document.createElement('div'); box.className = 'sv-dmt'; box.title = '点击展开/收起';
const mask = document.createElement('div'); mask.className = 'sv-dmt-mask'; mask.innerHTML = '<i class="fi fi-rr-screen-play"></i>';
const body = document.createElement('div'); body.className = 'sv-dmt-text'; body.textContent = text;
box.append(mask, body);
box.addEventListener('click', () => box.classList.toggle('is-open'));
art.appendChild(box);
}

// 2.4 定位（loc）
const locIt = pick('loc')[0];
if (locIt && (locIt.args?.[0] || locIt.content)) {
  const p = document.createElement('p');
  p.className = 'sv-moment-loc';

  // 图标
  const ico = document.createElement('i');
  ico.className = 'fi fi-rr-marker';
  ico.setAttribute('aria-hidden', 'true');

  // 文案（用 textContent，避免被当成 HTML）
  const txt = document.createElement('span');
  txt.textContent = String(locIt.args?.[0] || locIt.content);

  p.append(ico, txt);
  art.appendChild(p);
}

  // ========== (3) 信息/功能：左边时间；右边 3 个图标 ==========
  const row3 = document.createElement('div');
  row3.className = 'sv-moment-actions';
  const time = document.createElement('div');
  time.className = 'sv-moment-time';
  // [C2] 有 time 原文就用原文；没有就显示当前时间（本地格式）
  time.textContent = rawTime || fmtTime(ts);

  const acts = document.createElement('div');
  acts.className = 'sv-actions-right';

  // 点赞
  const likeBtn = document.createElement('button');
  likeBtn.className = 'sv-act-btn is-like';
  const likeIco = document.createElement('i');
  likeIco.className = 'fi fi-rr-social-network';
  likeBtn.appendChild(likeIco);

  // 评论
  const cmtBtn = document.createElement('button');
  cmtBtn.className = 'sv-act-btn is-cmt';
  cmtBtn.innerHTML = '<i class="fi fi-rr-comment-dots"></i>';

  // 转发
  const shareBtn = document.createElement('button');
  shareBtn.className = 'sv-act-btn is-share';
  shareBtn.innerHTML = '<i class="fi fi-rr-redo"></i>';
  shareBtn.addEventListener('click', () => openShare(m.lane));

  acts.append(likeBtn, cmtBtn, shareBtn);
  row3.append(time, acts);
  art.appendChild(row3);

  // ========== (4) 点赞区 ==========
  const likes = document.createElement('div');
  likes.className = 'sv-likes';
  likes.textContent = '';             // 初始无
  likes.dataset.names = '';           // 用空格分隔内部小状态
  art.appendChild(likes);

  // [INIT] 从数据里读 like，初始化点赞区
{
  const meName = this.login || RMQQ.Data.getDefaultLogin?.() || '';
  const likeIts = pick('like');
  const names = [];

  likeIts.forEach(it => {
    const n = (it.speaker || it.author || it.args?.[0] || it.content || '').trim();
    if (n) names.push(n);
  });

  const set = new Set(names);
  likes.dataset.names = Array.from(set).join(' ');
  likes.textContent = set.size ? Array.from(set).join('、') + ' 赞了' : '';

  // 如果自己在已赞名单里，按钮置为“已赞”
  if (meName && set.has(meName)) {
    likeBtn.classList.add('liked');
    likeIco.className = 'fi fi-sr-thumbs-up';
  }
}

  // 点赞切换逻辑
// 点赞：切 UI + 真正写入一条 [like|我]
likeBtn.addEventListener('click', async () => {
  const meName = getCurLogin();
  const liked = likeBtn.classList.toggle('liked');
  likeIco.className = liked ? 'fi fi-sr-thumbs-up' : 'fi fi-rr-social-network';

  const set = new Set((likes.dataset.names || '').split(' ').filter(Boolean));
  if (liked) {
    set.add(meName);
    likes.dataset.names = Array.from(set).join(' ');
    likes.textContent = set.size ? Array.from(set).join('、') + ' 赞了' : '';

    // 数据写入： [like|我]
    RMQQ.Data.appendMomentItem?.({ login: meName, lane: m.lane, type: 'like', speaker: meName });
    await autoPin();     // 写完立即“存入楼层”
  } else {
    // 只更新 UI；如果你以后想“取消赞时把记录删掉”，可以再加一个 Data 的删除 API
    set.delete(meName);
    likes.dataset.names = Array.from(set).join(' ');
    likes.textContent = set.size ? Array.from(set).join('、') + ' 赞了' : '';
  }
});

  // ========== (5) 评论区 ==========
  const cmts = document.createElement('div');
  cmts.className = 'sv-moment-comments';
  art.appendChild(cmts);

  // [NEW] 先把已有评论渲染出来
{
  const cmtIts = [...pick('comment'), ...pick('reply')]; // 当前动态里的 comment 条目
  cmtIts.forEach(it => {
    const one = document.createElement('div');
    one.className = 'sv-comment';

    const nm = document.createElement('span');
    nm.className = 'sv-name';
    nm.textContent = (it.speaker || it.author || '某人') + (it.type === 'comment' ? '：' : '');

    const tx = document.createElement('span');
    tx.textContent = (String(it.type||'')==='reply') ? (Array.isArray(it.args)?(it.args[1]||''):(it.content||'')) : (Array.isArray(it.args)?(it.args[0]||''):(it.content||''));

    if (String(it.type||'') === 'reply') {
  const pre = document.createElement('strong');
  pre.textContent = `回复@${Array.isArray(it.args)?(it.args[0]||''):''}：`;
  one.append(nm, pre, tx);
} else {
  one.append(nm, tx);
}
    cmts.appendChild(one);
  });
}

  // ========== (6) 输入区：左头像 + 右输入 ==========
  const row6 = document.createElement('div');
  row6.className = 'sv-input-row';
  const meAva = document.createElement('div');
  meAva.className = 'sv-ava';
  // [B] 输入框左侧头像 = 当前账号头像
(async () => {
  try {
    const wb = await RMPhoneToWorldBook.getApp('qq');
    const me = wb?.login?.[(this.login || RMQQ.Data.getDefaultLogin?.())];
    const url = me?.avatar;
    if (url) setBg(meAva, url);    // setBg 已在上面定义过
  } catch {}
})();
  const ipt = document.createElement('input');
  ipt.placeholder = '写评论…';
  // [NEW] 回复逻辑
let replyTo = null;
const setReplyHint = () => { ipt.placeholder = replyTo ? `回复@${replyTo}：` : '写评论…'; };

// 点击“他人的评论”→ 进入回复模式
cmts.addEventListener('click', (e) => {
  const el = e.target.closest('.sv-comment');
  if (!el) return;
  const nameEl = el.querySelector('.sv-name');
  let target = (nameEl?.textContent || '').replace(/：$/, '').trim();
  const meName = getCurLogin();
  if (target && target !== meName) {
    replyTo = target;
    setReplyHint();
    ipt.focus();
  }
});

// 失焦→ 退出回复模式
ipt.addEventListener('blur', () => { replyTo = null; setReplyHint(); });

  row6.append(meAva, ipt);
  art.appendChild(row6);
  cmtBtn.addEventListener('click', () => ipt?.focus());

  // 回车发送：根据是否处于“回复模式”，生成 comment 或 reply
ipt.addEventListener('keydown', async (e) => {
  if (e.key !== 'Enter') return;
  const v = (ipt.value || '').trim();
  if (!v) return;

  const meName = getCurLogin();

  if (replyTo) {
    // UI：我 回复 @对方：内容
    const one = document.createElement('div');
    one.className = 'sv-comment';
    const nm = document.createElement('span'); nm.className = 'sv-name'; nm.textContent = meName;
    const pre = document.createElement('strong'); pre.textContent = `回复@${replyTo}：`;
const ct  = document.createElement('span');   ct.textContent  = v;
one.append(nm, pre, ct);
    cmts.appendChild(one);

    // 数据： [reply|我|对方|内容]
    RMQQ.Data.appendMomentItem?.({ login: meName, lane: m.lane, type: 'reply', speaker: meName, args: [replyTo, v] });

    replyTo = null; setReplyHint();   // 用完退出回复模式
  } else {
    // UI：我：内容
    const one = document.createElement('div');
    one.className = 'sv-comment';
    const nm = document.createElement('span'); nm.className = 'sv-name'; nm.textContent = meName + '：';
    const tx = document.createElement('span'); tx.textContent = v;
    one.append(nm, tx); cmts.appendChild(one);

    // 数据： [comment|我|内容]
    RMQQ.Data.appendMomentItem?.({ login: meName, lane: m.lane, type: 'comment', speaker: meName, args: [v] });
  }

  ipt.value = '';
  await autoPin();  // 统一自动“存入楼层”
});

  return art;
};

// 画某个 zone 下的一组动态（先简单展平：zone 标题后面接它的 moments）
const renderZone = (zone) => {
  // 可选：给每个 zone 加个分隔标题
  if (zone?.name) {
    const title = document.createElement('div');
    title.className = 'sv-empty'; // 先借用空态样式，小灰字当分组标题
    title.textContent = zone.name;
    feed.appendChild(title);
  }
  const list = Array.isArray(zone?.moments) ? zone.moments : (zone?.lanes || []);
  list.forEach(m => feed.appendChild(renderMoment(m)));
};

// 全量刷新
const renderAll = (payload) => {
  feed.innerHTML = '';

  // 订阅实际回的是 moments，不是 zones
  const moments = Array.isArray(payload?.moments) ? payload.moments : [];

  // 直接渲染原始 moment（这样能拿到 lane 等字段，转发时必需）
  moments.forEach(m => feed.appendChild(renderMoment(m)));

  // 空态
  if (empty) empty.style.display = moments.length ? 'none' : '';
};

// 增量追加（如果 Data 有推 append）
const appendSome = (payload) => {
  const items = Array.isArray(payload?.items) ? payload.items : [];
  if (items.length) {
    items.forEach(it => feed.insertAdjacentElement('afterbegin', renderMoment(it)));
    if (empty) empty.style.display = 'none';
  }
};

// ★ 订阅：只读空间流（按当前 login）
this._unsubSpace?.(); // 防重复
this._unsubSpace = RMQQ.Data.subscribeSpace?.(
  { login: this.login },          // 当前账号（只看自己的空间）
  (e) => {
    if (!e) return;
    if (e.type === 'init' || e.type === 'reset') renderAll(e);
    else if (e.type === 'append') appendSome(e);
  }
);

    // ---------- 交互 ----------
    const $ = (sel) => this.root.querySelector(sel);
    const back = () => this.onBack?.();

    const openEditor = () => { $('#svEditor')?.classList.add('sv-show'); syncPublishState(); };
    const closeEditor = () => $('#svEditor')?.classList.remove('sv-show');

    const openFavs = async () => {
  const curLogin =
    this.login
    || RMQQ.Data.getActiveLogin?.()
    || RMQQ.Data.getDefaultLogin?.()
    || loginName; // loginName 在上面已经算过
  await refreshFavs(curLogin);
  $('#svFavsView')?.classList.add('sv-show');
};
    const closeFavs = () => $('#svFavsView')?.classList.remove('sv-show');

// 2) 改刷新收藏页：只渲染当前账号
async function refreshFavs(login){
  const body = $('#svFavsBody'); if (!body) return;
  body.innerHTML = '';
  const list = await Favs.list(login);
  if (!list.length){
    body.innerHTML = '<div class="sv-empty">暂无收藏</div>';
    return;
  }
  list.sort((a,b)=> (b?.moment?.ts||0) - (a?.moment?.ts||0));
  list.forEach(row => { if (row?.moment) body.appendChild(renderMoment(row.moment)); });
}

    const spinOnce = (btn) => {
      if (!btn) return;
      const ico = btn.querySelector('i');
      ico?.animate([{ transform:'rotate(0deg)' }, { transform:'rotate(360deg)' }], { duration:500 });
    };

    // 顶栏按钮
    $('.sv-btn-back')?.addEventListener('click', back);
        // 刷新：弹窗 -> 输入 -> 调用 generate -> 清空旧 pending -> 写入新 pending（自动触发渲染）
    $('.sv-btn-refresh')?.addEventListener('click', () => {
      const loginName = this.login || RMQQ.Data.getActiveLogin?.() || '未登录用户';
      const defaultText = `请根据剧情，设计${loginName}的QQ空间动态内容，不少于7条。`;

      const dlg = openSvDialog.call(
        this,
        '是否刷新QQ空间内容？（此操作会清空所有未存入本地的动态）',
        `<div class="sv-field">
           <textarea id="_svGenInput" class="sv-editor-input" style="min-height:120px;"></textarea>
         </div>`,
        async (mask) => {
          const ta = mask.querySelector('#_svGenInput');
          const user_input = String((ta?.value || defaultText)).trim();
          if (!user_input) return;

          const btn = this.root.querySelector('.sv-btn-refresh');
          btn?.setAttribute('disabled', 'true');
          // 让图标转一圈（已有工具）
          spinOnce?.(btn);

          let raw = '';
          try {
            // 1) 清掉旧的 pendingzone
            RMQQ.Data.clearPendingZone?.({ login: this.login });

            // 2) 调用 generate（把“输入框内容”直接当作 user_input 传入）
            raw = await generate?.({ user_input });

            // 3) 解析 -> 写入 pending（applyRaw 会自动把 ZONE/MOMENT 丢进 pending）
            const changed = RMQQ.Data.applyRaw?.(raw);

            // 4) 若未产出可用内容，则当成解析失败
            if (!changed) throw new Error('生成内容不可解析或未产生任何动态');

            // 5) 订阅会自动刷新 SpaceView，无需手动渲染
          } catch (err) {
            // 模仿 chatview 的“返回值解析失败”提示
            openSvGenErrorDialog.call(this, String(raw || err?.message || '生成失败'));
          } finally {
            btn?.removeAttribute('disabled');
          }
        }
      );

      // 打开后把默认文案灌进去（可修改）
            const _ta = dlg && dlg.querySelector('#_svGenInput');
      if (_ta) _ta.value = defaultText;
    });

    $('.sv-btn-compose')?.addEventListener('click', openEditor);

    // 个人卡片：收藏 -> 子页
    $('.sv-btn-favs')?.addEventListener('click', openFavs);

    // [A2] 点背景改图（不拦收藏按钮）
const profile = $('#svProfileCard');
profile?.addEventListener('click', (e) => {
  // 点到收藏按钮就直接放行
  if (e.target.closest('.sv-btn-favs')) return;

  // 弹窗输入图片 URL
  const dlg = openSvDialog.call(this, '修改背景图', `
    <div class="sv-field"><input id="_svBgUrl" placeholder="图片 URL"></div>
  `, async (mask) => {
    const url = (mask.querySelector('#_svBgUrl')?.value || '').trim();
    if (!url) return;

    // 立刻更新 UI
    setBg(profile, url);

    // 写入 世界书 → apps.rmphone.login[当前账号].spaceview.bg
    try {
      const rm = (await RMPhoneToWorldBook.getApp('rmphone')) || {};
      const next = JSON.parse(JSON.stringify(rm));
      (next.login ||= {});
      (next.login[loginName] ||= {});
      (next.login[loginName].spaceview ||= {});
      next.login[loginName].spaceview.bg = url;
      await RMPhoneToWorldBook.saveApp('rmphone', next);
    } catch (err) { console.warn('保存背景失败', err); }
  });

  // 预填当前背景
  const ipt = dlg.querySelector('#_svBgUrl');
  if (ipt) {
    const cur = getComputedStyle(profile).backgroundImage;
    const m = cur && cur.match(/url\(["']?(.+?)["']?\)/i);
    ipt.value = m ? m[1] : '';
    ipt.focus(); ipt.select?.();
  }
}, { passive:true });

    // 发布子页
    $('.sv-editor-cancel')?.addEventListener('click', closeEditor);
    const publishBtn = $('.sv-publish-btn');
    const editorInput = $('#svEditorInput');
    const syncPublishState = () => {
  const hasTxt = (editorInput?.value || '').trim().length > 0;
  // 关键：用 globalThis.draft，避免 TDZ
  const d = globalThis.draft;
  const hasAttach = !!(d && Array.isArray(d.items) && d.items.length > 0);
  const has = hasTxt || hasAttach;
  if (has) publishBtn?.removeAttribute('disabled');
  else publishBtn?.setAttribute('disabled','');
};

// 在 const editorInput = $('#svEditorInput'); 和 const syncPublishState = () => { ... } 之后
editorInput?.addEventListener('input', syncPublishState);
//（可选）中文输入法场景更稳一点
editorInput?.addEventListener('compositionend', syncPublishState);

  // —— 草稿：把四类条目都先收集起来 —— 
const draft = (globalThis.draft ||= { items: [], ts: 0 }); // ts=0 表示还没选“时间”

// 快捷：设置每个条目的右侧说明文字
const setDesc = (act, text) => {
  const cell = this.root.querySelector('#svEditor .sv-cell[data-act="'+act+'"]');
  if (cell) cell.querySelector('.sv-cell-desc').textContent = text || '';
  renderSelected();
  syncPublishState();
};

// 添加项（避免重复堆同类型的单一值）
const upsertItem = (type, payload) => {
  // 允许同类多条：bqb 可多选；dmt/loc/time 业务上通常 1 条，先简单处理为“覆盖”
  if (type === 'dmt' || type === 'loc' || type === 'time') {
    draft.items = draft.items.filter(it => it.type !== type);
  }
  draft.items.push(payload);
};

// 低层 setter：只改右侧小字，不触发其它逻辑
const _setCellDescRaw = (act, text) => {
  const cell = this.root.querySelector('#svEditor .sv-cell[data-act="'+act+'"]');
  if (cell) cell.querySelector('.sv-cell-desc').textContent = text || '';
};

const selectedBox = this.root.querySelector('#svSelected');

function renderSelected(){
  if (!selectedBox) return;
  selectedBox.innerHTML = '';
  const its = draft.items;
  if (!its.length){ selectedBox.style.display = 'none'; return; }
  selectedBox.style.display = 'flex';

  // 分门别类
  const dmts = its.filter(i=>i.type==='dmt');
  const loc  = its.find(i=>i.type==='loc');
  const time = its.find(i=>i.type==='time');
  const bqbs = its.filter(i=>i.type==='bqb');

  // dmt 只有 1 条（按现在的规则是覆盖）
  if (dmts[0]){
    const txt = Array.isArray(dmts[0].args)?(dmts[0].args[0]||''):String(dmts[0].content||'');
    const el = document.createElement('div');
    el.className = 'sv-chip';
    el.innerHTML = `<i class="fi fi-rr-picture"></i><span>${txt?txt:'图片/视频'}</span>
      <button class="chip-x" data-type="dmt" aria-label="删除">×</button>`;
    selectedBox.appendChild(el);
  }

  if (loc){
    const val = Array.isArray(loc.args)?(loc.args[0]||''):String(loc.content||'');
    const el = document.createElement('div');
    el.className = 'sv-chip';
    el.innerHTML = `<i class="fi fi-rr-marker"></i><span>${val||'定位'}</span>
      <button class="chip-x" data-type="loc" aria-label="删除">×</button>`;
    selectedBox.appendChild(el);
  }

  if (time){
    const val = String(time.content||'');
    const el = document.createElement('div');
    el.className = 'sv-chip';
    el.innerHTML = `<i class="fi fi-rr-time-twenty-four"></i><span>${val||'时间'}</span>
      <button class="chip-x" data-type="time" aria-label="删除">×</button>`;
    selectedBox.appendChild(el);
  }

  // 每个 bqb 都可以单独删
  bqbs.forEach(it=>{
    const name = Array.isArray(it.args)?(it.args[0]||''):String(it.content||'');
    const url  = Array.isArray(it.args)?(it.args[1]||''):String(it.url||'');
    const el = document.createElement('div');
    el.className = 'sv-chip';
    el.innerHTML = `<img class="chip-img" alt="${name}" src="${normCatboxUrl(url)}">
      <span>${name||'表情'}</span>
      <button class="chip-x" data-type="bqb" data-key="${name}|${url}" aria-label="删除">×</button>`;
    selectedBox.appendChild(el);
  });
}

function syncDescs(){
  const hasDmt = draft.items.some(i=>i.type==='dmt');
  const loc = draft.items.find(i=>i.type==='loc');
  const time = draft.items.find(i=>i.type==='time');
  const bqbCount = draft.items.filter(i=>i.type==='bqb').length;
  _setCellDescRaw('dmt', hasDmt ? '已添加 1 项' : '');
  _setCellDescRaw('loc', loc ? (Array.isArray(loc.args)?(loc.args[0]||''):String(loc.content||'')) : '');
  _setCellDescRaw('time', time ? String(time.content||'') : '');
  _setCellDescRaw('bqb', bqbCount ? `已选 ${bqbCount} 个` : '');
}

// 点击 x 删除
selectedBox?.addEventListener('click', (e)=>{
  const btn = e.target.closest('.chip-x'); if(!btn) return;
  const type = btn.dataset.type;
  const key = btn.dataset.key || '';
  if (type === 'bqb'){
    draft.items = draft.items.filter(i=>!(i.type==='bqb' && (`${i.args?.[0]||''}|${i.args?.[1]||''}`===key)));
  } else if (type === 'dmt' || type === 'loc' || type === 'time'){
    draft.items = draft.items.filter(i=>i.type!==type);
    if (type === 'time') draft.ts = 0;
  }
  renderSelected();
  syncDescs();
  syncPublishState();
});

// —— 三个设置弹窗 ——

// 1) dmt：和 chatview 思路一样，存文本（可写描述/链接等）
const openDmtDialog = () => {
  openSvDialog.call(this, '添加图片/视频（dmt）', `
    <div class="sv-field"><input id="_iptDmt" placeholder="写点描述或放一个图片/视频链接"></div>
  `, dlg => {
    const v = String(dlg.querySelector('#_iptDmt')?.value || '').trim();
    if (!v) return;
    upsertItem('dmt', { type:'dmt', args:[v] });
    setDesc('dmt', '已添加 1 项');
  });
};

// 2) loc：写一个地名
const openLocDialog = () => {
  openSvDialog.call(this, '添加定位（loc）', `
    <div class="sv-field"><input id="_iptLoc" placeholder="例如：上海市 浦东新区 世纪大道"></div>
  `, dlg => {
    const v = String(dlg.querySelector('#_iptLoc')?.value || '').trim();
    if (!v) return;
    upsertItem('loc', { type:'loc', args:[v] });
    setDesc('loc', v);
  });
};

// 3) time：选填年月日，必填时/分；最终：存一个 time 项（content）并把 draft.ts 设定好
const pad = n => String(n).padStart(2,'0');
const openTimeDialog = () => {
  openSvDialog.call(this, '设置时间（time）', `
    <div class="sv-field"><input id="_iptY" placeholder="年（可空）"></div>
    <div class="sv-field"><input id="_iptM" placeholder="月（可空，1-12）"></div>
    <div class="sv-field"><input id="_iptD" placeholder="日（可空，1-31）"></div>
    <div class="sv-field"><input id="_iptH" placeholder="时（必填，0-23）"></div>
    <div class="sv-field"><input id="_iptI" placeholder="分（必填，0-59）"></div>
    <div style="color:#6b7280;font-size:12px;">不填年月日就用今天</div>
  `, dlg => {
    const Y = parseInt(dlg.querySelector('#_iptY')?.value || '', 10);
    const M = parseInt(dlg.querySelector('#_iptM')?.value || '', 10);
    const D = parseInt(dlg.querySelector('#_iptD')?.value || '', 10);
    const H = parseInt(dlg.querySelector('#_iptH')?.value || '', 10);
    const I = parseInt(dlg.querySelector('#_iptI')?.value || '', 10);
    if (Number.isNaN(H) || Number.isNaN(I)) return; // 时分必填

    const now = new Date();
    const y = Number.isNaN(Y) ? now.getFullYear() : Y;
    const m = Number.isNaN(M) ? (now.getMonth()+1) : M;
    const d = Number.isNaN(D) ? now.getDate() : D;
    const ms = new Date(y, m-1, d, Math.max(0,H), Math.max(0,I)).getTime();

    // 说说里 time 项用 content 字符串，Data 解析会把它吸到 moment.ts
    const content = `${y}-${pad(m)}-${pad(d)} ${pad(H)}:${pad(I)}`;
    upsertItem('time', { type:'time', content });
    draft.ts = ms;
    setDesc('time', content);
  });
};

// 4) bqb：弹出小面板，从“世界书：RMPhoneQQ表情存放”读取；点击即加入
// 安全转义一下文本（用于 data-* 和 html 片段）
const _escape = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

// 4) bqb：弹出小面板，从“世界书：RMPhoneQQ表情存放”读取；点击即加入
const openBqbPicker = async () => {
  // 先确保世界书条目已存在（第一次会自动创建默认示例）
  try { await RMPhoneToWorldBook.ensureQQEmojiStore?.(); } catch {}

  // 读取文本，解析 <bqb> 块里的 [名字|url] 行
  let txt = '';
  try { txt = (await RMPhoneToWorldBook.readQQEmojiStore?.()) || ''; } catch {}
  const m = txt.match(/<bqb>([\s\S]*?)<\/bqb>/i);
  const body = m ? m[1] : '';
  const lines = body.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

  const items = [];
  for (const line of lines) {
    const mm = line.match(/\[([^|\]]+)\|([^\]]+)\]/); // [label|url]
    if (!mm) continue;
    const label = mm[1];
    const rawUrl = mm[2];
    items.push({ name: label, url: rawUrl });
  }

  // 原来 const grid = items.map(...).join('') 那段，换成：
const grid = items.map(({name, url}) => `
  <button class="sv-bqb-item" data-name="${_escape(name)}" data-url="${_escape(url)}" title="${_escape(name)}">
    <div class="sv-bqb-imgbox">
      <img class="sv-bqb-img" alt="${_escape(name)}"
           src="${normCatboxUrl(url)}" loading="lazy" referrerpolicy="no-referrer">
    </div>
    <div class="sv-bqb-label">${_escape(name)}</div>
  </button>
`).join('');

// 原来 openSvDialog 里 inner 的容器 <div ...> 替换为：
const dlg = openSvDialog.call(this, '选择表情包（bqb）', `
  <div class="sv-bqb-grid">
    ${grid || '<div class="sv-empty">表情库是空的（先到 ChatView 里加几张）</div>'}
  </div>
`, ()=>{});

  dlg.querySelector('.sv-bqb-grid')?.addEventListener('click', e => {
  const btn = e.target.closest('.sv-bqb-item'); if (!btn) return;
  const name = btn.dataset.name || '';
  const url  = btn.dataset.url  || '';
  draft.items.push({ type:'bqb', args:[name, url] });
  setDesc('bqb', `已选 ${draft.items.filter(i=>i.type==='bqb').length} 个`);
}, { passive:true });

};

// —— 统一监听四个 cell 点击 —— 
$('#svEditor .sv-cells')?.addEventListener('click', e => {
  const cell = e.target.closest('.sv-cell'); if (!cell) return;
  const act  = cell.dataset.act;
  if (act === 'dmt') openDmtDialog();
  else if (act === 'bqb') openBqbPicker();
  else if (act === 'loc') openLocDialog();
  else if (act === 'time') openTimeDialog();
}, { passive:true });

// —— 发表：把 txt + 草稿 items 组装成“真正的消息类型”，走 Data.pending → accept → commit —— 
publishBtn?.addEventListener('click', async () => {
  const txt = (editorInput?.value || '').trim();
  if (!txt && draft.items.length === 0) return;

  // 组装 items：txt 永远在最前；bqb/dmt/loc/time 都是“真类型”
const items = [];
const speaker = this.login || '我';
if (txt) items.push({ type: 'txt', content: txt, speaker });
for (const it of draft.items) items.push({ ...it, speaker });

  // lane 用短随机串；时间：优先 draft.ts，其次当前时间
  const lane = Math.random().toString(36).slice(2,8);
  const moment = { kind:'moment', lane, ts: draft.ts || Date.now(), items };

  // 丢到 pending（先不写 _data），让订阅自然刷新
  RMQQ.Data.pushPendingZone?.(this.login, [moment]);

  // 接受并持久化（真正写回 _data）
  RMQQ.Data.acceptPendingZone?.({ login: this.login, lanes: lane });
  await RMQQ.Data.commit?.();

  // 清空表单 & 草稿
  editorInput.value = '';
  draft.items = [];
  draft.ts = 0;
  setDesc('dmt',''); setDesc('bqb',''); setDesc('loc',''); setDesc('time','');

  syncPublishState();
  closeEditor();
});


    // 收藏子页返回
    $('.sv-favs-back')?.addEventListener('click', closeFavs);

// —— 工具 ——
const $sv = (sel) => this.root.querySelector(sel);
const showMask = (el) => el && el.classList.add('show');
const hideMask = (el) => el && el.classList.remove('show');

// —— 弹窗小工具（SpaceView）——
function openSvDialog(title, inner, onOK){
  const mask = document.createElement('div');
  mask.className = 'sv-modal-mask show';
  mask.innerHTML = `
    <div class="sv-modal" role="dialog" aria-label="${title}">
      <div class="title">${title}</div>
      <div class="sv-body">${inner}</div>
      <div class="sv-actions">
        <button class="sv-btn" id="_svDlgCancel">取消</button>
        <button class="sv-btn primary" id="_svDlgOK">确定</button>
      </div>
    </div>`;
  this.root.appendChild(mask);
  const $d = s => mask.querySelector(s);
  $d('#_svDlgCancel').onclick = () => { this.root.removeChild(mask); };
  $d('#_svDlgOK').onclick = () => { try{ onOK?.(mask); }finally{ this.root.removeChild(mask); } };
  return mask;
}

// SpaceView：生成返回值解析失败弹窗（只读文本 + 复制 + 确定）
function openSvGenErrorDialog(text = '') {
  const mask = document.createElement('div');
  mask.className = 'sv-modal-mask show';
  mask.innerHTML = `
    <div class="sv-modal" role="alertdialog" aria-label="返回值解析失败">
      <div class="title">返回值解析失败</div>
      <div class="sv-field">
        <textarea id="_svGenErrorText" class="sv-editor-input" style="min-height:180px;" readonly></textarea>
      </div>
      <div class="sv-actions">
        <button class="sv-btn" id="_svGenErrOK">确定</button>
        <button class="sv-btn primary" id="_svGenErrCopy">复制</button>
      </div>
    </div>`;
  this.root.appendChild(mask);

  const ta = mask.querySelector('#_svGenErrorText');
  if (ta) { ta.value = String(text || ''); ta.select(); }

  mask.querySelector('#_svGenErrCopy')?.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(String(ta?.value || '')); } catch {}
    ta?.select();
  });
  mask.querySelector('#_svGenErrOK')?.addEventListener('click', () => {
    try { this.root.removeChild(mask); } catch {}
  });

  return mask;
}

globalThis.Favs ||= {};
const Favs = Object.assign(globalThis.Favs, {
  async list(login){
    const all = (await RMPhoneToWorldBook.readDynamicFavs?.()) || [];
    return login ? all.filter(x => x && String(x.login) === String(login)) : all;
  },
  key(login, lane){ return `${String(login)}|${lane}`; },
  async has(login, lane){
    const list = await this.list(login);
    const k = this.key(login, lane);
    return list.some(x => x && x.key === k);
  },
  async add(login, m){
    // 读取所有账号的收藏（不过滤）
    const allFavs = (await RMPhoneToWorldBook.readDynamicFavs?.()) || [];
    const k = this.key(login, m.lane);
    
    // 检查是否已存在
    if (!allFavs.some(x => x && x.key === k)){
      const snap = { lane: m.lane, ts: m.ts, items: m.items, meta: m.meta || {}, pending: !!m.pending };
      allFavs.push({ key:k, login: String(login), moment: snap, savedAt: Date.now() });
      await RMPhoneToWorldBook.writeDynamicFavs?.(allFavs);  // 写回所有数据
    }
    return true;
  },
  async remove(login, lane){
    // 读取所有账号的收藏（不过滤）
    const allFavs = (await RMPhoneToWorldBook.readDynamicFavs?.()) || [];
    const k = this.key(login, lane);
    const next = allFavs.filter(x => !x || x.key !== k);  // 只删除匹配的项
    await RMPhoneToWorldBook.writeDynamicFavs?.(next);
    return true;
  }
});

// —— URL 补全（仅渲染时用，不回写 _data）——
// 用 function 声明可被提前使用（不会有“未初始化”问题）
function normCatboxUrl(u) {
  if (!u) return '';
  return /^https?:\/\//i.test(u)
    ? u
    : 'https://files.catbox.moe/' + String(u).replace(/^\/+/, '');
}

// —— 分享弹窗：状态 ——
let _shareLane = '';
let _tab = 'contacts';            // 默认进“联系人”
let _which = 'friends';            // 好友 or 群聊
const _selFriends = new Set();
const _selGroups  = new Set();
let _listRenderSeq = 0;

// 切换顶部 QQ空间/联系人
const paneZone = $sv('#svPaneZone');
const paneContacts = $sv('#svPaneContacts');
const tabTop = $sv('#svShareMask .sv-tabs.top')?.querySelectorAll('button') || [];
const tabMid = $sv('#svShareMask .sv-tabs.mid')?.querySelectorAll('button') || [];
const listEl = $sv('#svShareList');
const iptSearch = $sv('#svShareSearch');

function switchTop(to){
  _tab = to;
  tabTop.forEach(b => b.classList.toggle('is-act', b.dataset.t === to));
  paneZone.hidden = to !== 'zone';
  paneContacts.hidden = to !== 'contacts';
  if (to === 'contacts') renderList(); 
}
function switchMid(k){
  _which = k;
  tabMid.forEach(b => b.classList.toggle('is-act', b.dataset.k === k));
  renderList();
}

// 固定住当前登录名，防丢 this
const LOGIN = this.login;

// 读世界书（优先用缓存）
const getWB = async () => {
  if (this._wbQQ) return this._wbQQ;
  try { this._wbQQ = await RMPhoneToWorldBook.getApp('qq'); } catch {}
  return this._wbQQ || {};
};

// 勾选项
const makePick = (name, avaUrl, kind) => {
  const li = document.createElement('div');
  li.className = 'sv-pick';
  li.innerHTML = `<div class="ava"></div><div class="name"></div><div class="chk"><i class="fi fi-rr-check"></i></div>`;
  li.querySelector('.name').textContent = name;
  if (avaUrl) li.querySelector('.ava').style.backgroundImage = `url('${avaUrl}')`;
  const set = kind === 'friends' ? _selFriends : _selGroups;
  const sync = () => li.classList.toggle('sel', set.has(name));
  sync();
  li.addEventListener('click', () => { set.has(name) ? set.delete(name) : set.add(name); sync(); });
  return li;
};

// 用箭头函数，闭包里能拿到 LOGIN
const renderList = async () => {
  const mySeq = ++_listRenderSeq;      // 新增：记录我是第几次渲染
  listEl.innerHTML = '';               // 先清空一次，避免闪回旧数据

  const wb = await getWB();
  // 如果我已经不是最新那次渲染了，直接放弃（防止重复）
  if (mySeq !== _listRenderSeq) return;

  const node = wb?.login?.[LOGIN] || {};
  const coll = _which === 'groups'
    ? (node?.contacts?.groups  || {})
    : (node?.contacts?.friends || {});
  const entries = Object.entries(coll);

  if (!entries.length) {
    listEl.innerHTML = '<div class="sv-empty" style="padding:10px;">没有结果</div>';
    console.debug('[Share] WB 空或没有该类联系人：', { LOGIN, hasWB: !!wb, which: _which, node });
    return;
  }

  const q = (iptSearch.value || '').trim().toLowerCase();
  const seen = new Set();              // 保底去重：同名只保留一次
  entries
    .filter(([name]) => !q || name.toLowerCase().includes(q))
    .forEach(([name, meta]) => {
      if (seen.has(name)) return;
      seen.add(name);
      listEl.appendChild(makePick(name, meta?.avatar, _which));
    });
};

// 顶部两个 tab
this.root.querySelectorAll('.sv-tabs.top button')?.forEach(b => b.addEventListener('click', () => switchTop(b.dataset.t)));
this.root.querySelectorAll('.sv-tabs.mid button')?.forEach(b => b.addEventListener('click', () => switchMid(b.dataset.k)));
iptSearch?.addEventListener('input', () => renderList());

// 取消/发送
$sv('#svShareCancel')?.addEventListener('click', () => hideMask($sv('#svShareMask')));
$sv('#svShareSend')?.addEventListener('click', () => {
  // 多选发送：对好友发 DM，对群聊发 GROUP
  const lane = _shareLane; if (!lane) return;
  _selFriends.forEach(name => RMQQ.Data.pushMsg({ login:this.login, kind:'dm',    peer:name, type:'mmtshare', args:[lane] }));
  _selGroups.forEach (name => RMQQ.Data.pushMsg({ login:this.login, kind:'group', peer:name, type:'mmtshare', args:[lane] }));
  hideMask($sv('#svShareMask'));
  // 清空选择
  _selFriends.clear(); _selGroups.clear();
});

// —— 对外开放：被每条动态的“转发”按钮调用 ——
const openShare = (lane) => {
  _shareLane = String(lane || '');
  switchTop('contacts');   // 默认打开“联系人”
  switchMid('friends');
  iptSearch.value = '';
  _selFriends.clear();
  _selGroups.clear();
  showMask($sv('#svShareMask'));
};

  }

  unmount() {
  try { this._unsubSpace?.(); } catch {}
  this._unsubSpace = null;
  this.root = null;
  }
}

        // =============================================================================
        // RMQQ.Data（数据处理包）使用说明 · 避坑简版
        // 放置位置：把本注释放在  const Data = (() => {  前面，长期保留。
        // 【2】模板字符串怎么用（错 vs 对）
        // - ❌ 易翻车：在 innerHTML 的模板里拼“外部数据”，例如：
        //       style="background-image:url('${url}')"
        //       <div>${任意外部文本}</div>
        // - ✅ 稳定：先插“干净骨架”，再用 DOM 赋值：
        //       li.innerHTML = '...<div class="ava"></div><div class="title"></div>...';
        //       li.querySelector('.title').textContent = name;
        //       const ava = li.querySelector('.ava');
        //       ava.style.background = '#e9eef6';
        //       ava.style.backgroundImage =
        //         "url('" + String((url || DEFAULT_AVATAR)).replace(/'/g, "\\'") + "')";
        // 【3】innerHTML 与 DOM API 的分工
        // - innerHTML：只放“固定结构、不含变量”的静态骨架。
        // - 所有来自数据的内容，统一用 textContent / setAttribute / style.xxx
        // =============================================================================

/**
 * 模块：Data（QQ 数据中心）
 * 作用：维护内存数据结构（账号/会话/消息），提供事件总线、订阅接口与未读统计；
 *      需要持久化时调用 RMPhoneToChatMessage.commit()
 *
 * 公开 API（核心）：
 *   - init(): void                              初始化内部索引/状态
 *   - getState(): {accounts, ...}               取只读快照（调试）
 *   - on(evt, fn)/off(evt, fn)                  简易事件总线
 *   - ensureAccount(login): Account             没有就新建
 *   - ensureSession(acc|login, kind, peer): Session
 *   - findSession(login, kind, peer): Session?  查找
 *   - pushMsg({login, kind, peer, text|img...}): void
 *   - pushInMsg(...)                            模拟“对方发来”
 *   - applyPatch(patch)/applyRaw(raw)           批量修改（少用）
 *   - deleteSession(login, kind, peer)          删除会话
 *
 * 订阅/统计：
 *   - subscribeChat({login, kind, peer}, cb)    流式推送 {type:'init'|'append', items}
 *   - subscribeTabsSummaries({login}, cb)       推送会话摘要（用于列表）
 *   - setActiveChat/clearActiveChat             影响未读累加逻辑
 *   - markRead/markUnread                       改未读
 *   - getLoginUnreadTotal(login)                取该账号未读总数
 *   - subscribeUnreadOfLogin(login, cb)         订阅该账号未读数
 *
 * 持久化：
 *   - setPersistMode({ mode:'off'|'immediate'|'debounce', debounceMs, maxWaitMs })  是否自动写回
 *   - commit(): Promise<void>                   立刻把 _data 写回聊天（经 RMPhoneToChatMessage）
 *
 * 注意点：
 *   - 事件回调要及时解绑（返回的 off 可用）
 *   - 大量变更时 prefer applyPatch + 单次 commit，避免频繁写回
 */

        const Data = (() => {
  /* ---------------- 基础引用与小工具 ---------------- */
  const getQQ = () => RMPhoneToChatMessage.getApp('qq'); // _data.qq 的引用（就地修改）
  const getDefaultLogin = qq => qq?.accounts?.[0]?.login || null;
  const now = () => Date.now();
  const genId = () => now().toString(36) + Math.random().toString(36).slice(2, 8);

  // ★ 新增：统一拿登录名/标准化入参/造消息/未读判断的小工具
  function pickLogin(login) {
    return login || getDefaultLogin(getQQ()) || `guest@${now()}`;
  }
  function normalizeArgs(args) {
    const a = Array.isArray(args) ? args.map(x => String(x)) : [];
    return { args: a, content: a[0] != null ? String(a[0]) : '' };
  }
  function makeItem({ out, login, peer, speaker, type = 'txt', args = [], ts }) {
    const { args: a, content } = normalizeArgs(args);
    return {
      id: genId(),
      type,
      speaker: String(speaker ?? (out ? login : (peer || '对方'))),
      out: !!out,
      args: a,
      content,
      ts: ts != null ? (Number(ts) || now()) : now(),
    };
  }

  // ★ 对外可用的“拿登录名”函数
  function getActiveLogin() {
    const qq = getQQ();
    return (activeChat && activeChat.login) || getDefaultLogin(qq);
  }
  function getDefaultLoginPublic() {
    return getDefaultLogin(getQQ());
  }

  // 简单事件总线
  const subs = Object.create(null);
  const on = (evt, fn) => {
    (subs[evt] ||= new Set()).add(fn);
    return () => off(evt, fn);
  };
  const off = (evt, fn) => {
    subs[evt]?.delete(fn);
  };
  const emit = (evt, payload) => {
    subs[evt]?.forEach(fn => {
      try {
        fn(payload);
      } catch (_) {}
    });
  };

  // 预览文本（最后一条非空）
  function lastPreview(sess) {
    const arr = Array.isArray(sess?.items) ? sess.items : [];
    for (let i = arr.length - 1; i >= 0; i--) {
      const it = arr[i];
      if (!it) continue;
      const a0 = Array.isArray(it.args) ? it.args[0] ?? '' : '';
      if (it.type === 'txt') {
        const t = String(a0).trim();
        if (t) return t.length > 42 ? t.slice(0, 42) + '…' : t;
      }
      if (it.type === 'bqb') return '[表情包] ' + String(a0 || '');
      if (it.type === 'voice')
        return `[语音 ${String(Array.isArray(it.args) ? it.args[0] || '' : '')}'' ]`.replace(" ''", "''");
      if (it.type === 'dmt') return '[多媒体] ' + String(a0 || '');
      if (it.type === 'file') return `[文件] ${String(a0 || '')}`.trim();
      if (it.type === 'xfr')      return `[转账] ￥${String(it.args?.[1] || '')}`;
      if (it.type === 'xfr.rcv')  return `[已收款] ￥${String(it.args?.[1] || '')}`;
      if (it.type === 'xfr.rfd')  return `[已退回] ￥${String(it.args?.[1] || '')}`;
      if (it.type === 'loc')   return '[位置] ' + String(a0 || '');
      if (it.type === 'nudge') return '[拍一拍] ' + String(a0 || '');
      if (it.type === 'mmtshare') return '[转发说说]';
    }
    return '';
  }

  // 索引：login -> Map("kind|peer", session)
  const index = {
    map: new Map(),
    key: (k, p) => `${k}|${p}`,
    build() {
      this.map.clear();
      const qq = getQQ();
      for (const acc of qq.accounts || []) {
        const m = new Map();
        for (const s of acc.sessions || []) m.set(this.key(s.kind, s.peer), s);
        this.map.set(acc.login, m);
      }
    },
    get(login, kind, peer) {
      return this.map.get(login)?.get(this.key(kind, peer)) || null;
    },
    set(login, sess) {
      let m = this.map.get(login);
      if (!m) {
        m = new Map();
        this.map.set(login, m);
      }
      m.set(this.key(sess.kind, sess.peer), sess);
    },
  };

  /* ---------------- 生命周期 ---------------- */
  let inited = false;
  let activeChat = null; // { login, kind, peer } | null

    // ---- pendingZone：临时存放“未入库”的 [ZONE]/[MOMENT]，按 login 分桶 ----
  const pendingZone = Object.create(null); // { [login]: Array<moment> }

  function _ensurePending(login) {
    const k = String(login || getDefaultLogin(getQQ()) || `guest@${now()}`);
    return (pendingZone[k] ||= []);
  }

  const _momentSig = (m) => {
    const lane = String(m?.lane ?? '0');
    const ts   = Number(m?.ts || 0) || 0;
    let firstTxt = '';
    const arr = Array.isArray(m?.items) ? m.items : [];
    for (const it of arr) { if (it && it.type === 'txt') { firstTxt = String(it.content || it.args?.[0] || '').trim(); break; } }
    return `${lane}|${firstTxt}|${ts}`;
  };

  // 把解析到但“未确认”的 moments 放进 pending（不写 _data）
  function pushPendingZone(login, moments = []) {
    const box = _ensurePending(login);
    const seen = new Set(box.map(_momentSig));
    let added = 0;
    for (const m of Array.isArray(moments) ? moments : []) {
      const mm = m ? { ...m, _pending: true } : null; // 打标记，渲染可区分
      if (!mm) continue;
      const sig = _momentSig(mm);
      if (seen.has(sig)) continue;
      box.push(mm); seen.add(sig); added++;
    }
    if (added) emit('change', { login, type: 'pending:add', count: added }); // 触发 Space 重算
    return added;
  }

  function hasPendingZone(login) {
    const box = pendingZone?.[String(login)] || [];
    return box.length > 0;
  }

  // 清空“当前账号”的 pendingzone（仅清空 pending，不动已入库的 zone.moments）
function clearPendingZone({ login } = {}) {
  init();
  const acc = ensureAccount(login || getDefaultLogin(getQQ()) || `guest@${now()}`);
  pendingZone[acc.login] = [];
  emit('change', { login: acc.login, type: 'pending:clear' });
  return true;
}

  // 接受 pending → 正式入库（不自动 commit；由你在 UI 上显式调用 RMQQ.Data.commit()）
  function acceptPendingZone({ login, lanes = 'all' } = {}) {
    init();
    const acc = ensureAccount(login || getDefaultLogin(getQQ()) || `guest@${now()}`);
    acc.zone ||= { kind: 'zone', moments: [] };
    const box = _ensurePending(acc.login);

    const wantAll = lanes === 'all';
    const laneSet = wantAll ? null : new Set(String(lanes).split(',').map(s => s.trim()).filter(Boolean));

    const keep = [];
    let moved = 0;
    for (const m of box) {
      const lane = String(m?.lane ?? '0');
      if (!wantAll && !laneSet.has(lane)) { keep.push(m); continue; }
      const clone = { ...m }; delete clone._pending;
      (acc.zone.moments ||= []).push(clone);
      moved++;
    }
    pendingZone[acc.login] = keep;
    if (moved) emit('change', { login: acc.login, type: 'pending:accept', count: moved });
    return moved;
  }

  // —— [NEW] 把已入库的动态移回 Pending ——
function moveToPending({ login, lanes = '' } = {}) {
init();
const acc = ensureAccount(login || getDefaultLogin(getQQ()) || `guest@${now()}`);
const laneList = String(lanes).split(',').map(s => s.trim()).filter(Boolean);
if (!laneList.length) return 0;
let moved = 0;
const list = Array.isArray(acc?.zone?.moments) ? acc.zone.moments : (acc.zone.moments = []);
for (const lane of laneList) {
const i = list.findIndex(m => String(m?.lane ?? '0') === String(lane));
if (i >= 0) {
const m = list.splice(i, 1)[0];
pushPendingZone(acc.login, [m]);
moved++;
}
}
if (moved) emit('change', { login: acc.login, type: 'zone:toPending', count: moved });
return moved;
}

// —— [NEW] 删除指定 lane 的动态（无论在入库还是 Pending）——
function removeMomentsEverywhere({ login, lanes = '' } = {}) {
init();
const acc = ensureAccount(login || getDefaultLogin(getQQ()) || `guest@${now()}`);
const wantAll = lanes === 'all';
const laneSet = wantAll ? null : new Set(String(lanes).split(',').map(s => s.trim()).filter(Boolean));
let removed = 0;
// 1) zone
if (acc.zone && Array.isArray(acc.zone.moments)) {
const keep = [];
for (const m of acc.zone.moments) {
const hit = wantAll || laneSet.has(String(m?.lane ?? '0'));
if (!hit) keep.push(m); else removed++;
}
acc.zone.moments = keep;
}
// 2) pending
const box = _ensurePending(acc.login);
const keepP = [];
for (const m of box) {
const hit = wantAll || laneSet.has(String(m?.lane ?? '0'));
if (!hit) keepP.push(m); else removed++;
}
pendingZone[acc.login] = keepP;
if (removed) emit('change', { login: acc.login, type: 'zone:remove', count: removed });
return removed;
}

// —— [NEW] 查询某 lane 当前是否“已入库 / 在 Pending” ——
function isLaneSaved({ login, lane } = {}) {
init();
const acc = ensureAccount(login || getDefaultLogin(getQQ()) || `guest@${now()}`);
const inZone = Array.isArray(acc?.zone?.moments) && acc.zone.moments.some(m => String(m?.lane ?? '0') === String(lane));
const pend = _ensurePending(acc.login) || [];
const inPending = pend.some(m => String(m?.lane ?? '0') === String(lane));
return { inZone, inPending };
}

// —— [NEW] 向某个 lane 的 moment 追加一条 item（like/comment/reply 等）——
function appendMomentItem({ login, lane, type = 'txt', speaker, args = [], ts }) {
  init();
  const acc = ensureAccount(login || getDefaultLogin(getQQ()) || `guest@${now()}`);
  const targetLane = String(lane ?? '0');

  // 1) 找到这个 moment（优先正式区，其次 Pending）
  const list = Array.isArray(acc?.zone?.moments) ? acc.zone.moments : (acc.zone.moments = []);
  let m = list.find(x => String(x?.lane ?? '0') === targetLane);
  if (!m) {
    const box = _ensurePending(acc.login);
    m = box.find(x => String(x?.lane ?? '0') === targetLane);
    if (!m) {
      m = { lane: targetLane, ts: 0, meta: {}, items: [], _pending: true };
      box.push(m);
    }
  }

  // 2) 追加一条 item
  (m.items ||= []).push({
    type: String(type),
    speaker: String(speaker ?? acc.login),
    args: Array.isArray(args) ? args.map(String) : [],
    content: Array.isArray(args) && args.length ? String(args[0]) : '',
    out: true,
    ts: ts != null ? Number(ts) : now(),
  });

  // 3) 通知视图刷新 + 触发写回调度
  emit('change', { login: acc.login, type: 'zone:moment:append', lane: targetLane });
  _autoPersistTick();
  return true;
}

async function init() {
  if (inited) return true;
  
  // 等待数据初始化
  await RMPhoneToChatMessage.ensureInitialized?.();
  
    if (inited) return true;
    const qq = getQQ();
    qq.accounts ||= [];
    qq.schemaVersion ||= 1;

    // 防止出现空 login 的脏数据
    qq.accounts = qq.accounts
      .filter(a => a && typeof a.login === 'string' && a.login.trim() !== '')
      .map(a => ({
        login: a.login.trim(),
        sessions: Array.isArray(a.sessions) ? a.sessions : [],
        zone: (a.zone && Array.isArray(a.zone.moments)) ? a.zone : { kind: 'zone', moments: [] },
      }));
    index.build();
    inited = true;
    emit('init', { logins: (qq.accounts || []).map(a => a.login), defaultLogin: getDefaultLogin(qq) });
    return true;
  }

  function getState() {
    // 返回浅拷贝，避免外部误改原始引用
    const qq = getQQ();
    return JSON.parse(JSON.stringify(qq));
  }

  /* ---------------- 确保账号/会话存在 ---------------- */
  function ensureAccount(login) {
    init();
    const qq = getQQ();
    let acc = (qq.accounts || []).find(a => a.login === login);
    if (!acc) {
      acc = { login, sessions: [] };
      (qq.accounts ||= []).push(acc);
      // 给新账号也建一个空索引
      if (!index.map.has(login)) index.map.set(login, new Map());
      emit('account:created', { login });
    }
    return acc;
  }

  function ensureSession(accOrLogin, kind = 'dm', peer = '') {
    const login = typeof accOrLogin === 'string' ? accOrLogin : accOrLogin.login;
    const acc = typeof accOrLogin === 'string' ? ensureAccount(accOrLogin) : accOrLogin;
    let sess = index.get(login, kind, peer);
    if (!sess) {
      sess = { kind, peer, items: [] };
      (acc.sessions ||= []).push(sess);
      index.set(login, sess);
      sess.unreadCount = Number(sess.unreadCount) || 0;
      emit('session:created', { login, kind, peer });
    }
    return sess;
  }

  function findSession(login, kind, peer) {
    init();
    return index.get(login, kind, peer);
  }

  /* -------- 未读：工具 -------- */
  function increaseUnreadIfNeeded(sess, { login, kind = 'dm', peer }, item) {
    if (item.out === false) {
      const isActive = !!(activeChat &&
        activeChat.login === login &&
        activeChat.kind === kind &&
        activeChat.peer === peer);
      if (!isActive) {
        sess.unreadCount = (Number(sess.unreadCount) || 0) + 1;
      }
    }
  }

  /* ---------------- 动作：新增消息（我方 / 对方） ---------------- */
  function _appendItem(login, kind, peer, item) {
    const acc = ensureAccount(login);
    const sess = ensureSession(acc, kind, peer);
    (sess.items ||= []).push(item);

    increaseUnreadIfNeeded(sess, { login, kind, peer }, item);

    const payload = {
      login,
      kind,
      peer,
      change: { type: 'append', count: 1, last: item },
      preview: lastPreview(sess),
      unreadCount: Number(sess.unreadCount) || 0,
      lastTs: item.ts || now(),
    };
    emit('session:changed', payload);
    _autoPersistTick();
    return item;
  }

  function pushMsg({ login, kind = 'dm', peer, type = 'txt', args = [] }) {
    login = pickLogin(login);
    const item = makeItem({ out: true, login, peer, type, args });
    return _appendItem(login, kind, peer, item);
  }

  function pushInMsg({ login, kind = 'dm', peer, speaker, type = 'txt', args = [] }) {
    login = pickLogin(login);
    const item = makeItem({ out: false, login, peer, speaker, type, args });
    return _appendItem(login, kind, peer, item);
  }

  /* ---------------- 批量更新（回放 / 导入） ---------------- */
  // patch = { upserts: [{ login, kind, peer, items:[ {type, speaker?, out?, args?, ts?} ] }] }
  function applyPatch(patch) {
    init();
    const upserts = Array.isArray(patch?.upserts) ? patch.upserts : [];
    let changed = 0;
    for (const u of upserts) {
      const login = pickLogin(u.login);
      const kind = u.kind || 'dm';
      const peer = u.peer || '';
      const acc = ensureAccount(login);
      const sess = ensureSession(acc, kind, peer);
      const add = Array.isArray(u.items) ? u.items : [];

      for (const it of add) {
        const item = makeItem({
          out: !!it.out,
          login,
          peer,
          speaker: it.speaker,
          type: it.type || 'txt',
          args: it.args,
          ts: it.ts, // ☆ 透传 ts，保持首屏时间/排序自然
        });
        (sess.items ||= []).push(item);
        increaseUnreadIfNeeded(sess, { login, kind, peer }, item);
        changed++;
      }

      emit('session:changed', {
        login, kind, peer,
        change: { type: 'append', count: add.length, last: sess.items[sess.items.length - 1] || null },
        preview: lastPreview(sess),
        unreadCount: Number(sess.unreadCount) || 0,
        lastTs: sess.items.length ? sess.items[sess.items.length - 1].ts : now(),
      });
    }
    if (changed) _autoPersistTick();
    return changed;
  }

  // 直接吃 raw 文本，转 patch 后增量入库（会话入库；ZONE → pending）
  function applyRaw(raw) {
    const mini = RMPhoneToChatMessage?.safeParse?.(raw);
    if (!mini || !mini.qq) return 0;

    let changed = 0;
    const upserts = [];

    for (const acc of mini.qq.accounts || []) {
      const login = acc.login || getDefaultLogin(getQQ()) || `guest@${now()}`;

      // 1) DM/GROUP → upserts
      const sessions = acc.sessions || [];
      for (const s of sessions) {
        if (!s || !s.kind || !s.peer) continue;
        const items = Array.isArray(s.items)
          ? s.items.map(it => ({
              type: it.type || 'txt',
              speaker: it.speaker || undefined,
              // 若有 speaker，则 out = (speaker === login)；否则沿用 it.out
              out: it.speaker ? String(it.speaker) === String(login) : !!it.out,
              args: Array.isArray(it.args) ? it.args.map(String) : [],
              ts: it.ts,
            }))
          : [];
        if (items.length) upserts.push({ login, kind: s.kind, peer: s.peer, items });
      }

      // 2) ZONE/MOMENT → pending（不入 _data）
      const zms = Array.isArray(acc?.zone?.moments) ? acc.zone.moments : [];
      if (zms.length) changed += pushPendingZone(login, zms);
    }

    // 3) 应用会话补丁
    if (upserts.length) changed += applyPatch({ upserts });

    return changed;
  }

  /* ---------------- 删除会话（整块移除） ---------------- */
  // opts = { login, kind:'dm'|'group', peer }
  function deleteSession({ login, kind = 'dm', peer }) {
    init();
    const qq = getQQ();
    const acc = (qq.accounts || []).find(a => a.login === (login || getDefaultLogin(qq)));
    if (!acc) return false;

    const i = (acc.sessions || []).findIndex(s => s && s.kind === kind && s.peer === peer);
    if (i < 0) return false;

    // 从账号的 sessions 里移掉该会话
    acc.sessions.splice(i, 1);

    // 重建索引 + 广播删除事件
    index.build();
    emit('session:deleted', { login: acc.login, kind, peer });

    // 触发持久化（你的外壳已设 mode:'immediate'）
    _autoPersistTick();
    return true;
  }

  /* ---------------- 订阅（给视图用） ---------------- */
  // Chat 订阅：初次返回全部 items，后续只返回新增尾巴
  function subscribeChat({ login, kind = 'dm', peer }, cb) {
    init();
    const sess = findSession(login || getDefaultLogin(getQQ()) || `guest@${now()}`, kind, peer);
    let seen = (sess && sess.items.length) || 0;
    cb({ type: 'init', items: sess ? sess.items.slice(0) : [] }); // 首次

    const off1 = on('session:changed', e => {
      if (e.login !== login || e.kind !== kind || e.peer !== peer) return;
      const s = findSession(login || getDefaultLogin(getQQ()) || `guest@${now()}`, kind, peer);
      const cur = s ? s.items.length : 0;
      if (cur > seen) {
        cb({ type: 'append', items: s.items.slice(seen) });
        seen = cur;
      }
    });

    // 返回取消订阅函数
    return () => off1();
  }

  // Tabs 摘要订阅：初次返回所有摘要，后续返回单条 patch
  // 摘要项：{ kind, peer, preview, lastTs, unreadCount }
  function subscribeTabsSummaries({ login }, cb) {
    init();
    const qq = getQQ();
    const acc = (qq.accounts || []).find(a => a.login === login) || ensureAccount(login);

    const summaries = (acc.sessions || []).map(s => ({
      kind: s.kind,
      peer: s.peer,
      preview: lastPreview(s),
      lastTs: s.items?.length ? s.items[s.items.length - 1].ts : 0,
      unreadCount: Number(s.unreadCount) || 0,
    }));
    cb({ type: 'init', summaries });

    const offA = on('session:created', e => {
      if (e.login !== login) return;
      cb({ type: 'patch', summary: { kind: e.kind, peer: e.peer, preview: '', lastTs: 0, unreadCount: 0 } });
    });

    const offB = on('session:changed', e => {
      if (e.login !== login) return;
      cb({ type: 'patch', summary: {
        kind: e.kind,
        peer: e.peer,
        preview: e.preview,
        lastTs: e.lastTs,
        unreadCount: Number(e.unreadCount) || 0,
      } });
    });

    const offC = on('session:deleted', e => {
      if (e.login !== login) return;
      cb({ type: 'remove', summary: { kind: e.kind, peer: e.peer } });
    });

    return () => {
      offA();
      offB();
      offC();
    };
  }

    // Space 订阅：读取某账号的 QQ 空间（zone.moments），按时间倒序推给视图
  // 用法：subscribeSpace({ login, lanes:'all'|'0,1,2' }, cb)
  function subscribeSpace({ login, lanes = 'all' } = {}, cb) {
    init();
    const qq = getQQ();
    const acc = (qq?.accounts || []).find(a => a && a.login === (login || getDefaultLogin(qq)));
    const laneSet = lanes === 'all' ? null : new Set(String(lanes).split(',').map(s => s.trim()).filter(Boolean));

    const calcTs = (m) => {
      if (m && m.ts != null) return Number(m.ts) || 0;
      const arr = Array.isArray(m?.items) ? m.items : [];
      let t = 0;
      for (const it of arr) t = Math.max(t, Number(it?.ts || 0));
      return t;
    };

    const collect = () => {
      if (!acc || !acc.zone || !Array.isArray(acc.zone.moments)) return [];
      const out = [];
      const pend = (pendingZone?.[acc.login] || []);
      const list = acc.zone.moments.concat(pend);
      for (let i = 0; i < list.length; i++) {
        const m = list[i];
        const lane = String(m?.lane ?? '0');
        if (laneSet && !laneSet.has(lane)) continue;
        out.push({
          login: acc.login,
          index: i,                 // 可选：供视图做 key
          lane,
          ts: calcTs(m),
          pending: !!m._pending,
          meta: m?.meta || {},
          items: Array.isArray(m?.items) ? m.items : [],
        });
      }
      // 时间倒序；同一时间按 lane
      out.sort((a, b) => (b.ts - a.ts) || a.lane.localeCompare(b.lane));
      return out;
    };

    // 首次全量
    cb({ type: 'init', login, moments: collect() });

    // 有写回/变更时，简化为全量重推；commit 会触发 'change'
    const off = on('change', () => cb({ type: 'reset', login, moments: collect() }));
    return () => off();
  }

  /* ---------------- 持久化（楼层写回） ---------------- */
  // 模式：off | immediate | debounce
  let persistMode = 'off';
  let debMs = 600;
  let maxWaitMs = 5000;
  let debTimer = null;
  let maxTimer = null;
  let flushing = false;

  function setPersistMode({ mode = 'off', debounceMs = 600, maxWaitMs: mw = 5000 } = {}) {
    persistMode = mode;
    debMs = debounceMs;
    maxWaitMs = mw;
    if (debTimer) {
      clearTimeout(debTimer);
      debTimer = null;
    }
    if (maxTimer) {
      clearTimeout(maxTimer);
      maxTimer = null;
    }
  }

  async function commit({ immediate = false } = {}) {
    init();
    if (flushing && !immediate) return false;
    flushing = true;
    try {
      RMPhoneToChatMessage.toRaw?.(); // _data → _raw
      await RMPhoneToChatMessage.RMPhoneCommit?.(); // 写回顶楼，refresh:'none'
      emit('change', {}); // 保持兼容：有需要可以在外层监听此事件
      return true;
    } catch (e) {
      console.warn('RMQQ.Data.commit 失败：', e);
      return false;
    } finally {
      flushing = false;
    }
  }

  function _schedulePersist() {
    if (persistMode === 'immediate') {
      void commit({ immediate: true });
      return;
    }
    if (persistMode !== 'debounce') return;
    if (debTimer) clearTimeout(debTimer);
    debTimer = setTimeout(() => {
      debTimer = null;
      void commit({ immediate: true });
    }, debMs);
    if (!maxTimer && maxWaitMs > 0) {
      maxTimer = setTimeout(() => {
        maxTimer = null;
        if (debTimer) {
          clearTimeout(debTimer);
          debTimer = null;
        }
        void commit({ immediate: true });
      }, maxWaitMs);
    }
  }
  function _autoPersistTick() {
    if (persistMode !== 'off') _schedulePersist();
  }

  /* -------- 未读：工具与订阅 -------- */
  function setActiveChat({ login, kind = 'dm', peer } = {}) {
    activeChat = login && peer ? { login, kind, peer } : null;
    if (activeChat) markRead(activeChat);
  }

  function clearActiveChat() { activeChat = null; }

  function markRead({ login, kind = 'dm', peer }) {
    const sess = findSession(login, kind, peer);
    if (!sess) return false;
    if ((Number(sess.unreadCount) || 0) > 0) {
      sess.unreadCount = 0;
      emit('session:changed', {
        login, kind, peer,
        change: { type: 'unread', count: 0, last: sess.items?.[sess.items?.length - 1] || null },
        preview: lastPreview(sess),
        unreadCount: 0,
        lastTs: sess.items?.length ? sess.items[sess.items.length - 1].ts : now(),
      });
      _schedulePersist();
    }
    return true;
  }

  function markUnread({ login, kind = 'dm', peer, count = 1 }) {
    const sess = ensureSession(login, kind, peer);
    const cur = Number(sess.unreadCount) || 0;
    const next = Math.max(cur, Math.max(1, Number(count) || 1));
    if (next !== cur) {
      sess.unreadCount = next;
      emit('session:changed', {
        login, kind, peer,
        change: { type: 'unread', count: next, last: sess.items?.[sess.items?.length - 1] || null },
        preview: lastPreview(sess),
        unreadCount: next,
        lastTs: sess.items?.length ? sess.items[sess.items.length - 1].ts : now(),
      });
      _schedulePersist();
    }
    return true;
  }

  function getLoginUnreadTotal(login) {
    const acc = (getQQ()?.accounts || []).find(a => a.login === login);
    if (!acc) return 0;
    return (acc.sessions || []).reduce((sum, s) => sum + (Number(s.unreadCount) || 0), 0);
  }

  /* 订阅：某登录的“（可选排除当前会话的）未读总数” */
  function subscribeUnreadOfLogin({ login, exclude } = {}, cb) {
    const calc = () => {
      let total = getLoginUnreadTotal(login);
      if (exclude) {
        const s = findSession(login, exclude.kind || 'dm', exclude.peer);
        total -= Number(s?.unreadCount) || 0;
        if (total < 0) total = 0;
      }
      return total;
    };
    cb(calc());
    const off1 = on('session:changed', e => { if (e.login === login) cb(calc()); });
    const off2 = on('session:deleted', e => { if (e.login === login) cb(calc()); });
    return () => { off1(); off2(); };
  }

  /* 订阅：是否有“其它登录”的未读 */
  function subscribeAnyUnreadExceptLogin({ login }, cb) {
    const calc = () => {
      const qq = getQQ();
      const list = (qq?.accounts || []).map(a => a.login).filter(Boolean);
      return list.some(lg => lg !== login && getLoginUnreadTotal(lg) > 0);
    };
    cb(calc());
    const off = on('session:changed', () => cb(calc()));
    const off2 = on('session:deleted', () => cb(calc()));
    return () => { off(); off2(); };
  }

  /* ---------------- 导出 API ---------------- */
  return {
    // 生命周期
    init,
    getState,
    getActiveLogin,
    getDefaultLogin: getDefaultLoginPublic,

    // 事件
    on,
    off,

    // 数据操作
    ensureAccount,
    ensureSession,
    findSession,
    pushMsg,
    pushInMsg,
    applyPatch,
    applyRaw,
    deleteSession,
    setActiveChat,
    clearActiveChat,
    markRead,
    markUnread,
    getLoginUnreadTotal,
    subscribeUnreadOfLogin,
    subscribeAnyUnreadExceptLogin,

    // 订阅（给视图挂载时用）
    subscribeChat,
    subscribeTabsSummaries,
    subscribeSpace,
    // Space：pending（临时篮子）
    pushPendingZone,
    acceptPendingZone,
    hasPendingZone,
    moveToPending,
    removeMomentsEverywhere,
    isLaneSaved,
    appendMomentItem,
    clearPendingZone,

    // 持久化
    setPersistMode,
    commit,
  };
})();

/**
 * 模块：Extra（跨页“已选项”）
 * 作用：保存当前多选的会话键集合，供 TabsView / 其它视图共享
 *
 * 公开 API：
 *   - add(login, kind, peer) / remove(...) / has(...) / clear()
 *   - list(): Array<{login, kind, peer}>
 *
 * 说明：
 *   - 只是内存集合，不做持久化
 *   - 适合批量删除/标记等操作时统一拿到目标集
 */

const Extra = (() => {
  const sel = new Set(); // key: `${login}|${kind}|${peer}`

  const makeKey = (login, kind, peer) => `${String(login)}|${String(kind)}|${String(peer)}`;

  return {
    add(login, kind, peer)   { sel.add(makeKey(login, kind, peer)); },
    remove(login, kind, peer){ sel.delete(makeKey(login, kind, peer)); },
    has(login, kind, peer)   { return sel.has(makeKey(login, kind, peer)); },
    clear()                  { sel.clear(); },
    list() {
      return Array.from(sel).map(key => {
        const [login, kind, peer] = key.split('|');
        return { login, kind, peer };
      });
    },
  };
})();

/**
 * 类：LoginView（登录/建号页）
 * 作用：收集一个“账号名”，回传给外壳；外壳据此创建账号并进入 Tabs
 *
 * 公开特性：
 *   - key = 'login'，keepAlive = false
 *   - 构造参数：{ onConfirm(name) }
 *
 * 交互：
 *   - 点击“继续/确定” → 校验输入 → onConfirm(name)
 *
 * 注意点：
 *   - 背景图为演示用途；真实场景可由外部通过样式/数据替换
 */

class LoginView {
  constructor({ onConfirm } = {}) {
    this.key = 'login';
    this.keepAlive = false;
    this.onConfirm = onConfirm;
    this.root = null;
    this._onOK = null;
  }
  mount(container) {
    this.root = container;
    this.root.innerHTML = `
      <style>
        :host{display:block;height:100%}
        .login-wrap{
          position:absolute;
          inset:0;
          background:#fff url('https://i.postimg.cc/DyrGtSqR/2493163365.jpg') center/cover no-repeat;
          color:#111;
          font:14px/1.4 system-ui;
          display:flex;
          flex-direction:column;
          align-items:center;
          padding-top:40px; /* 减少顶部内边距使标题和卡片更近 */
        }
        .card{
          width:75%;
          max-width:360px;
          border-radius:16px;
          padding:12px 14px 14px; /* 调整内边距，底部稍大 */
          box-shadow:none;
          background:rgba(255,255,255,.45); /* 颜色更浅 */
          backdrop-filter:blur(10px);
          border:1px solid rgba(255,255,255,.65);
          position:relative;
          overflow:hidden;
          margin-top:12px; /* 减少与标题的距离 */
        }
        .loginviewbg{
          position:absolute;
          inset:0;
          opacity:1;
          z-index:0;
          background:linear-gradient(0deg,rgba(0,0,0,.25),rgba(0,0,0,.25)),url('https://i.postimg.cc/DyrGtSqR/2493163165.jpg') center/cover no-repeat;
          pointer-events:none
        }
        .card > *:not(.loginviewbg){ 
          position:relative; 
          z-index:1; 
        }
        .title{
          font-size:26px; /* 增大字体大小 */
          margin-bottom:8px; /* 减少底部外边距 */
          color:#000;
          font-weight:700;
          text-align:center;
        }
        .card .title{
          color:#000;
          text-shadow:none
        }
        .lbl{
          font-size:12px;
          color:#f1f5f9
        }
        .row{
          display:flex;
          flex-direction:column;
          gap:8px; /* 减少输入框和按钮之间的间距 */
        }
        .ipt{
          flex:1;
          height:36px;
          border:1px solid #e5e7eb;
          border-radius:10px;
          padding:10px 12px;
          font-size:14px;
          background:#fff;
          color:#111;
          outline:none;
          margin-top:4px; /* 添加顶部外边距 */
        }
        .btn{
          border:0;
          border-radius:10px;
          padding:10px 14px;
          background:#2b84ff;
          color:#fff;
          cursor:pointer;
          width:100%;
          margin-top:4px; /* 添加顶部外边距与输入框对齐 */
        }
        .err{
          color:#ef4444;
          font-size:12px;
          margin-top:8px;
          min-height:1em
        }
      </style>
      <div class="login-wrap" role="form" aria-label="QQ 登录">
        <div class="title">请输入用户名</div>
        <div class="card">
          <div class="loginviewbg" id="loginviewbg"></div>
          <div class="row">
            <input id="loginName" class="ipt" placeholder="请输入用户名" autocomplete="off" />
            <button id="loginOK" class="btn" aria-label="确认登录">确认登录</button>
          </div>
          <div id="loginErr" class="err"></div>
        </div>
      </div>
    `;
    const ipt = this.root.querySelector('#loginName');
    const ok  = this.root.querySelector('#loginOK');
    const err = this.root.querySelector('#loginErr');
    this._onOK = async () => {
      const name = (ipt.value || '').trim();
      if (!name) { err.textContent = '请先输入用户名'; return; }
      try { this.onConfirm?.(name); } catch {}
    };
    ok?.addEventListener('click', this._onOK);
    ipt?.addEventListener('keydown', e => { if (e.key === 'Enter') this._onOK(); });
    ipt?.focus();
  }
  unmount() {
    const ok = this.root?.querySelector('#loginOK');
    if (ok && this._onOK) ok.removeEventListener('click', this._onOK);
    this._onOK = null;
    this.root = null;
  }
}

        return { ScreenManager, TabsView, ChatView, SpaceView, LoginView, Data, Extra };
      })();

      // ====================== QQ App（使用封包） ======================  
/**
 * 类：RMPhone.Apps.QQ（接入 RMPhone 的 QQ 应用）
 * 作用：把 RMQQ 的数据/视图挂到 RMPhone 的 App 壳中，处理首屏、路由与登录态
 *
 * 生命周期与路由：
 *   - mount(el):
 *       1) 读取登录态（优先 RMQQ.Data，其次 _data.qq）
 *       2) 若无登录 → push(LoginView)
 *          · onConfirm(name): Data.ensureAccount(name) → Data.commit() → 进入 Tabs
 *       3) 若有登录 → 直接 push(TabsView)
 *   - openChat(info): 使用 ScreenManager.push(new ChatView(info))
 *   - openSpace():   使用 ScreenManager.push(new SpaceView())
 *
 * 联动：
 *   - 使用 RMQQ.Data 作为数据来源与持久化触发器（Data.commit → RMPhoneToChatMessage）
 *   - 使用 RMQQ.ScreenManager 负责页面栈/动画；TabsView/ChatView 仅关心自身 UI
 *
 * 注意点：
 *   - 切换/删除账号时会根据回调 onLoginChanged 决定回到 Login 或重建 Tabs
 *   - 销毁前应调用 manager.destroy() 释放子视图与事件
 */

      RMPhone.Apps.QQ = class extends RMPhone.Apps.Base {
        constructor(el) {
          super(el);
          this._manager = null;
          this._login = null;
        }

        // 兼容性更强：尽量从 RMQQ.Data 拿；拿不到就从 _data.qq 兜底
        _detectLogin() {
          try {
            if (RMQQ?.Data?.getActiveLogin) return RMQQ.Data.getActiveLogin();
            if (RMQQ?.Data?.getDefaultLogin) return RMQQ.Data.getDefaultLogin();
            // 兜底：直接读 RMPhoneToChatMessage（你的数据桥）
            const qq = RMPhoneToChatMessage?.getApp?.('qq');
            return qq?.accounts?.[0]?.login || null;
          } catch {
            return null;
          }
        }

        mount(viewport) {
          super.mount(viewport);

          this.shadow.innerHTML = `
      <style>
        :host{ display:block; height:100%; }
        :host, :host * {
  font-family: var(--rmphone-font-family, Inter), system-ui, -apple-system, "Segoe UI", Arial;
  font-feature-settings: var(--rmphone-font-feature, "hwid");
}

        .qq-router{ position:absolute; inset:0; border-radius:inherit; overflow:hidden; background:transparent; }
        .qq-screen{
          position:absolute; inset:0; border-radius:inherit; overflow:hidden;
          transform:translate3d(0,0,0); opacity:1; will-change:transform,opacity; pointer-events:auto;
        }
        .qq-screen.hidden{ pointer-events:none; }
        .qq-anim{
          transition: transform .28s cubic-bezier(.4,0,.2,1), opacity .28s cubic-bezier(.4,0,.2,1);
        }
        .qq-enter-from{ transform:translate3d(100%,0,0); opacity:0.001; }
        .qq-enter-to  { transform:translate3d(0,0,0);    opacity:1; }
        .qq-leave-from{ transform:translate3d(0,0,0);    opacity:1; }
        .qq-leave-to  { transform:translate3d(100%,0,0); opacity:0.001; }
      </style>
      <div id="router" class="qq-router" aria-label="QQ Router"></div>
    `;

          const router = this.shadow.querySelector('#router');

          // 初始化数据（不再自动造 {{user}}）
RMQQ.Data.init?.();
RMQQ.Data.setPersistMode({ mode: 'immediate' });

// 屏幕管理器
this._manager = new RMQQ.ScreenManager(router);

// 先尝试从数据里探测已有登录
this._login = this._detectLogin();

// 依据“世界书 + _data”是否有登录来决定首屏
(async () => {
  let wbHasLogin = false;
  try {
    const wbQQ = await RMPhoneToWorldBook.getApp('qq').catch(() => ({}));
    wbHasLogin = !!Object.keys((wbQQ && wbQQ.login) || {}).length;
  } catch {}

  const dataHasLogin = !!this._login;

  if (!wbHasLogin && !dataHasLogin) {
    // 没有任何登录 → 先显示登录页
    const login = new RMQQ.LoginView({
      onConfirm: async (name) => {
        // 1) 在 _data 里创建账号
        RMQQ.Data.ensureAccount?.(name);
        await RMQQ.Data.commit?.();

        // 2) 切到 Tabs
        this._login = name;
        this._manager.destroy();
        const tabs = new RMQQ.TabsView({
          login: this._login,
          onOpenChat: info => this.openChat(info),
          onOpenSpace: (login) => this.openSpace(login),
          onLoginChanged: (login) => {
  this._login = login;
  if (!login) {
    // 没有任何账号了 → 直接切回登录页
    this._manager.destroy();
    const loginView = new RMQQ.LoginView({
      onConfirm: async (name) => {
        // 新账号写入数据，然后进 Tabs
        RMQQ.Data.ensureAccount?.(name);
        await RMQQ.Data.commit?.();
        this._login = name;
        this._manager.destroy();
        const tabs2 = new RMQQ.TabsView({
          login: this._login,
          onOpenChat: info => this.openChat(info),
          onOpenSpace: (login) => this.openSpace(login),
          onLoginChanged: (ln) => { this._login = ln; }, // 保持原样即可
        });
        this._manager.push(tabs2);
      }
    });
    this._manager.push(loginView);
  }
},

        });
        this._manager.push(tabs); // root，不右进
      }
    });
    this._manager.push(login);   // root，不右进
    return;
  }

  // 只有 WB 有账号、_data 没有 → 用 WB 的第一个账号
if (wbHasLogin && !dataHasLogin) {
  try {
    const wbQQ = await RMPhoneToWorldBook.getApp('qq').catch(() => ({}));
    this._login = Object.keys((wbQQ && wbQQ.login) || {})[0] || null;
  } catch {}
}

  // 已有登录 → 直接进 Tabs
  const tabs = new RMQQ.TabsView({
    login: this._login,
    onOpenChat: info => this.openChat(info),
    onOpenSpace: (login) => this.openSpace(login),
    onLoginChanged: (login) => {
  this._login = login;
  if (!login) {
    // 没有任何账号了 → 直接切回登录页
    this._manager.destroy();
    const loginView = new RMQQ.LoginView({
      onConfirm: async (name) => {
        // 新账号写入数据，然后进 Tabs
        RMQQ.Data.ensureAccount?.(name);
        await RMQQ.Data.commit?.();
        this._login = name;
        this._manager.destroy();
        const tabs2 = new RMQQ.TabsView({
          login: this._login,
          onOpenChat: info => this.openChat(info),
          onOpenSpace: (login) => this.openSpace(login),
          onLoginChanged: (ln) => { this._login = ln; }, // 保持原样即可
        });
        this._manager.push(tabs2);
      }
    });
    this._manager.push(loginView);
  }
},

  });
  this._manager.push(tabs);
})();

        }

        unmount() {
          try {
            this._manager?.destroy();
          } catch {}
          this._manager = null;
          super.unmount();
        }

        // 打开聊天：按 kind+peer 去重
        // 打开聊天：按 kind+peer 去重
        async openChat(info) {
          const payload = typeof info === 'string' ? { kind: 'dm', peer: info } : info || {};
          const kind = payload.kind === 'group' ? 'group' : 'dm';
          const peer = (payload.peer || '').trim();
          if (!peer) return;

          // 优先使用外部显式传入的 login
          this._login = payload.login || this._login || (RMQQ?.Data?.getDefaultLogin?.() ?? this._detectLogin());

          const idx = this._manager.findIndexReverse(
            it => it.screen?.key === 'chat' && it.screen.kind === kind && it.screen.peerName === peer,
          );
          const topIdx = this._manager.topIndex();

          if (idx === topIdx) {
            try {
              this._manager.top().screen.onShow?.();
            } catch {}
            return;
          }
          if (idx !== -1) {
            await this._manager.popTo(idx);
            try {
              this._manager.top().screen.onShow?.();
            } catch {}
            return;
          }

          const chat = new RMQQ.ChatView({
            login: this._login,
            kind,
            peerName: peer,
            onBack: () => this._manager.pop(),
          });
          this._manager.push(chat);
        }

        // 打开空间：只保留一个
        async openSpace(loginName) {
          if (loginName) this._login = loginName;
          const idx = this._manager.findIndexReverse(it => it.screen?.key === 'space');
          const topIdx = this._manager.topIndex();
          if (idx === topIdx) {
            try {
              this._manager.top().screen.onShow?.();
            } catch {}
            return;
          }
          if (idx !== -1) {
            await this._manager.popTo(idx);
            try {
              this._manager.top().screen.onShow?.();
            } catch {}
            return;
          }

          const space = new RMQQ.SpaceView({
            login: this._login,
            onBack: () => this._manager.pop(),
          });
          this._manager.push(space);
        }
      };

      RMPhone.Apps.YouTube = class extends RMPhone.Apps.Base {
        mount(viewport) {
          super.mount(viewport);
          this.shadow.innerHTML = `
        <style>
          :host{display:block;height:100%}
          .wrap{position:absolute; inset:0; background:#fff; color:#111; font:14px/1.4 system-ui; display:flex; align-items:center; justify-content:center}
          .close{ position:absolute; top:12px; right:12px; border:0; cursor:pointer; padding:.25rem .6rem; border-radius:.5rem; background:#f0f0f0; }
        </style>
        <div class="wrap">
          <button class="close">关闭</button>
          <div>YouTube（示例）</div>
        </div>`;
          this._onClose ??= () => RMPhone.toDesktop?.();
          this.shadow.querySelector('.close')?.addEventListener('click', this._onClose);
        }
        unmount() {
          const btn = this.shadow?.querySelector('.close');
          if (btn && this._onClose) {
            btn.removeEventListener('click', this._onClose);
          }
          this._onClose = null; // 推荐：把引用也置空
          super.unmount();
        }
      };

      RMPhone.Apps.Discord = class extends RMPhone.Apps.Base {
        mount(viewport) {
          super.mount(viewport);
          this.shadow.innerHTML = `
        <style>
          :host{display:block;height:100%}
          .wrap{position:absolute; inset:0; background:#fff; color:#111; font:14px/1.4 system-ui; display:flex; align-items:center; justify-content:center}
          .close{ position:absolute; top:12px; right:12px; border:0; cursor:pointer; padding:.25rem .6rem; border-radius:.5rem; background:#f0f0f0; }
        </style>
        <div class="wrap">
          <button class="close">关闭</button>
          <div>Discord（示例）</div>
        </div>`;
          this._onClose ??= () => RMPhone.toDesktop?.();
          this.shadow.querySelector('.close')?.addEventListener('click', this._onClose);
        }
        unmount() {
          const btn = this.shadow?.querySelector('.close');
          if (btn && this._onClose) {
            btn.removeEventListener('click', this._onClose);
          }
          this._onClose = null; // 推荐：把引用也置空
          super.unmount();
        }
      };

      /* 注册表 */
      RMPhone.Apps.registry = {
        settings: el => new RMPhone.Apps.Settings(el),
        qq: el => new RMPhone.Apps.QQ(el),
        youtube: el => new RMPhone.Apps.YouTube(el),
        discord: el => new RMPhone.Apps.Discord(el),
      };

    </script>

